<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pro Player Â· é”€å”®ç³»ç»Ÿ V4.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    // === Pro Player ç³»ç»Ÿé…ç½® ===
    const SUPABASE_URL = "https://ztesoqtztyheezualipa.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_xCKbicWQaYM1knmkOqH-QA_3l5Xr96T";

    if (typeof supabase === 'undefined') {
      alert("é”™è¯¯ï¼šSupabase SDK åŠ è½½å¤±è´¥");
    } else {
      window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
  </script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 500px; margin: auto; background: #f5f5f7; color: #333; }
    h2, h3 { color: #1d1d1f; margin-bottom: 15px; font-weight: 600; }
    .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .input-group { margin-bottom: 12px; }
    label { display: block; font-size: 13px; color: #666; margin-bottom: 4px; font-weight: 500; }
    input, textarea, select { width: 100%; padding: 10px; border: 1px solid #d2d2d7; border-radius: 8px; font-size: 16px; box-sizing: border-box; outline: none; transition: border-color 0.2s; }
    input:focus, textarea:focus { border-color: #007aff; }
    
    .row { display: flex; gap: 10px; }
    .col { flex: 1; }
    
    /* æ•°é‡é€‰æ‹©å™¨ä¼˜åŒ– */
    .qty-control { display: flex; align-items: center; justify-content: space-between; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #eee; }
    .qty-label { font-weight: bold; }
    
    button { width: 100%; padding: 14px; background: #000; color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    button:active { transform: scale(0.98); }
    
    #priceDisplay { background: #eefcf3; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 8px; text-align: center; margin: 15px 0; }
    #priceDisplay .total { font-size: 24px; font-weight: bold; }
    #priceDisplay .detail { font-size: 12px; opacity: 0.8; margin-top: 4px; }

    .hidden { display: none !important; }
    .error { color: #d70015; font-size: 13px; margin-top: 5px; }
    
    /* çº¢è‰²å¤‡æ³¨è¾“å…¥æ¡†æç¤º */
    #remarks { border: 1px dashed #ff3b30; background: #fff5f5; }
  </style>
</head>

<body>

<h2>Pro Player é”€å”®ç«¯</h2>

<div id="loginBox" class="card">
  <h3>å‘˜å·¥ç™»å½•</h3>
  <div class="input-group">
    <input id="email" type="email" placeholder="é‚®ç®±è´¦å·" />
  </div>
  <div class="input-group">
    <input id="password" type="password" placeholder="å¯†ç " />
  </div>
  <button id="loginBtn">ç™»å½•ç³»ç»Ÿ</button>
  <p id="loginMsg" class="error"></p>
</div>

<div id="appBox" class="hidden">
  <div class="card">
    <h3>ğŸ“ æ–°å»ºè®¢å•</h3>
    
    <div class="input-group">
      <label>æ”¶ä»¶äººå§“å</label>
      <input id="custName" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰" />
    </div>
    <div class="input-group">
      <label>è”ç³»ç”µè¯</label>
      <input id="custPhone" type="tel" placeholder="11ä½æ‰‹æœºå·" />
    </div>
    <div class="input-group">
      <label>æ”¶è´§åœ°å€ (æ–¹æ¡ˆA: ç²˜è´´å®Œæ•´åœ°å€)</label>
      <textarea id="custAddress" rows="3" placeholder="çœå¸‚åŒº+è¯¦ç»†åœ°å€ï¼Œä¾‹å¦‚ï¼šæµ™æ±Ÿçœæ­å·å¸‚è¥¿æ¹–åŒº..."></textarea>
    </div>

    <hr style="border:0; border-top:1px solid #eee; margin: 15px 0;">

    <label>äº§å“é€‰æ‹©</label>
    <div class="qty-control">
      <span class="qty-label">ğŸ…°ï¸ Aæ¬¾ (ç²—é¢)</span>
      <input type="number" id="qtyA" value="0" min="0" style="width: 80px; text-align:center;" onchange="calcPrice()" />
    </div>
    <div class="qty-control">
      <span class="qty-label">ğŸ…±ï¸ Bæ¬¾ (ç»†é¢)</span>
      <input type="number" id="qtyB" value="0" min="0" style="width: 80px; text-align:center;" onchange="calcPrice()" />
    </div>

    <div style="margin: 15px 0;">
      <label>è®¢å•ç±»å‹</label>
      <div class="row">
        <label class="col" style="background:#f0f0f0; padding:10px; border-radius:6px; text-align:center;">
          <input type="radio" name="orderType" value="retail" checked onchange="calcPrice()"> é›¶å”® (æ ‡å‡†)
        </label>
        <label class="col" style="background:#f0f0f0; padding:10px; border-radius:6px; text-align:center;">
          <input type="radio" name="orderType" value="internal" onchange="calcPrice()"> å†…éƒ¨ (å‘˜å·¥)
        </label>
      </div>
    </div>

    <div class="input-group">
      <label style="color:#ff3b30;">éå¸¸è§„å¤‡æ³¨ (çº¢è‰²é«˜äº®)</label>
      <input id="remarks" placeholder="å¦‚æœ‰ç‰¹æ®Šè¦æ±‚è¯·åœ¨æ­¤å¡«å†™..." />
    </div>

    <div id="priceDisplay">
      <div class="total">Â¥ <span id="finalPrice">0</span></div>
      <div class="detail" id="priceDetail">è¯·é€‰æ‹©å•†å“</div>
    </div>

    <button id="submitBtn">æäº¤è®¢å•</button>
  </div>

  <div class="card">
    <h3>ğŸ“¦ æˆ‘çš„ä»Šæ—¥æäº¤</h3>
    <ul id="todayList" style="padding-left:20px; font-size:14px; color:#555;"></ul>
  </div>

  <button onclick="logout()" style="background:#fff; color:#666; border:1px solid #ddd; margin-top:10px;">é€€å‡ºç™»å½•</button>
</div>

<script>
  let currentUser = null;

  // åˆå§‹åŒ–æ£€æŸ¥
  (async () => {
    if(!window.sb) return;
    const { data: { session } } = await window.sb.auth.getSession();
    if (session) {
      currentUser = session.user;
      showApp();
    }
  })();

  // ç»‘å®šäº‹ä»¶
  document.getElementById("loginBtn").onclick = login;
  document.getElementById("submitBtn").onclick = submitOrder;
  document.getElementById("qtyA").addEventListener('input', calcPrice);
  document.getElementById("qtyB").addEventListener('input', calcPrice);

  async function login() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    if(!email || !password) return alert("è¯·è¾“å…¥å®Œæ•´");
    
    const { data, error } = await window.sb.auth.signInWithPassword({ email, password });
    if(error) {
      document.getElementById("loginMsg").innerText = error.message;
    } else {
      currentUser = data.user;
      showApp();
    }
  }

  function showApp() {
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("appBox").classList.remove("hidden");
    loadMyTodayOrders();
  }

  // === æ ¸å¿ƒé€»è¾‘ï¼šè®¡ä»·å™¨ ===
  function calcPrice() {
    const qa = parseInt(document.getElementById("qtyA").value) || 0;
    const qb = parseInt(document.getElementById("qtyB").value) || 0;
    const type = document.querySelector('input[name="orderType"]:checked').value;
    const totalQty = qa + qb;

    let productTotal = 0;
    let shipping = 0;
    let note = "";

    if (totalQty === 0) {
      updateDisplay(0, "è¯·é€‰æ‹©æ•°é‡");
      return { total:0, shipping:0 };
    }

    if (type === 'retail') {
      // é›¶å”®é€»è¾‘
      if (totalQty === 1) {
        productTotal = 89;
        shipping = 6;
        note = "å•ä»¶é›¶å”® (89+6)";
      } else if (totalQty === 2) {
        productTotal = 160;
        shipping = 9;
        note = "ä¸¤ä»¶å¥—ä¼˜æƒ  (160+9)";
      } else {
        // è¶…è¿‡2ä»¶çš„é€»è¾‘ï¼Œæš‚æ—¶æŒ‰ä¸¤ä»¶å¥—å åŠ è®¡ç®—ï¼ˆæ ¹æ®éœ€æ±‚è¿™é‡Œä¸»è¦é’ˆå¯¹1å’Œ2ï¼Œè¿™é‡Œåšä¸ªç®€å•å…œåº•ï¼‰
        // å‡è®¾è§„åˆ™ï¼šæ¯2ä»¶160ï¼Œä½™1ä»¶89ã€‚è¿è´¹ç¨å¾®å¤æ‚ï¼Œè¿™é‡Œæš‚å®šæ¯åŠ 1ä»¶åŠ 3å…ƒè¿è´¹ï¼ˆç®€åŒ–é€»è¾‘ï¼‰
        // æˆ–è€…ç®€å•æç¤ºé”€å”®æ‰‹åŠ¨ç¡®è®¤ã€‚
        // ä¸ºäº†ä»£ç ç¨³å®šï¼Œè¿™é‡ŒæŒ‰: (æ•°é‡ * 89) è®¡ç®—æ ‡å‡†ä»·ï¼Œä¸è‡ªåŠ¨ç®—ä¼˜æƒ ï¼Œå»ºè®®äººå·¥æ‹†å•ï¼Ÿ
        // ä¸ï¼Œç”¨æˆ·è¯´â€œä¸¤å¼ å³ä¸º160â€ã€‚æˆ‘ä»¬æŒ‰å¯¹è®¡ç®—ã€‚
        const pairs = Math.floor(totalQty / 2);
        const remainder = totalQty % 2;
        productTotal = (pairs * 160) + (remainder * 89);
        // è¿è´¹é€»è¾‘ï¼š2ä»¶9å…ƒã€‚è¶…è¿‡2ä»¶æ¯ä»¶åŠ 3å…ƒï¼ˆå‡è®¾ï¼‰
        shipping = 9 + (totalQty - 2) * 3; 
        if(totalQty > 2) note = `å¤šä»¶ç»„åˆ (${totalQty}ä»¶)`;
      }
    } else {
      // å†…è´­é€»è¾‘
      productTotal = totalQty * 45;
      if (totalQty === 1) shipping = 6;
      else if (totalQty === 2) shipping = 9;
      else shipping = 9 + (totalQty - 2) * 3; // åŒæ ·å‡è®¾
      note = `å†…è´­ (${totalQty} Ã— 45)`;
    }

    const finalTotal = productTotal + shipping;
    updateDisplay(finalTotal, `${note} + è¿è´¹${shipping}å…ƒ`);
    return { total: finalTotal, shipping: shipping, productTotal: productTotal };
  }

  function updateDisplay(price, text) {
    document.getElementById("finalPrice").innerText = price;
    document.getElementById("priceDetail").innerText = text;
  }

  async function submitOrder() {
    const btn = document.getElementById("submitBtn");
    const name = document.getElementById("custName").value.trim();
    const phone = document.getElementById("custPhone").value.trim();
    const address = document.getElementById("custAddress").value.trim();
    const qa = parseInt(document.getElementById("qtyA").value) || 0;
    const qb = parseInt(document.getElementById("qtyB").value) || 0;
    const remarks = document.getElementById("remarks").value.trim();
    const type = document.querySelector('input[name="orderType"]:checked').value;

    if (!name || !phone || !address) return alert("è¯·å¡«å†™å®Œæ•´çš„å®¢æˆ·æ”¶è´§ä¿¡æ¯");
    if ((qa + qb) <= 0) return alert("è¯·é€‰æ‹©è‡³å°‘ä¸€ä»¶å•†å“");

    const priceData = calcPrice();

    btn.disabled = true;
    btn.innerText = "æäº¤ä¸­...";

    const { error } = await window.sb.from("orders").insert({
      account: currentUser.email,
      customer_name: name,
      phone: phone,
      address: address,
      qty_a: qa,
      qty_b: qb,
      total_qty: qa + qb,
      product: `Aæ¬¾:${qa}, Bæ¬¾:${qb}`, // ç®€æŠ¥
      order_type: type,
      total_price: priceData.total,
      shipping: priceData.shipping,
      remarks: remarks
    });

    if (error) {
      alert("æäº¤å¤±è´¥: " + error.message);
      btn.disabled = false;
      btn.innerText = "æäº¤è®¢å•";
      return;
    }

    alert("âœ… è®¢å•æäº¤æˆåŠŸï¼");
    location.reload(); // åˆ·æ–°é‡ç½®
  }

  async function loadMyTodayOrders() {
    const list = document.getElementById("todayList");
    // è·å–å½“å¤©çš„å¼€å§‹æ—¶é—´
    const today = new Date().toISOString().split('T')[0];
    
    const { data } = await window.sb
      .from("orders")
      .select("customer_name, total_qty, total_price")
      .eq("account", currentUser.email)
      .gte("created_at", today)
      .order("created_at", { ascending: false });

    if(data) {
      list.innerHTML = data.map(o => `<li>${o.customer_name} - ${o.total_qty}ä»¶ (Â¥${o.total_price})</li>`).join("");
    }
  }

  async function logout() {
    await window.sb.auth.signOut();
    location.reload();
  }
</script>

<footer style="margin-top:30px; text-align:center; font-size:12px; color:#aaa;">
  Pro Player Sales System V4.0<br>
  Â© Developed by Mars-è€åˆ˜ & AI
</footer>

</body>
</html>