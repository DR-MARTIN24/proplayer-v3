<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pro Player Â· é”€å”®ç³»ç»Ÿ V8.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js' defer></script>
  
  <script>
    const SUPABASE_URL = "https://ztesoqtztyheezualipa.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZXNvcXR6dHloZWV6dWFsaXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMjk0OTQsImV4cCI6MjA4MzkwNTQ5NH0.rRJIduqiWd37I3w0i-tyKn1skmehLKcX4AOYc-i2cbI";
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <style>
    body { font-family: -apple-system, sans-serif; padding: 15px; background: #f2f2f7; max-width: 500px; margin: auto; }
    .card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; display: block; }
    label { font-size: 12px; color: #666; font-weight: bold; margin-bottom: 5px; display: block; }
    
    .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: #fff; margin-bottom: 10px; }
    .btn-blue { background: #007aff; }
    .btn-gray { background: #e5e5ea; color: #333; }
    .btn-small { padding: 5px 10px; font-size: 12px; width: auto; float: right; }
    
    .row { display: flex; gap: 10px; align-items: center; }
    .col { flex: 1; }
    
    /* å¼¹çª— */
    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:99; align-items:center; justify-content:center; }
    .modal.show { display: flex; }
    .modal-box { background: #fff; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; }
    
    .hidden { display: none !important; }
  </style>
</head>

<body>
  <div class="card" style="text-align:center;">
    <h2>ğŸš€ Pro Player V8.2</h2>
    <div id="loginArea">
      <input id="email" placeholder="é‚®ç®±" />
      <input id="pass" type="password" placeholder="å¯†ç " />
      <button class="btn btn-blue" onclick="doLogin()">ç™»å½•</button>
    </div>
    <div id="welcomeArea" class="hidden">
      <p>æ¬¢è¿, <span id="userEmail"></span></p>
      <button class="btn btn-gray" style="background:#333; color:#fff" onclick="goAdmin()">ğŸ”§ è¿›å…¥æ€»æ§å°</button>
      <button class="btn btn-gray" onclick="location.reload()">é€€å‡º</button>
    </div>
  </div>

  <div id="mainArea" class="hidden">
    <button class="btn btn-gray" onclick="document.getElementById('ocrModal').classList.add('show')">ğŸ“· æ™ºèƒ½è¯†åˆ« (æˆªå›¾/ç²˜è´´)</button>

    <div class="card">
      <h3>ğŸ“ æ–°å»ºè®¢å•</h3>
      <label>å§“å</label><input id="cName" placeholder="å¿…å¡«">
      <label>ç”µè¯</label><input id="cPhone" type="tel" placeholder="å¿…å¡«">
      <label>åœ°å€</label><textarea id="cAddr" rows="2"></textarea>
      
      <div class="row" style="margin-bottom:10px;">
        <div class="col"><label>Aæ¬¾(ç²—)</label><input type="number" id="qA" value="0" oninput="calc()"></div>
        <div class="col"><label>Bæ¬¾(ç»†)</label><input type="number" id="qB" value="0" oninput="calc()"></div>
      </div>
      
      <label>ç±»å‹</label>
      <select id="oType" onchange="calc()">
        <option value="retail">é›¶å”®å®¢æˆ·</option>
        <option value="internal">å‘˜å·¥å†…è´­</option>
      </select>
      
      <label>å¤‡æ³¨</label><input id="rem">
      
      <div style="background:#eef; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px;">
        æ€»ä»·: <span style="font-weight:bold; color:#007aff; font-size:20px;">Â¥<span id="showPrice">0</span></span>
      </div>
      
      <button class="btn btn-blue" onclick="submitOrder()">æäº¤è®¢å•</button>
    </div>

    <div class="card">
      <h3>ğŸ“¦ ä»Šæ—¥å·²äº¤</h3>
      <div id="list"></div>
    </div>
  </div>

  <div id="ocrModal" class="modal">
    <div class="modal-box">
      <h3>æ™ºèƒ½è¯†åˆ«</h3>
      <textarea id="smartText" rows="5" placeholder="ç›´æ¥ç²˜è´´å¾®ä¿¡é‡Œçš„ï¼šå§“å ç”µè¯ åœ°å€..."></textarea>
      <input type="file" id="smartImg" accept="image/*">
      <div id="ocrLog" style="color:orange; font-size:12px;"></div>
      <div class="row">
        <button class="btn btn-gray col" onclick="document.getElementById('ocrModal').classList.remove('show')">å–æ¶ˆ</button>
        <button class="btn btn-blue col" onclick="runSmart()">è¯†åˆ«å¡«å……</button>
      </div>
    </div>
  </div>

<script>
  let ME = null;
  const ADMIN_MAIL = "169351@qq.com";

  // æ£€æŸ¥ç™»å½•
  window.onload = async () => {
    const {data:{session}} = await window.sb.auth.getSession();
    if(session) { ME=session.user; initApp(); }
  };

  async function doLogin() {
    const e = document.getElementById("email").value.trim();
    const p = document.getElementById("pass").value.trim();
    const {data, error} = await window.sb.auth.signInWithPassword({email:e, password:p});
    if(error) alert(error.message); else { ME=data.user; initApp(); }
  }

  function initApp() {
    document.getElementById("loginArea").classList.add("hidden");
    document.getElementById("welcomeArea").classList.remove("hidden");
    document.getElementById("mainArea").classList.remove("hidden");
    document.getElementById("userEmail").innerText = ME.email;
    loadList();
  }

  function goAdmin() {
    if(ME.email === ADMIN_MAIL) location.href = "admin.html";
    else alert("ä½ ä¸æ˜¯ç®¡ç†å‘˜");
  }

  // æ ¸å¿ƒè®¡ç®—
  function calc() {
    const a = Number(document.getElementById("qA").value)||0;
    const b = Number(document.getElementById("qB").value)||0;
    const type = document.getElementById("oType").value;
    const total = a+b;
    let price = 0;
    if(total > 0) {
      if(type === 'retail') price = total===1 ? 89+6 : (total*80 + 6 + (total-1)*3);
      else price = total*45 + 6 + Math.max(0, total-1)*3;
    }
    document.getElementById("showPrice").innerText = price;
    return price;
  }

  // æäº¤
  async function submitOrder() {
    const n = document.getElementById("cName").value;
    const p = document.getElementById("cPhone").value;
    const a = Number(document.getElementById("qA").value)||0;
    const b = Number(document.getElementById("qB").value)||0;
    if(!n || !p) return alert("å§“åç”µè¯å¿…å¡«");
    if(a+b <= 0) return alert("æ•°é‡ä¸èƒ½ä¸º0");

    let rem = document.getElementById("rem").value;
    const type = document.getElementById("oType").value;
    if(type === 'internal') rem = `[è€BABYå†…è´­] ${rem}`;

    const price = calc();
    
    const {error} = await window.sb.from("orders").insert({
      account: ME.email, customer_name: n, phone: p, address: document.getElementById("cAddr").value,
      qty_a: a, qty_b: b, total_qty: a+b, total_price: price, shipping: 0,
      product: `Aæ¬¾:${a}, Bæ¬¾:${b}`, order_type: type, remarks: rem, status: 'pending', item_category: 'æ—¥ç”¨å“'
    });

    if(error) alert("å¤±è´¥: "+error.message);
    else { alert("âœ… æäº¤æˆåŠŸ"); location.reload(); }
  }

  // åˆ—è¡¨åŠ è½½
  async function loadList() {
    const today = new Date().toISOString().split('T')[0];
    const {data} = await window.sb.from("orders").select("*").eq("account", ME.email).gte("created_at", today).order("created_at", {ascending:false});
    
    const div = document.getElementById("list");
    div.innerHTML = "";
    if(data) data.forEach(o => {
      div.innerHTML += `<div style="border-bottom:1px solid #eee; padding:10px;">
        <b>${o.customer_name}</b> <span style="float:right; color:#007aff">Â¥${o.total_price}</span><br>
        <span style="color:#666; font-size:12px;">${o.product}</span><br>
        <span style="font-size:12px; color:${o.tracking_number?'green':'orange'}">${o.tracking_number ? 'å·²å‘è´§: '+o.tracking_number : 'â³ å¾…å‘è´§'}</span>
      </div>`;
    });
  }

  // æ™ºèƒ½è¯†åˆ« (å³ä½¿ Tesseract æŒ‚äº†ä¹Ÿèƒ½è·‘æ–‡æœ¬æ­£åˆ™)
  async function runSmart() {
    let txt = document.getElementById("smartText").value;
    const file = document.getElementById("smartImg").files[0];
    
    if(file && typeof Tesseract !== 'undefined') {
      document.getElementById("ocrLog").innerText = "æ­£åœ¨æ‰«æå›¾ç‰‡...";
      try {
        const res = await Tesseract.recognize(file, 'chi_sim');
        txt += " " + res.data.text;
      } catch(e) { console.log(e); }
    }
    
    // æ­£åˆ™æå–
    const ph = txt.match(/1[3-9]\d{9}/)?.[0] || "";
    let clean = txt.replace(ph, "").replace(/ç”µè¯|æ‰‹æœº|æ”¶ä»¶äºº|åœ°å€|:|ï¼š/g, " ").replace(/\s+/g, " ").trim();
    // ç®€å•çŒœæµ‹ï¼šçŸ­çš„æ˜¯åå­—ï¼Œé•¿çš„æ˜¯åœ°å€
    let nm = "", ad = "";
    clean.split(" ").forEach(w => {
      if(!nm && w.length >= 2 && w.length <= 4) nm = w;
      else ad += w;
    });

    document.getElementById("cName").value = nm;
    document.getElementById("cPhone").value = ph;
    document.getElementById("cAddr").value = ad;
    document.getElementById("ocrModal").classList.remove("show");
    alert("å¡«å……å®Œæ¯•ï¼Œè¯·æ£€æŸ¥ï¼");
  }
</script>
</body>
</html>