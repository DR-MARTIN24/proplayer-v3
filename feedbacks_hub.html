<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pro Player Â· ç”¨æˆ·åé¦ˆä¸­å¿ƒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://ztesoqtztyheezualipa.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZXNvcXR6dHloZWV6dWFsaXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMjk0OTQsImV4cCI6MjA4MzkwNTQ5NH0.rRJIduqiWd37I3w0i-tyKn1skmehLKcX4AOYc-i2cbI";
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; padding: 20px; max-width: 600px; margin: auto; background: #f2f2f7; color: #333; padding-bottom: 60px; }
    
    .header { text-align: center; margin: 30px 0; }
    h2 { margin: 0; font-weight: 800; font-size: 24px; color: #1c1c1e; letter-spacing: -0.5px; }
    p { color: #8e8e93; font-size: 13px; margin-top: 6px; }

    .card { background: #fff; padding: 24px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 20px; }
    
    .input-group { margin-bottom: 20px; }
    label { display: block; font-size: 13px; color: #666; margin-bottom: 8px; font-weight: 700; }
    input, textarea, select { 
      width: 100%; padding: 12px; border: 1px solid #e5e5ea; border-radius: 10px; 
      font-size: 15px; box-sizing: border-box; background: #f9f9f9; -webkit-appearance: none; font-family: inherit;
    }
    input:focus, textarea:focus, select:focus { border-color: #007aff; background: #fff; outline: none; }

    /* === 1. ç¤¾äº¤å¹³å°å¤šè¡Œæ ·å¼ (å›å½’) === */
    .social-row { display: flex; gap: 8px; margin-bottom: 10px; }
    .social-select { flex: 1; }
    .social-input { flex: 2; }
    .btn-remove { width: 40px; background: #ff3b30; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    .btn-add { width: 100%; padding: 10px; border: 1px dashed #007aff; color: #007aff; background: #f0f7ff; border-radius: 10px; cursor: pointer; font-weight: 600; margin-top: 5px; }

    /* === 2. ä¼˜ç¼ºç‚¹å½©è‰²æ¡† (å›å½’) === */
    .pros-box { border: 2px solid #34c759; background: #f0f9f4; }
    .cons-box { border: 2px solid #ff9500; background: #fff8f0; }
    .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-bottom: 5px; }
    .badge-green { background: #34c759; color: #fff; }
    .badge-orange { background: #ff9500; color: #fff; }

    /* === 3. å¤šå›¾ä¸Šä¼ ä¹å®«æ ¼ (ä¿ç•™ V5 åŠŸèƒ½) === */
    .img-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    .img-item { position: relative; width: 100%; padding-bottom: 100%; border-radius: 8px; overflow: hidden; background: #eee; border: 1px solid #e5e5ea; }
    .img-item img { position: absolute; width: 100%; height: 100%; object-fit: cover; }
    .img-del { position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.6); color: #fff; width: 20px; height: 20px; border-radius: 50%; text-align: center; line-height: 18px; font-size: 14px; cursor: pointer; z-index: 2; }
    
    .upload-btn { 
      position: relative; width: 100%; padding-bottom: 100%; border-radius: 8px; 
      border: 2px dashed #007aff; background: #f0f7ff; cursor: pointer; display: flex; 
      align-items: center; justify-content: center; flex-direction: column;
    }
    .upload-btn::after { content: "+"; font-size: 30px; color: #007aff; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .upload-limit { font-size: 10px; color: #999; margin-top: 5px; text-align: right; }

    /* === 4. å®å¿ƒè“å‹¾é€‰æ¡† (å›å½’) === */
    .agreement { 
      display: flex; gap: 15px; align-items: flex-start; 
      background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 25px; 
      border: 1px solid #e5e5ea; cursor: pointer; transition: 0.2s;
    }
    .agreement:active { background: #f2f2f7; }

    /* éšè—åŸç”Ÿ checkbox */
    .agreement input[type="checkbox"] { 
      appearance: none; -webkit-appearance: none;
      width: 26px; height: 26px; flex-shrink: 0; margin-top: 2px;
      border: 2px solid #ccc; border-radius: 6px; background: #fff;
      display: flex; align-items: center; justify-content: center; transition: 0.2s;
    }
    
    /* é€‰ä¸­çŠ¶æ€ï¼šå®å¿ƒè“èƒŒæ™¯ + ç™½è‰²å¯¹å· */
    .agreement input[type="checkbox"]:checked {
      background-color: #007aff; border-color: #007aff;
    }
    .agreement input[type="checkbox"]:checked::after {
      content: 'âœ”'; font-size: 16px; color: #fff; font-weight: bold;
    }

    .agreement-text { font-size: 13px; color: #555; line-height: 1.6; text-align: justify; }
    .highlight { color: #007aff; font-weight: bold; }

    /* è¿›åº¦æ¡å¼¹çª— */
    .progress-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 999; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .progress-box { background: #fff; width: 80%; max-width: 320px; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    .progress-bar-bg { width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin: 20px 0; }
    .progress-bar-fill { height: 100%; background: #007aff; width: 0%; transition: width 0.3s ease; }
    .success-mark { font-size: 50px; display: none; margin-bottom: 10px; animation: popIn 0.5s; }
    @keyframes popIn { from{transform:scale(0);} to{transform:scale(1);} }

    .btn-submit { width: 100%; padding: 16px; background: #007aff; color: #fff; border: none; border-radius: 14px; font-size: 17px; font-weight: 700; cursor: pointer; transition: opacity 0.2s; box-shadow: 0 4px 12px rgba(0,122,255,0.3); }
    .btn-submit:disabled { background: #d1d1d6; cursor: not-allowed; box-shadow: none; opacity: 0.7; }

    .hidden { display: none; }
    .footer { text-align: center; font-size: 11px; color: #ccc; margin-top: 30px; }
  </style>
</head>
<body>

<div class="header">
  <h2>Pro Player ç”¨æˆ·åé¦ˆä¸­å¿ƒ</h2>
  <p>ä½¿ç”¨ç›¸åŒæ‰‹æœºå·æäº¤å¯è¦†ç›–æ›´æ–°èµ„æ–™</p>
</div>

<div id="successPage" class="card hidden" style="text-align:center; padding:50px 20px;">
  <div style="font-size:50px;">ğŸ‰</div>
  <h2 style="margin:15px 0;">æäº¤æˆåŠŸ</h2>
  <p>æ‚¨çš„åé¦ˆå·²ä¸Šä¼ è‡³äº‘ç«¯ã€‚<br>æ„Ÿè°¢æ‚¨å¯¹ Pro Player çš„æ”¯æŒï¼</p>
  <button onclick="location.reload()" style="margin-top:20px; background:#f2f2f7; color:#333; border:none; padding:10px 20px; border-radius:8px;">è¿”å›</button>
</div>

<div id="formPage" class="card">
  <!-- èº«ä»½ -->
  <div class="input-group">
    <label>ç™»å½•æ‰‹æœºå· (å”¯ä¸€èº«ä»½ID) <span style="color:red">*</span></label>
    <input type="tel" id="phone" maxlength="11" placeholder="11ä½æ‰‹æœºå·">
  </div>
  
  <div class="input-group">
    <label>æ‚¨çš„ç§°å‘¼ / ID <span style="color:red">*</span></label>
    <input type="text" id="userName" placeholder="ä¾‹å¦‚ï¼šAlex æˆ– å¾®ä¿¡æ˜µç§°">
  </div>

  <!-- 1. ç¤¾äº¤åª’ä½“å¤šè¡Œå½•å…¥ (å›å½’) -->
  <div class="input-group">
    <label>ç¤¾äº¤åª’ä½“å‘å¸ƒä¿¡æ¯ (æ”¯æŒæ·»åŠ å¤šä¸ª) <span style="color:red">*</span></label>
    <div id="socialList"></div>
    <button class="btn-add" onclick="addSocialRow()">+ æ·»åŠ ä¸€ä¸ªå¹³å°</button>
  </div>

  <!-- 2. å›¾ç‰‡ä¸Šä¼  (å¤šå›¾ V5) -->
  <div class="input-group">
    <label>å›¾ç‰‡ä¸Šä¼  (æœ€å¤š6å¼ ) <span style="color:red">*</span></label>
    <div class="img-grid" id="imgGrid">
      <div class="upload-btn" id="addBtn" onclick="document.getElementById('fileIn').click()"></div>
    </div>
    <div class="upload-limit" id="imgCount">0 / 6</div>
    <input type="file" id="fileIn" accept="image/*" multiple style="display:none" onchange="handleFiles(this)">
  </div>

  <!-- 3. åŸå§‹æ–‡æ¡ˆ -->
  <div class="input-group">
    <label>ğŸ“‹ ç¤¾äº¤åª’ä½“åŸå§‹æ–‡æ¡ˆ (æ¬è¿)</label>
    <textarea id="rawText" rows="3" placeholder="åœ¨æ­¤ç²˜è´´æ‚¨å‘å¸ƒçš„æœ‹å‹åœˆæ–‡æ¡ˆã€å°çº¢ä¹¦é•¿æ–‡ç­‰..."></textarea>
  </div>

  <!-- 4. ä¼˜ç¼ºç‚¹ (å›å½’) -->
  <div class="input-group">
    <div class="badge badge-green">ä¼˜ç‚¹ / çˆ½ç‚¹</div>
    <textarea id="pros" class="pros-box" rows="2" placeholder="è§‰å¾—å“ªé‡Œå¥½ï¼Ÿ(æ»‘åº¦ã€åšå·¥ã€åŒ…è£…ç­‰)"></textarea>
  </div>

  <div class="input-group">
    <div class="badge badge-orange">ç¼ºç‚¹ / å»ºè®®</div>
    <textarea id="cons" class="cons-box" rows="2" placeholder="å“ªé‡Œéœ€è¦æ”¹è¿›ï¼Ÿè¯·ç›´è¨€ä¸è®³"></textarea>
  </div>

  <!-- 5. åè®® (å›å½’å®å¿ƒè“) -->
  <div class="agreement" onclick="toggleCheck()">
    <input type="checkbox" id="agreeCheck" onclick="event.stopPropagation(); toggleBtn()">
    <div class="agreement-text">
      <strong>æˆæƒå£°æ˜ï¼š</strong><br>
      æˆ‘å·²çŸ¥æ™“å¹¶åŒæ„ï¼Œæäº¤å³ä»£è¡¨<span class="highlight">æˆæƒ Pro Player å“ç‰Œ</span>åœ¨å®˜æ–¹æ¸ é“ï¼ˆå®˜ç½‘ã€å…¬ä¼—å·ã€ç¤¾åª’ç­‰ï¼‰ä½¿ç”¨æˆ‘æäº¤çš„åé¦ˆå†…å®¹ï¼ˆæˆªå›¾ã€ç…§ç‰‡ã€è¯„ä»·ç­‰ï¼‰ç”¨äºå“ç‰Œå®£ä¼ ã€‚æˆ‘ä»¬æ‰¿è¯ºä»…å±•ç¤ºå†…å®¹ï¼Œä¸¥æ ¼ä¿æŠ¤æ‚¨çš„æ‰‹æœºå·ç­‰éšç§ä¿¡æ¯ã€‚
    </div>
  </div>

  <button id="submitBtn" class="btn-submit" disabled onclick="submitData()">ç¡®è®¤æäº¤</button>
</div>

<div class="footer">Pro Player System V6.0</div>

<!-- è¿›åº¦å¼¹çª— -->
<div id="progressModal" class="progress-modal">
  <div class="progress-box">
    <div id="loadingIcon" style="font-size:40px;">â³</div>
    <div id="successIcon" class="success-mark">âœ…</div>
    
    <h3 id="statusTitle" style="margin:15px 0 5px;">å‡†å¤‡ä¸Šä¼ ...</h3>
    <p id="statusDesc" style="color:#888; font-size:13px; margin:0;">æ­£åœ¨è¿æ¥æœåŠ¡å™¨</p>
    
    <div class="progress-bar-bg">
      <div id="progressBar" class="progress-bar-fill"></div>
    </div>
  </div>
</div>

<script>
  let selectedFiles = []; 
  const MAX_IMGS = 6;
  const platforms = ["æœ‹å‹åœˆ", "å°çº¢ä¹¦", "æŠ–éŸ³", "Bç«™", "å¾®åš", "å¿«æ‰‹", "å…¶ä»–"];

  // åˆå§‹åŒ–æ·»åŠ ä¸€è¡Œ
  addSocialRow();

  function addSocialRow() {
    const div = document.createElement('div');
    div.className = 'social-row';
    let opts = platforms.map(p => `<option value="${p}">${p}</option>`).join('');
    div.innerHTML = `
      <select class="social-select">${opts}</select>
      <input class="social-input" placeholder="å¡«å†™è´¦å·IDæˆ–é“¾æ¥">
      <button class="btn-remove" onclick="this.parentElement.remove()">Ã—</button>
    `;
    document.getElementById('socialList').appendChild(div);
  }

  function handleFiles(input) {
    const files = Array.from(input.files);
    if (!files.length) return;
    if (selectedFiles.length + files.length > MAX_IMGS) return alert(`æœ€å¤šåªèƒ½ä¸Šä¼  ${MAX_IMGS} å¼ `);

    files.forEach(f => {
      if (f.size > 20 * 1024 * 1024) alert(`å›¾ç‰‡ ${f.name} å¤ªå¤§`);
      else selectedFiles.push(f);
    });
    renderPreview();
    input.value = ""; 
  }

  function renderPreview() {
    const grid = document.getElementById('imgGrid');
    const addBtn = document.getElementById('addBtn');
    while (grid.children.length > 1) grid.removeChild(grid.firstChild);

    selectedFiles.forEach((f, idx) => {
      const div = document.createElement('div');
      div.className = 'img-item';
      div.innerHTML = `<img src="${URL.createObjectURL(f)}"><div class="img-del" onclick="removeImg(${idx})">Ã—</div>`;
      grid.insertBefore(div, addBtn);
    });
    document.getElementById('imgCount').innerText = `${selectedFiles.length} / ${MAX_IMGS}`;
    addBtn.style.display = selectedFiles.length >= MAX_IMGS ? 'none' : 'flex';
  }

  function removeImg(idx) { selectedFiles.splice(idx, 1); renderPreview(); }

  function toggleCheck() {
    const chk = document.getElementById('agreeCheck');
    chk.checked = !chk.checked;
    toggleBtn();
  }

  function toggleBtn() {
    setTimeout(() => {
      document.getElementById('submitBtn').disabled = !document.getElementById('agreeCheck').checked;
    }, 50);
  }

  async function submitData() {
    const phone = document.getElementById('phone').value.trim();
    const name = document.getElementById('userName').value.trim();
    const raw = document.getElementById('rawText').value.trim();
    const pros = document.getElementById('pros').value.trim();
    const cons = document.getElementById('cons').value.trim();

    if (phone.length !== 11) return alert("è¯·è¾“å…¥11ä½æ‰‹æœºå·");
    if (!name) return alert("è¯·å¡«å†™ç§°å‘¼");
    if (selectedFiles.length === 0) return alert("è¯·è‡³å°‘ä¸Šä¼ ä¸€å¼ å›¾ç‰‡");

    // æ”¶é›†ç¤¾äº¤å¹³å°
    const socialRows = document.querySelectorAll('.social-row');
    const socialData = [];
    socialRows.forEach(row => {
      const plat = row.querySelector('select').value;
      const val = row.querySelector('input').value.trim();
      if(val) socialData.push({ platform: plat, value: val });
    });
    if (socialData.length === 0) return alert("è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªç¤¾äº¤å¹³å°ä¿¡æ¯");

    // è¿›åº¦æ¡
    const modal = document.getElementById('progressModal');
    const bar = document.getElementById('progressBar');
    const title = document.getElementById('statusTitle');
    
    modal.style.display = "flex";
    
    try {
      const uploadedUrls = [];
      for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        const pct = Math.round(((i) / selectedFiles.length) * 80);
        bar.style.width = pct + "%";
        title.innerText = `æ­£åœ¨ä¸Šä¼ å›¾ç‰‡ (${i+1}/${selectedFiles.length})`;
        
        const ext = file.name.split('.').pop();
        const path = `${phone}_${Date.now()}_${i}.${ext}`;
        
        const { error: upErr } = await window.sb.storage.from('feedbacks').upload(path, file);
        if (upErr) throw upErr;
        const { data: { publicUrl } } = window.sb.storage.from('feedbacks').getPublicUrl(path);
        uploadedUrls.push(publicUrl);
      }

      bar.style.width = "90%";
      title.innerText = "æ­£åœ¨ä¿å­˜æ•°æ®...";
      
      const { error: dbErr } = await window.sb.from('feedbacks').upsert({
        phone: phone, user_name: name, social_data: socialData,
        raw_text: raw, pros: pros, cons: cons, images: uploadedUrls, consent: true
      }, { onConflict: 'phone' });

      if (dbErr) throw dbErr;

      bar.style.width = "100%"; bar.style.background = "#34c759";
      document.getElementById('loadingIcon').style.display = "none";
      document.getElementById('successIcon').style.display = "block";
      title.innerText = "æäº¤æˆåŠŸï¼";

      setTimeout(() => location.reload(), 2000);

    } catch (err) {
      alert("å‡ºé”™: " + err.message);
      modal.style.display = "none";
    }
  }
</script>
</body>
</html>