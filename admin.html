<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pro Player Â· æ€»æ§å° V8.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>

  <script>
    const SUPABASE_URL = "https://ztesoqtztyheezualipa.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZXNvcXR6dHloZWV6dWFsaXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMjk0OTQsImV4cCI6MjA4MzkwNTQ5NH0.rRJIduqiWd37I3w0i-tyKn1skmehLKcX4AOYc-i2cbI";
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f5f7fa; padding-bottom:100px; }
    
    /* é¡¶éƒ¨å¯¼èˆªæ  */
    .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
    .title-area { display: flex; flex-direction: column; }
    .clock { font-size: 14px; color: #007aff; font-weight: bold; margin-top: 5px; font-family: monospace; }
    
    /* ç»Ÿè®¡å¡ */
    .stats-box { display: flex; gap: 15px; margin-bottom: 20px; }
    .card { background: #fff; padding: 15px; border-radius: 8px; flex: 1; border-left: 4px solid #007aff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .num { font-size: 24px; font-weight: bold; margin-top: 5px; }

    /* å æ¯”æ¡ */
    .bar-box { background: #fff; padding: 10px; margin-bottom: 20px; border-radius: 8px; }
    .bar-track { display: flex; height: 24px; background: #eee; border-radius: 12px; overflow: hidden; margin-top: 5px; }
    .bar-part { display: flex; align-items: center; justify-content: center; color: #fff; font-size: 11px; font-weight: bold; transition: width 0.3s; }

    /* æŒ‰é’®ç»„ */
    .btn-group { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
    button { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; color: #fff; font-weight: bold; font-size: 13px; }
    .btn-blue { background: #007aff; }
    .btn-green { background: #34c759; }
    .btn-orange { background: #ff9500; }
    .btn-red { background: #ff3b30; }
    .btn-gray { background: #eee; color: #333; }

    /* è¡¨æ ¼ - å¼ºåˆ¶æ˜¾ç¤ºï¼Œå»é™¤éšè—å±æ€§ */
    .table-container { overflow-x: auto; background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); min-height: 200px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 900px; }
    th, td { padding: 12px 10px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
    th { background: #fafafa; white-space: nowrap; font-weight: 600; color: #555; }
    tr:hover { background: #f9f9f9; }
    
    .remark-cell { font-size: 12px; color: #666; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    
    /* å¼¹çª— */
    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index: 1000; }
    .modal.show { display: flex; }
    .modal-box { background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
    input, textarea, select { width: 100%; padding: 8px; margin: 5px 0 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    
    #loader { text-align: center; padding: 40px; color: #888; font-size: 16px; }
  </style>
</head>

<body>

<div class="header">
  <div class="title-area">
    <span style="font-size: 20px; font-weight: bold;">Pro Player æ€»æ§å° V8.1</span>
    <span id="clock" class="clock">ğŸ•’ æ­£åœ¨åŒæ­¥æ—¶é—´...</span>
  </div>
  <button class="btn-gray" onclick="location.href='sales.html'">è¿”å›é”€å”®ç«¯</button>
</div>

<div class="stats-box">
  <div class="card"><div>ä»Šæ—¥è®¢å•</div><div class="num" id="vOrder">0</div></div>
  <div class="card" style="border-color:#34c759"><div>ä»Šæ—¥è¥æ”¶</div><div class="num" id="vMoney">Â¥0</div></div>
  <div class="card" style="border-color:#ff9500"><div>å¾…å‘è´§</div><div class="num" id="vPending">0</div></div>
</div>

<div class="bar-box">
  <div style="font-size:12px; font-weight:bold;">
    <span style="color:#007aff">â— Aæ¬¾(ç²—)</span> <span style="color:#ff9500; margin-left:10px;">â— Bæ¬¾(ç»†)</span>
  </div>
  <div class="bar-track">
    <div id="barA" class="bar-part" style="background:#007aff; width:50%">A:0</div>
    <div id="barB" class="bar-part" style="background:#ff9500; width:50%">B:0</div>
  </div>
</div>

<div class="btn-group">
  <button class="btn-blue" onclick="exportCainiao()">ğŸ“¤ å¯¼å‡ºèœé¸Ÿ</button>
  <button class="btn-green" onclick="exportFinance()">ğŸ’° å¯¼å‡ºè´¢åŠ¡</button>
  <button class="btn-orange" onclick="openGift()">ğŸ å½•å…¥èµ é€</button>
  <button class="btn-red" onclick="delSel()">ğŸ—‘ åˆ é™¤é€‰ä¸­</button>
  <button class="btn-gray" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
  
  <input type="file" id="fileIn" accept=".xlsx" style="display:none" onchange="doImport(this)">
  <button class="btn-gray" style="margin-left:auto" onclick="document.getElementById('fileIn').click()">ğŸ“¥ å¯¼å…¥å›æ‰§</button>
</div>

<div class="table-container">
  <table id="mainTable">
    <thead>
      <tr>
        <th width="30"><input type="checkbox" onchange="checkAll(this)"></th>
        <th>ç¼–å·</th><th>ä¸‹å•æ—¶é—´</th><th>é”€å”®å‘˜</th><th>æ”¶ä»¶ä¿¡æ¯</th><th>äº§å“</th><th>A/Bæ˜ç»†</th><th>æ•°é‡</th><th>æ€»ä»·</th><th>çŠ¶æ€</th><th>å¤‡æ³¨</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="11" style="text-align:center; padding:20px;">æ•°æ®åŠ è½½ä¸­...</td></tr>
    </tbody>
  </table>
</div>

<div id="giftModal" class="modal">
  <div class="modal-box">
    <h3>ğŸ èµ é€å•</h3>
    <label>ç±»å‹</label><select id="gt"><option>æ´»åŠ¨èµ é€</option><option>é€‰æ‰‹æ¨å¹¿</option></select>
    <label>å§“å</label><input id="gn">
    <label>ç”µè¯</label><input id="gp">
    <label>åœ°å€</label><input id="ga">
    <div style="display:flex; gap:10px">
      <div style="flex:1"><label>Aæ¬¾æ•°</label><input type="number" id="gqa" value="0"></div>
      <div style="flex:1"><label>Bæ¬¾æ•°</label><input type="number" id="gqb" value="0"></div>
    </div>
    <label>å¤‡æ³¨</label><input id="gr">
    <div style="display:flex; gap:10px; margin-top:10px">
      <button class="btn-gray" style="flex:1" onclick="document.getElementById('giftModal').classList.remove('show')">å–æ¶ˆ</button>
      <button class="btn-orange" style="flex:1" onclick="submitGift()">ç¡®è®¤</button>
    </div>
  </div>
</div>

<script>
  let allData = [];

  // 1. å¯åŠ¨æ—¶é’Ÿ & åŠ è½½æ•°æ®
  window.onload = () => {
    setInterval(() => {
      const now = new Date();
      document.getElementById('clock').innerText = "ğŸ•’ " + now.toLocaleString();
    }, 1000);
    loadData();
  };

  // 2. æ•°æ®è¯»å– (ä¸è®¾é—¨æ§›)
  async function loadData() {
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;">æ­£åœ¨ä»æ•°æ®åº“æ‹‰å–æ•°æ®...</td></tr>`;

    // ç®€å•ç²—æš´ï¼Œè¯»å–æ‰€æœ‰
    const { data, error } = await window.sb.from("orders").select("*").order("created_at", {ascending:false});

    if (error) {
      alert("è¯»å–å¤±è´¥: " + error.message);
      tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; color:red;">è¯»å–å¤±è´¥: ${error.message}</td></tr>`;
      return;
    }

    if (!data || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;">æ•°æ®åº“é‡Œæ²¡æœ‰è®¢å• (0æ¡)</td></tr>`;
      return;
    }

    allData = data;
    renderTable(); // æ¸²æŸ“
    calcStats();   // ç»Ÿè®¡
  }

  // 3. å¼ºåŠ›æ¸²æŸ“ (é˜²æ­¢ä¸€è¡ŒæŠ¥é”™å¯¼è‡´å…¨è¡¨ä¸æ˜¾ç¤º)
  function renderTable() {
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = ""; // æ¸…ç©º

    allData.forEach(r => {
      try {
        const tr = document.createElement("tr");
        
        // å®‰å…¨è·å–å­—æ®µ (é˜²æ­¢ null æŠ¥é”™)
        const id = (r.id || "").toString().substring(0, 8);
        const time = r.created_at ? new Date(r.created_at).toLocaleString() : "-";
        const account = (r.account || "æœªçŸ¥").split("@")[0];
        const name = r.customer_name || "æ— å";
        const phone = r.phone || "";
        const qa = Number(r.qty_a) || 0;
        const qb = Number(r.qty_b) || 0;
        const total = Number(r.total_qty) || (qa + qb);
        const price = Number(r.total_price) || 0;
        let remarks = r.remarks || "";

        // çŠ¶æ€å¤„ç†
        const isShipped = !!r.tracking_number;
        const statusHtml = isShipped 
          ? `<span style="color:green; font-weight:bold;">å·²å‘è´§<br><a href="https://www.baidu.com/s?wd=${r.tracking_number}" target="_blank" style="color:green; font-size:12px;">${r.tracking_number}</a></span>`
          : `<span style="color:#ff9500;">å¾…å‘è´§</span>`;

        // å¤‡æ³¨é«˜äº®
        if (remarks.includes("å†…è´­") || remarks.includes("èµ é€")) {
          remarks = `<span style="color:green; font-weight:bold;">${remarks}</span>`;
        }

        // ä»·æ ¼æ ·å¼
        const priceHtml = (price === 0) 
          ? `<span style="color:#ff9500; font-weight:bold;">èµ é€</span>` 
          : `Â¥${price}`;

        tr.innerHTML = `
          <td><input type="checkbox" class="chk" value="${r.id}"></td>
          <td style="font-family:monospace; color:#666;">${id}</td>
          <td style="font-size:12px;">${time}</td>
          <td>${account}</td>
          <td>
            <div style="font-weight:bold;">${name}</div>
            <div style="font-size:12px; color:#666;">${phone}</div>
          </td>
          <td>ProPlayeré¼ æ ‡å«</td>
          <td style="font-size:12px; color:#666;">A:${qa} / B:${qb}</td>
          <td style="font-weight:bold; text-align:center;">${total}</td>
          <td style="color:#007aff;">${priceHtml}</td>
          <td>${statusHtml}</td>
          <td class="remark-cell" title="${r.remarks}">${remarks}</td>
        `;
        tbody.appendChild(tr);
      } catch (err) {
        console.error("æŸä¸€è¡Œæ¸²æŸ“å‡ºé”™ï¼Œå·²è·³è¿‡:", err);
      }
    });
  }

  // 4. ç»Ÿè®¡é€»è¾‘
  function calcStats() {
    const todayStr = new Date().toISOString().split("T")[0];
    let n=0, m=0, p=0, sa=0, sb=0;
    
    allData.forEach(r => {
      // å®¹é”™ç»Ÿè®¡
      if (r.created_at && r.created_at.includes(todayStr)) {
        n++;
        m += (Number(r.total_price) || 0);
      }
      if (!r.tracking_number) p++;
      sa += (Number(r.qty_a) || 0);
      sb += (Number(r.qty_b) || 0);
    });

    document.getElementById("vOrder").innerText = n;
    document.getElementById("vMoney").innerText = "Â¥" + m;
    document.getElementById("vPending").innerText = p;

    // å æ¯”æ¡
    const t = sa + sb;
    if (t > 0) {
      const pa = Math.round((sa / t) * 100);
      document.getElementById("barA").style.width = pa + "%";
      document.getElementById("barA").innerText = `A: ${pa}% (${sa})`;
      document.getElementById("barB").style.width = (100 - pa) + "%";
      document.getElementById("barB").innerText = `B: ${100 - pa}% (${sb})`;
    } else {
      document.getElementById("barA").innerText = "A: 0";
      document.getElementById("barB").innerText = "B: 0";
    }
  }

  // === åŠŸèƒ½åŒº ===
  function openGift() { document.getElementById('giftModal').classList.add('show'); }
  
  async function submitGift() {
    const n = document.getElementById('gn').value;
    const qa = Number(document.getElementById('gqa').value);
    const qb = Number(document.getElementById('gqb').value);
    
    if(!n || (qa+qb)<=0) return alert("è¯·å¡«å†™å§“åå’Œæ•°é‡");
    
    const { error } = await window.sb.from("orders").insert({
      account: "admin_gift",
      customer_name: n,
      phone: document.getElementById('gp').value,
      address: document.getElementById('ga').value,
      qty_a: qa, qty_b: qb, total_qty: qa+qb,
      product: `Aæ¬¾:${qa}, Bæ¬¾:${qb}`,
      total_price: 0, shipping: 0,
      status: "pending",
      remarks: `[${document.getElementById('gt').value}] ${document.getElementById('gr').value}`,
      item_category: "æ—¥ç”¨å“"
    });
    
    if(error) alert(error.message);
    else { alert("âœ… å½•å…¥æˆåŠŸ"); document.getElementById('giftModal').classList.remove('show'); loadData(); }
  }

  function checkAll(el) { document.querySelectorAll(".chk").forEach(c => c.checked = el.checked); }
  
  async function delSel() {
    const ids = Array.from(document.querySelectorAll(".chk:checked")).map(c => c.value);
    if(!ids.length) return alert("æ²¡é€‰æ€ä¹ˆåˆ ï¼Ÿ");
    if(confirm(`âš ï¸ ç¡®å®šåˆ é™¤è¿™ ${ids.length} æ¡æ•°æ®å—ï¼Ÿ`)) {
      await window.sb.from("orders").delete().in("id", ids);
      loadData();
    }
  }

  // === Excel å¯¼å‡º (ä¿ç•™å®Œç¾ç‰ˆ) ===
  function exportCainiao() {
    if(!allData.length) return alert("æ— æ•°æ®");
    const h = ["ç¼–å·\nï¼ˆå•æ¬¡æœ€å¤š5000åŒ…è£¹ï¼‰","æ”¶ä»¶äººå§“å","æ”¶ä»¶äººè”ç³»æ–¹å¼","æ”¶ä»¶åœ°å€","ç‰©å“ç±»ï¼ˆåœ¨ä»¥ä¸‹6ç±»ä¸­é€‰æ‹©ï¼šæ—¥ç”¨å“ã€é£Ÿå“ã€æ–‡ä»¶ã€è¡£ç‰©ã€æ•°ç äº§å“ã€å…¶ä»–ï¼‰","ç‰©å“æ•°é‡","ç‰©å“è¯¦æƒ…","å¤‡æ³¨ä¿¡æ¯","å¤–å¹³å°å•å·(æŠ–éŸ³å¿…å¡«)\n","ã€å›å¡«ã€‘è¿å•å· (ä¾›åº”é“¾å¡«è¿™é‡Œ)"];
    const d = [["","æ”¶ä»¶ä¿¡æ¯","","","ç‰©å“ä¿¡æ¯","","","å¤‡æ³¨","","å›å¡«åŒº"], h];
    
    allData.forEach(r => {
      let desc = "ProPlayeré¼ æ ‡å«";
      if(r.qty_a) desc += ` (Aæ¬¾ç²—*${r.qty_a})`;
      if(r.qty_b) desc += ` (Bæ¬¾ç»†*${r.qty_b})`;
      d.push([r.id, r.customer_name, r.phone, r.address, "æ—¥ç”¨å“", r.total_qty, desc, r.remarks||"", "", ""]);
    });

    if(typeof XLSX === 'undefined') return alert("Excel åº“åŠ è½½æ…¢ï¼Œè¯·ç¨åå†è¯•");
    const ws = XLSX.utils.aoa_to_sheet(d);
    
    // æ ·å¼
    ws['!cols'] = [{wch:30},{wch:10},{wch:15},{wch:40},{wch:10},{wch:8},{wch:30},{wch:20},{wch:15},{wch:25}];
    const range = XLSX.utils.decode_range(ws['!ref']);
    for(let R=0; R<=range.e.r; ++R) {
      for(let C=0; C<=range.e.c; ++C) {
        const cell = ws[XLSX.utils.encode_cell({r:R, c:C})];
        if(!cell) continue;
        cell.s = { border: { top:{style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} }, alignment: { vertical: "center", wrapText: true } };
        if(R<2) { cell.s.fill={fgColor:{rgb:"CCFFCC"}}; cell.s.font={bold:true}; }
        if(R>=2 && C===7) cell.s.font={color:{rgb:"FF0000"},bold:true};
        if(R>=2 && C===9) cell.s.fill={fgColor:{rgb:"FFFFCC"}};
      }
    }
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, "èœé¸Ÿå‘è´§å•.xlsx");
  }

  function exportFinance() {
    const body = [["æ—¶é—´","é”€å”®","å§“å","ç”µè¯","åœ°å€","Aæ¬¾","Bæ¬¾","æ€»æ•°","è¿è´¹","æ€»ä»·","çŠ¶æ€","å¤‡æ³¨","è¿å•"]];
    allData.forEach(r => body.push([new Date(r.created_at).toLocaleString(), r.account, r.customer_name, r.phone, r.address, r.qty_a, r.qty_b, r.total_qty, r.shipping, r.total_price, r.tracking_number?"å·²å‘è´§":"æœªå‘è´§", r.remarks, r.tracking_number]));
    const ws = XLSX.utils.aoa_to_sheet(body);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "è´¢åŠ¡");
    XLSX.writeFile(wb, "è´¢åŠ¡å•.xlsx");
  }

  async function doImport(el) {
    const f = el.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = async (e) => {
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {range:1});
      let n = 0;
      for(let row of rows) {
        let oid, track;
        for(let k in row) {
          if(k.includes("ç¼–å·")) oid = row[k];
          if(k.includes("å›å¡«") || k.includes("è¿å•")) track = row[k];
        }
        if(oid && track) {
          const {error} = await window.sb.from("orders").update({tracking_number:track, status:'shipped'}).eq("id",oid);
          if(!error) n++;
        }
      }
      alert(`âœ… æ›´æ–° ${n} æ¡`); el.value=""; loadData();
    };
    r.readAsArrayBuffer(f);
  }
</script>
</body>
</html>