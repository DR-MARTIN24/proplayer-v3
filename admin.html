<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pro Player Â· ç®¡ç†åå° V4.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>

  <script>
    const SUPABASE_URL = "https://ztesoqtztyheezualipa.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_xCKbicWQaYM1knmkOqH-QA_3l5Xr96T";
    if (typeof supabase !== 'undefined') {
      window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
  </script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 1000px; margin: auto; background: #f0f2f5; }
    
    /* é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ */
    .dashboard { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-card { flex: 1; min-width: 150px; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .stat-title { font-size: 12px; color: #888; text-transform: uppercase; }
    .stat-value { font-size: 24px; font-weight: 700; color: #333; margin-top: 5px; }

    /* è¡¨æ ¼æ ·å¼ */
    .table-container { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
    th { background: #f8f9fa; font-weight: 600; color: #555; }
    
    .remark-cell { color: #d70015; font-weight: 500; } /* ç½‘é¡µç«¯å¤‡æ³¨çº¢è‰²æ˜¾ç¤º */
    
    .btn-group { margin-bottom: 15px; display: flex; gap: 10px; }
    button { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: 0.2s; }
    .btn-primary { background: #007aff; color: white; }
    .btn-success { background: #34c759; color: white; }
    .btn-danger { background: #ff3b30; color: white; }
    button:hover { opacity: 0.9; }

    /* åŠ è½½åŠ¨ç”» */
    .loader { text-align: center; padding: 20px; color: #999; }
  </style>
</head>

<body>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
  <h2 style="margin:0;">Pro Player ç®¡ç†æ§åˆ¶å° V4.0</h2>
  <button class="btn-danger" onclick="logout()">é€€å‡ºç³»ç»Ÿ</button>
</div>

<div class="dashboard">
  <div class="stat-card">
    <div class="stat-title">ä»Šæ—¥è®¢å•æ•°</div>
    <div class="stat-value" id="statOrders">0</div>
  </div>
  <div class="stat-card">
    <div class="stat-title">ä»Šæ—¥é”€å”®é¢ (å…ƒ)</div>
    <div class="stat-value" id="statMoney">0.00</div>
  </div>
  <div class="stat-card">
    <div class="stat-title">ä»Šæ—¥å«å­æ€»æ•° (å¼ )</div>
    <div class="stat-value" id="statQty">0</div>
  </div>
</div>

<div class="table-container">
  <div class="btn-group">
    <button class="btn-primary" onclick="exportExcel('supply')">ğŸ“¤ å¯¼å‡ºä¾›åº”é“¾å‘è´§å• (V2)</button>
    <button class="btn-success" onclick="exportExcel('finance')">ğŸ’° å¯¼å‡ºå†…éƒ¨å¯¹è´¦å• (å«é‡‘é¢)</button>
    <button style="background:#eee; color:#333;" onclick="loadData()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
  </div>

  <div id="loader" class="loader">æ•°æ®åŠ è½½ä¸­...</div>

  <table id="dataTable" style="display:none;">
    <thead>
      <tr>
        <th width="15%">æ—¶é—´</th>
        <th width="10%">é”€å”®å‘˜</th>
        <th width="10%">æ”¶ä»¶äºº</th>
        <th width="20%">äº§å“è¯¦æƒ…</th>
        <th width="5%">æ€»æ•°</th>
        <th width="10%">ç±»å‹</th>
        <th width="10%">æ€»ä»·</th>
        <th width="20%">å¤‡æ³¨ (çº¢å­—)</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script>
  let allOrders = [];

  // åˆå§‹åŒ–
  (async () => {
    const { data: { user } } = await window.sb.auth.getUser();
    if (!user) {
      alert("è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·");
      location.href = "sales.html";
      return;
    }
    loadData();
  })();

  async function loadData() {
    document.getElementById("loader").style.display = "block";
    document.getElementById("dataTable").style.display = "none";

    // è·å–æ‰€æœ‰è®¢å•ï¼ŒæŒ‰æ—¶é—´å€’åº
    const { data, error } = await window.sb
      .from("orders")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) {
      alert("åŠ è½½å¤±è´¥: " + error.message);
      return;
    }
    
    allOrders = data;
    renderTable(data);
    calcStats(data);
    
    document.getElementById("loader").style.display = "none";
    document.getElementById("dataTable").style.display = "table";
  }

  function renderTable(data) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    
    data.forEach(row => {
      const date = new Date(row.created_at).toLocaleString('zh-CN', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${date}</td>
        <td>${row.account}</td>
        <td>${row.customer_name}<br><span style="font-size:12px;color:#999">${row.phone}</span></td>
        <td>A:${row.qty_a} / B:${row.qty_b}</td>
        <td style="font-weight:bold">${row.total_qty}</td>
        <td>${row.order_type === 'internal' ? '<span style="color:orange">å†…è´­</span>' : 'é›¶å”®'}</td>
        <td>Â¥${row.total_price}</td>
        <td class="remark-cell">${row.remarks || '-'}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function calcStats(data) {
    // ç®€å•è®¡ç®—ä»Šæ—¥æ•°æ®
    const todayStr = new Date().toISOString().split('T')[0];
    const todayOrders = data.filter(o => o.created_at.startsWith(todayStr));

    document.getElementById("statOrders").innerText = todayOrders.length;
    
    const totalMoney = todayOrders.reduce((sum, o) => sum + (o.total_price || 0), 0);
    document.getElementById("statMoney").innerText = totalMoney.toFixed(2);

    const totalQty = todayOrders.reduce((sum, o) => sum + (o.total_qty || 0), 0);
    document.getElementById("statQty").innerText = totalQty;
  }

  // === å¯¼å‡ºåŠŸèƒ½ (æ ¸å¿ƒ) ===
  function exportExcel(version) {
    if (allOrders.length === 0) return alert("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º");

    const isSupply = (version === 'supply');
    const wsData = [];

    // 1. æ„å»ºè¡¨å¤´
    if (isSupply) {
      // èœé¸Ÿæ¨¡æ¿æ ¼å¼
      wsData.push([
        "è®¢å•å·(è‡ªåŠ¨)", "æ”¶ä»¶äººå§“å", "æ‰‹æœº", "è¯¦ç»†åœ°å€", 
        "ç‰©å“åç§°", "æ•°é‡", "å¤‡æ³¨"
      ]);
    } else {
      // å†…éƒ¨è´¢åŠ¡æ ¼å¼
      wsData.push([
        "ä¸‹å•æ—¶é—´", "é”€å”®å‘˜", "ç±»å‹", "å§“å", "ç”µè¯", "åœ°å€", 
        "Aæ¬¾æ•°é‡", "Bæ¬¾æ•°é‡", "æ€»æ•°é‡", "è¿è´¹", "æ€»ä»·", "å¤‡æ³¨"
      ]);
    }

    // 2. å¡«å……æ•°æ®
    allOrders.forEach((o, index) => {
      const row = [];
      if (isSupply) {
        // ä¾›åº”é“¾ç‰ˆï¼šè„±æ•ï¼Œæ— ä»·æ ¼
        const orderNo = "PRO-" + new Date(o.created_at).getTime() + "-" + index;
        // ç‰©å“åç§°æ‹¼æ¥
        let goodsName = "é¼ æ ‡å«";
        if(o.qty_a > 0) goodsName += ` [Aæ¬¾ç²—x${o.qty_a}]`;
        if(o.qty_b > 0) goodsName += ` [Bæ¬¾ç»†x${o.qty_b}]`;
        
        row.push(
          orderNo, 
          o.customer_name, 
          o.phone, 
          o.address, 
          goodsName, 
          o.total_qty, // æŒ‰ç…§è¦æ±‚å¢åŠ çš„æ•°é‡ç»Ÿè®¡åˆ—
          o.remarks || ""
        );
      } else {
        // è´¢åŠ¡ç‰ˆ
        row.push(
          new Date(o.created_at).toLocaleString(),
          o.account,
          o.order_type,
          o.customer_name,
          o.phone,
          o.address,
          o.qty_a,
          o.qty_b,
          o.total_qty,
          o.shipping,
          o.total_price,
          o.remarks || ""
        );
      }
      wsData.push(row);
    });

    // 3. åˆ›å»º Worksheet
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // 4. è®¾ç½®æ ·å¼ (çº¢å­—å¤‡æ³¨)
    // éå†æ‰€æœ‰è¡Œï¼Œè®¾ç½®æœ€åä¸€åˆ—(å¤‡æ³¨)ä¸ºçº¢è‰²
    const range = XLSX.utils.decode_range(ws['!ref']);
    const remarkColIndex = isSupply ? 6 : 11; // å¤‡æ³¨æ‰€åœ¨çš„åˆ—ç´¢å¼•(ä»0å¼€å§‹)

    for (let R = 1; R <= range.e.r; ++R) { // è·³è¿‡è¡¨å¤´(R=0)
      const cellRef = XLSX.utils.encode_cell({r: R, c: remarkColIndex});
      if (!ws[cellRef]) continue; // å¦‚æœå•å…ƒæ ¼ä¸ºç©ºï¼Œè·³è¿‡

      // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºçº¢è‰²
      ws[cellRef].s = {
        font: { color: { rgb: "FF0000" }, bold: true }
      };
    }

    // 5. å¯¼å‡ºæ–‡ä»¶
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    
    const fileName = isSupply ? 
      `å‘è´§å•_ä¾›åº”é“¾ç‰ˆ_${new Date().toISOString().split('T')[0]}.xlsx` : 
      `é”€å”®ç»Ÿè®¡_å†…éƒ¨ç‰ˆ_${new Date().toISOString().split('T')[0]}.xlsx`;

    XLSX.writeFile(wb, fileName);
  }

  async function logout() {
    if(confirm("ç¡®å®šé€€å‡ºç®¡ç†åå°ï¼Ÿ")) {
      await window.sb.auth.signOut();
      location.href = "sales.html";
    }
  }
</script>

<footer style="margin-top:40px; text-align:center; font-size:12px; color:#999;">
  Pro Player Admin System V4.0<br>
  Â© Developed by Mars-è€åˆ˜ & AI
</footer>

</body>
</html>