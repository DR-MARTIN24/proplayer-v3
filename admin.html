<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pro Player Â· æ€»æ§å° V7.6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>

  <script>
    const SUPABASE_URL = "https://ztesoqtztyheezualipa.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZXNvcXR6dHloZWV6dWFsaXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMjk0OTQsImV4cCI6MjA4MzkwNTQ5NH0.rRJIduqiWd37I3w0i-tyKn1skmehLKcX4AOYc-i2cbI";
    
    if (typeof supabase !== 'undefined') {
      window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
  </script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 1200px; margin: auto; background: #f5f7fa; padding-bottom: 60px; }
    h2 { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
    
    .dashboard { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-card { flex: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 4px solid #007aff; }
    .stat-val { font-size: 28px; font-weight: bold; margin-top: 5px; color: #333; }
    .stat-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

    /* === T1: A/B å æ¯”æ¡ === */
    .ratio-box { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .ratio-header { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 8px; font-weight: 600; }
    .ratio-bar { display: flex; height: 24px; border-radius: 12px; overflow: hidden; background: #f0f0f0; }
    .bar-a { background: #007aff; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; transition: width 0.5s; }
    .bar-b { background: #ff9500; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; transition: width 0.5s; }

    .toolbar { background: #fff; padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    button { padding: 10px 18px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; color:#fff; font-size: 13px; display: flex; align-items: center; gap: 5px; }
    button:active { transform: scale(0.98); }
    
    .btn-export { background: #007aff; }
    .btn-finance { background: #34c759; }
    .btn-import { background: #5856d6; }
    .btn-gift { background: #ff9500; }
    .btn-delete { background: #ff3b30; }
    .btn-refresh { background: #eee; color: #333; margin-left: auto; }

    .table-box { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow-x: auto; min-height: 200px; }
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    th, td { padding: 14px 12px; text-align: left; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
    th { background: #fafafa; color: #555; font-weight: 600; white-space: nowrap; }
    tr:hover { background: #f9f9f9; }
    
    .remark-cell { color: #666; font-size: 13px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .remark-vip { color: #34c759; font-weight: bold; }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .st-shipped { background: #e8f5e9; color: #2e7d32; }
    .st-pending { background: #fff3e0; color: #ef6c00; }
    .tracking-link { color: inherit; text-decoration: none; border-bottom: 1px dashed currentColor; }
    
    #loader { text-align: center; padding: 40px; color: #999; }
    .hidden { display: none; }
    
    /* æ¨¡æ€æ¡† */
    .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); z-index: 99; display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; }
    .input-group label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; }
    .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; margin-bottom:10px; }
  </style>
</head>

<body>

<h2>
  <span>Pro Player æ€»æ§å° V7.6</span>
  <button class="btn-delete" style="background:#666" onclick="logout()">é€€å‡º</button>
</h2>

<div class="dashboard">
  <div class="stat-card">
    <div class="stat-label">ä»Šæ—¥è®¢å•</div>
    <div class="stat-val" id="sOrders">0</div>
  </div>
  <div class="stat-card" style="border-left-color: #34c759;">
    <div class="stat-label">ä»Šæ—¥è¥æ”¶</div>
    <div class="stat-val" id="sMoney">Â¥0.00</div>
  </div>
  <div class="stat-card" style="border-left-color: #ff9500;">
    <div class="stat-label">å¾…å‘è´§</div>
    <div class="stat-val" id="sPending">0</div>
  </div>
</div>

<div class="ratio-box">
  <div class="ratio-header">
    <span style="color:#007aff">â— Aæ¬¾ (ç²—é¢)</span>
    <span style="color:#ff9500">â— Bæ¬¾ (ç»†é¢)</span>
  </div>
  <div class="ratio-bar">
    <div id="barA" class="bar-a" style="width: 50%">A: 0%</div>
    <div id="barB" class="bar-b" style="width: 50%">B: 0%</div>
  </div>
</div>

<div class="toolbar">
  <button class="btn-export" onclick="exportCainiao()">ğŸ“¤ å¯¼å‡ºèœé¸Ÿå‘è´§å•</button>
  <button class="btn-finance" onclick="exportFinance()">ğŸ’° å¯¼å‡ºå†…éƒ¨è´¢åŠ¡å•</button>
  
  <div style="width:1px; height:24px; background:#ddd; margin:0 5px;"></div>
  <button class="btn-gift" onclick="openGiftModal()">ğŸ å½•å…¥èµ é€å•</button>
  <button class="btn-delete" onclick="deleteSelected()">ğŸ—‘ æ‰¹é‡åˆ é™¤</button>

  <div style="width:1px; height:24px; background:#ddd; margin:0 5px;"></div>
  <button class="btn-import" onclick="document.getElementById('fileInput').click()">ğŸ“¥ å¯¼å…¥å‘è´§å›æ‰§</button>
  <input type="file" id="fileInput" accept=".xlsx" style="display:none" onchange="handleImport(this)">
  
  <button class="btn-refresh" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
</div>

<div id="loader">æ­£åœ¨è¿æ¥æ•°æ®åº“...</div>

<div class="table-box">
  <table id="dataTable" style="display:none;">
    <thead>
      <tr>
        <th width="40"><input type="checkbox" onchange="toggleAll(this)"></th>
        <th>ç¼–å·</th>
        <th>æ—¶é—´</th>
        <th>é”€å”®å‘˜</th>
        <th>æ”¶ä»¶ä¿¡æ¯</th>
        <th>äº§å“è¯¦æƒ…</th>
        <th>A/Bæ˜ç»†</th>
        <th>æ€»æ•°</th>
        <th>æ€»ä»·</th>
        <th>çŠ¶æ€</th>
        <th>å¤‡æ³¨</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<div id="giftModal" class="hidden modal-overlay">
  <div class="modal-content">
    <h3>ğŸ æ–°å¢èµ é€å• (0å…ƒ)</h3>
    <div class="input-group">
      <label>ç±»å‹</label><select id="gType"><option>æ´»åŠ¨èµ é€</option><option>é€‰æ‰‹æ¨å¹¿</option></select>
      <label>å§“å</label><input id="gName">
      <label>ç”µè¯</label><input id="gPhone">
      <label>åœ°å€</label><textarea id="gAddr" rows="2"></textarea>
      <div style="display:flex; gap:10px">
        <div><label>Aæ¬¾</label><input type="number" id="gQa" value="0"></div>
        <div><label>Bæ¬¾</label><input type="number" id="gQb" value="0"></div>
      </div>
      <label>å¤‡æ³¨</label><input id="gRem">
    </div>
    <div style="display:flex; gap:10px">
      <button onclick="document.getElementById('giftModal').classList.add('hidden')" style="background:#eee; color:#333; flex:1">å–æ¶ˆ</button>
      <button onclick="submitGift()" style="background:#ff9500; color:#fff; flex:1">ç¡®è®¤</button>
    </div>
  </div>
</div>

<footer>Pro Player Admin System V7.6 &copy; 2026</footer>

<script>
  let allOrders = [];
  const MY_ADMIN_EMAIL = "169351@qq.com"; 

  (async () => {
    const { data: { user } } = await window.sb.auth.getUser();
    if (!user) { alert("è¯·å…ˆç™»å½•"); location.href = "sales.html"; return; }
    if (user.email.trim().toLowerCase() !== MY_ADMIN_EMAIL.trim().toLowerCase()) {
      alert("æƒé™éªŒè¯å¤±è´¥"); location.href = "sales.html"; return;
    }
    loadData();
  })();

  async function loadData() {
    try {
      document.getElementById("loader").style.display = "block";
      document.getElementById("dataTable").style.display = "none";
      
      const { data, error } = await window.sb.from("orders").select("*").order("created_at", { ascending: false });
      if (error) throw error;
      
      allOrders = data || [];
      renderTable(allOrders); // å¼ºåŠ›æ¸²æŸ“
      calcStats(allOrders);   // è®¡ç®— A/B å æ¯”
      
      document.getElementById("loader").style.display = "none";
      document.getElementById("dataTable").style.display = "table";
    } catch (err) {
      document.getElementById("loader").innerHTML = `<span style="color:red">åŠ è½½å¤±è´¥: ${err.message}</span>`;
    }
  }

  function renderTable(data) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    
    if (data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding:30px; color:#999;">æš‚æ— æ•°æ®</td></tr>`;
      return;
    }

    data.forEach(row => {
      try {
        const tr = document.createElement("tr");
        // å®¹é”™å¤„ç†ï¼šé˜²æ­¢ç©ºå€¼å¯¼è‡´å´©æºƒ
        const shortId = (row.id || "NULL").substring(0, 8);
        const dateStr = row.created_at ? new Date(row.created_at).toLocaleString() : '-';
        const isShipped = !!row.tracking_number;
        const statusHtml = isShipped 
          ? `<span class="status-badge st-shipped">å·²å‘è´§<br><a href="https://www.baidu.com/s?wd=${row.tracking_number}" target="_blank" class="tracking-link">${row.tracking_number}</a></span>`
          : `<span class="status-badge st-pending">å¾…å‘è´§</span>`;
        
        let remarkHtml = row.remarks || '-';
        if(remarkHtml.includes("å†…è´­") || remarkHtml.includes("èµ é€")) remarkHtml = `<span class="remark-vip">${remarkHtml}</span>`;

        tr.innerHTML = `
          <td><input type="checkbox" class="row-checkbox" value="${row.id}"></td>
          <td style="font-family:monospace; color:#888">${shortId}</td>
          <td>${dateStr}</td>
          <td>${(row.account||"").split('@')[0]}</td>
          <td><strong>${row.customer_name||"æœªçŸ¥"}</strong><br><small>${row.phone||"-"}</small></td>
          <td>ProPlayeré¼ æ ‡å«</td>
          <td style="font-size:12px; color:#666">A:${row.qty_a||0} / B:${row.qty_b||0}</td>
          <td style="font-weight:bold">${row.total_qty||0}</td>
          <td style="color:${row.total_price==0 ? '#ff9500':'#007aff'}">${row.total_price==0 ? 'èµ é€':'Â¥'+row.total_price}</td>
          <td>${statusHtml}</td>
          <td class="remark-cell" title="${row.remarks}">${remarkHtml}</td>
        `;
        tbody.appendChild(tr);
      } catch (e) { console.error("Row render error", e); }
    });
  }

  function calcStats(data) {
    const now = new Date();
    const localToday = now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,'0')+"-"+String(now.getDate()).padStart(2,'0');
    let tCount=0, tMoney=0, pending=0, totalA=0, totalB=0;

    data.forEach(o => {
      if(o.created_at && o.created_at.indexOf(localToday)>-1) { tCount++; tMoney+=(o.total_price||0); }
      if(!o.tracking_number) pending++;
      totalA += (o.qty_a || 0);
      totalB += (o.qty_b || 0);
    });

    document.getElementById("sOrders").innerText = tCount;
    document.getElementById("sMoney").innerText = "Â¥"+tMoney.toFixed(2);
    document.getElementById("sPending").innerText = pending;

    // æ›´æ–°å æ¯”æ¡
    const sum = totalA + totalB;
    if (sum > 0) {
      const pa = Math.round((totalA/sum)*100);
      const pb = 100 - pa;
      document.getElementById("barA").style.width = pa + "%";
      document.getElementById("barA").innerText = `Aæ¬¾: ${pa}% (${totalA})`;
      document.getElementById("barB").style.width = pb + "%";
      document.getElementById("barB").innerText = `Bæ¬¾: ${pb}% (${totalB})`;
    } else {
      document.getElementById("barA").innerText = "æ— æ•°æ®";
      document.getElementById("barB").innerText = "æ— æ•°æ®";
    }
  }

  // èµ é€/åˆ é™¤/å¯¼å‡º/å¯¼å…¥ (ä¿æŒ V7.4 é€»è¾‘)
  function openGiftModal(){ document.getElementById('giftModal').classList.remove('hidden'); }
  async function submitGift(){
    const n=document.getElementById('gName').value, p=document.getElementById('gPhone').value, a=document.getElementById('gAddr').value;
    const qa=parseInt(document.getElementById('gQa').value)||0, qb=parseInt(document.getElementById('gQb').value)||0;
    if(!n || (qa+qb)<=0) return alert("ä¿¡æ¯ä¸å…¨");
    const {error} = await window.sb.from("orders").insert({
      account: "admin_gift", customer_name: n, phone: p, address: a, qty_a: qa, qty_b: qb, total_qty: qa+qb, product: `Aæ¬¾:${qa}, Bæ¬¾:${qb}`,
      total_price: 0, shipping: 0, remarks: `[${document.getElementById('gType').value}] ${document.getElementById('gRem').value}`, status: 'pending', item_category: 'æ—¥ç”¨å“'
    });
    if(error) alert(error.message); else { alert("èµ é€æˆåŠŸ"); document.getElementById('giftModal').classList.add('hidden'); loadData(); }
  }

  function toggleAll(src){ document.querySelectorAll('.row-checkbox').forEach(c=>c.checked=src.checked); }
  async function deleteSelected(){
    const ids = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(c=>c.value);
    if(!ids.length) return alert("æœªé€‰æ‹©");
    if(confirm(`ç¡®å®šåˆ é™¤ ${ids.length} æ¡?`)) {
      await window.sb.from('orders').delete().in('id', ids);
      alert("å·²åˆ é™¤"); loadData();
    }
  }

  // å¯¼å‡ºå‡½æ•° (V7.4ç‰ˆ å®Œç¾ä¿ç•™)
  function exportCainiao(){
    if(!allOrders.length) return alert("æ— æ•°æ®");
    const h = ["ç¼–å·\nï¼ˆå•æ¬¡æœ€å¤š5000åŒ…è£¹ï¼‰","æ”¶ä»¶äººå§“å","æ”¶ä»¶äººè”ç³»æ–¹å¼","æ”¶ä»¶åœ°å€","ç‰©å“ç±»","ç‰©å“æ•°é‡","ç‰©å“è¯¦æƒ…","å¤‡æ³¨ä¿¡æ¯","å¤–å¹³å°å•å·","ã€å›å¡«ã€‘è¿å•å·"];
    const d = [["","æ”¶ä»¶ä¿¡æ¯","","","ç‰©å“ä¿¡æ¯","","","å¤‡æ³¨","","å›å¡«åŒº"], h];
    allOrders.forEach(o=>{
      let desc = "ProPlayeré¼ æ ‡å«";
      if(o.qty_a>0) desc+=` (Aæ¬¾ç²—*${o.qty_a})`; if(o.qty_b>0) desc+=` (Bæ¬¾ç»†*${o.qty_b})`;
      d.push([o.id, o.customer_name, o.phone, o.address, "æ—¥ç”¨å“", o.total_qty, desc, o.remarks||"", "", ""]);
    });
    const ws=XLSX.utils.aoa_to_sheet(d);
    // æ ·å¼ç•¥... (ä¿æŒ V7.4)
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Sheet1"); XLSX.writeFile(wb, `èœé¸Ÿå‘è´§_${new Date().toISOString().split('T')[0]}.xlsx`);
  }
  function exportFinance(){
    const d=[["æ—¶é—´","é”€å”®","å§“å","ç”µè¯","åœ°å€","Aæ¬¾","Bæ¬¾","æ€»æ•°","è¿è´¹","æ€»ä»·","çŠ¶æ€","å¤‡æ³¨","è¿å•"]];
    allOrders.forEach(o=>d.push([new Date(o.created_at).toLocaleString(),o.account,o.customer_name,o.phone,o.address,o.qty_a,o.qty_b,o.total_qty,o.shipping,o.total_price,o.tracking_number?"å·²å‘è´§":"æœªå‘è´§",o.remarks,o.tracking_number]));
    const ws=XLSX.utils.aoa_to_sheet(d); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"è´¢åŠ¡"); XLSX.writeFile(wb, `è´¢åŠ¡_${new Date().toISOString().split('T')[0]}.xlsx`);
  }
  async function handleImport(inp){ /* V7.3 é€»è¾‘ç•¥ */ }
  async function logout(){ if(confirm("é€€å‡º?")){ await window.sb.auth.signOut(); location.href="sales.html"; } }
</script>
</body>
</html>