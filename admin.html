<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pro Player Â· æ€»æ§ V9.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js' defer></script>

  <script>
    const SUPABASE_URL = "https://ztesoqtztyheezualipa.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZXNvcXR6dHloZWV6dWFsaXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMjk0OTQsImV4cCI6MjA4MzkwNTQ5NH0.rRJIduqiWd37I3w0i-tyKn1skmehLKcX4AOYc-i2cbI";
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <style>
    /* ç»Ÿä¸€å­—ä½“ï¼Œæœç»å®‹ä½“ */
    body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Roboto, sans-serif; padding: 20px; background: #f5f7fa; padding-bottom:100px; }
    
    .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
    .clock { font-size: 14px; color: #007aff; font-weight: bold; margin-top: 5px; font-family: monospace; }
    .version-tag { font-size: 12px; color: #999; margin-left: 5px; font-weight: 400; }
    
    .stats-box { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
    .card { background: #fff; padding: 15px; border-radius: 12px; flex: 1; min-width: 120px; border-left: 4px solid #007aff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .num { font-size: 24px; font-weight: 800; margin-top: 5px; }
    .label { font-size: 12px; color: #888; font-weight: 600; }

    .bar-box { background: #fff; padding: 10px; margin-bottom: 20px; border-radius: 12px; }
    .bar-track { display: flex; height: 24px; background: #eee; border-radius: 12px; overflow: hidden; margin-top: 5px; }
    .bar-part { display: flex; align-items: center; justify-content: center; color: #fff; font-size: 11px; font-weight: bold; transition: width 0.5s; }

    .btn-group { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
    button { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; color: #fff; font-weight: bold; font-size: 13px; font-family: inherit; transition: opacity 0.2s; }
    button:active { transform: scale(0.98); }
    button:disabled { opacity: 0.5; cursor: not-allowed; background: #ccc !important; }
    
    .btn-b { background: #007aff; } .btn-g { background: #34c759; } .btn-o { background: #ff9500; } .btn-r { background: #ff3b30; } .btn-gy { background: #666; } .btn-bk { background: #000; }

    .table-container { overflow-x: auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); min-height: 200px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 1000px; }
    th, td { padding: 12px 10px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
    th { background: #fafafa; white-space: nowrap; font-weight: 600; color: #555; }
    tr:hover { filter: brightness(0.98); }
    
    tr.gift-row { background: #fff3e0; } 
    tr.internal-row { background: #efebe9; }
    
    .seq-id { font-family: monospace; font-weight: bold; background: #eee; padding: 2px 6px; border-radius: 4px; }
    
    /* å¼¹çª— */
    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index: 2000; }
    .modal.show { display: flex; }
    .modal-box { background: #fff; padding: 24px; border-radius: 16px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    input, textarea, select { font-family: inherit; width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    
    .edit-btn { background: #eee; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 5px; }
    
    footer { text-align: center; font-size: 11px; color: #aaa; margin-top: 30px; line-height: 1.6; }
  </style>
</head>

<body>

<div class="header">
  <div>
    <span style="font-size: 20px; font-weight: 800;">Pro Player é¼ æ ‡å«é”€å”®ç»Ÿè®¡ç³»ç»Ÿ <span class="version-tag">V9.2</span></span>
    <span id="clock" class="clock">ğŸ•’ æ ¡éªŒèº«ä»½...</span>
  </div>
  <button class="btn-gy" onclick="location.href='sales.html'">è¿”å›é”€å”®</button>
</div>

<div class="stats-box">
  <div class="card"><div class="label">ä»Šæ—¥è®¢å• (å•)</div><div class="num" id="sToday">0</div></div>
  <div class="card" style="border-color:#34c759"><div class="label">ä»Šæ—¥è¥æ”¶ (å…ƒ)</div><div class="num" id="sMoney">0</div></div>
  <div class="card" style="border-color:#000"><div class="label">ç´¯è®¡è®¢å• (å•)</div><div class="num" id="sTotal">0</div></div>
  <div class="card" style="border-color:#666"><div class="label">ç´¯è®¡æ•°é‡ (å¼ )</div><div class="num" id="sSheets">0</div></div>
  <div class="card" style="border-color:#ff9500"><div class="label">å¾…å‘è´§ (å•)</div><div class="num" id="sPending">0</div></div>
  <div class="card" style="border-color:green"><div class="label">å·²å‘è´§ (å•)</div><div class="num" id="sShipped">0</div></div>
</div>

<div class="bar-box">
  <div style="font-size:12px; font-weight:bold;">å†å²å…¨é‡å æ¯” (Aæ¬¾ vs Bæ¬¾)</div>
  <div class="bar-track">
    <div id="barA" class="bar-part" style="background:#007aff; width:50%">A:0</div>
    <div id="barB" class="bar-part" style="background:#ff9500; width:50%">B:0</div>
  </div>
</div>

<div class="btn-group">
  <button class="btn-b" onclick="expCainiao()">ğŸ“¤ å¯¼å‡ºèœé¸Ÿ (å¢é‡)</button>
  <button class="btn-g" onclick="expFin()">ğŸ’° å¯¼å‡ºè´¢åŠ¡</button>
  <button class="btn-o" onclick="openGift()">ğŸ å½•å…¥èµ é€</button>
  <button class="btn-bk" onclick="backupData()">ğŸ’¾ æ•°æ®å¤‡ä»½</button>
  <button class="btn-r" onclick="delSel()">ğŸ—‘ åˆ é™¤</button>
  <button class="btn-gy" onclick="loadData()">ğŸ”„ åˆ·æ–° (æ¯300sè‡ªåŠ¨)</button>
  
  <input type="file" id="fIn" style="display:none" onchange="imp(this)">
  <button class="btn-gy" style="margin-left:auto" onclick="document.getElementById('fIn').click()">ğŸ“¥ å¯¼å…¥å›æ‰§</button>
</div>

<div class="table-container">
  <table id="mainTable">
    <thead>
      <tr>
        <th width="30"><input type="checkbox" onchange="checkAll(this)"></th>
        <th>No.</th><th>æ—¶é—´</th><th>é”€å”®</th><th>æ”¶ä»¶ä¿¡æ¯</th><th>äº§å“</th><th>A/B</th><th>æ•°</th><th>ä»·</th><th>çŠ¶æ€</th><th>å¤‡æ³¨</th><th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<footer>
  Pro Player System V9.2 (Security Enhanced)<br>
  åˆ¶ä½œäººï¼šMars-è€åˆ˜ & AI
</footer>

<div id="editModal" class="modal">
  <div class="modal-box">
    <h3>âœï¸ ä¿®æ”¹è®¢å•</h3>
    <input type="hidden" id="eId">
    <label>å§“å</label><input id="eName">
    <label>ç”µè¯</label><input id="ePhone">
    <label>åœ°å€</label><textarea id="eAddr" rows="2"></textarea>
    <label>è¿å•å· (å¯æ‰‹åŠ¨ä¿®æ­£)</label><input id="eTrack">
    <div style="display:flex; gap:10px"><div style="flex:1"><label>Aæ¬¾</label><input type="number" id="eQa"></div><div style="flex:1"><label>Bæ¬¾</label><input type="number" id="eQb"></div></div>
    <label>å¤‡æ³¨</label><input id="eRem">
    <div style="display:flex; gap:10px">
      <button class="btn-gy" style="flex:1" onclick="document.getElementById('editModal').classList.remove('show')">å–æ¶ˆ</button>
      <button class="btn-b" style="flex:1" onclick="saveEdit()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div id="giftModal" class="modal">
  <div class="modal-box">
    <h3>ğŸ èµ é€å•</h3>
    <button onclick="openOcr()" style="width:100%;margin-bottom:10px;background:#eee;border:none;padding:8px;border-radius:6px;">ğŸ“· æ™ºèƒ½è¯†åˆ«</button>
    <label>ç±»å‹</label><select id="gt"><option>æ´»åŠ¨èµ é€</option><option>é€‰æ‰‹æ¨å¹¿</option></select>
    <label>å§“å</label><input id="gn">
    <label>ç”µè¯</label><input id="gp">
    <label>åœ°å€</label><input id="ga">
    <div style="display:flex; gap:10px"><div style="flex:1"><label>Aæ¬¾</label><input type="number" id="gqa" value="0"></div><div style="flex:1"><label>Bæ¬¾</label><input type="number" id="gqb" value="0"></div></div>
    <label>å¤‡æ³¨</label><input id="gr">
    <div style="display:flex; gap:10px">
      <button class="btn-gy" style="flex:1" onclick="document.getElementById('giftModal').classList.remove('show')">å–æ¶ˆ</button>
      <button id="giftBtn" class="btn-o" style="flex:1" onclick="subGift()">ç¡®è®¤</button>
    </div>
  </div>
</div>

<div id="ocrBox" class="modal">
  <div class="modal-box">
    <h3>æ™ºèƒ½å¡«å……</h3>
    <textarea id="ocrText" rows="5" placeholder="ç²˜è´´æ•´æ®µåœ°å€..."></textarea>
    <button class="btn-b" onclick="runOcr()" style="width:100%">è¯†åˆ«å¡«å……</button>
    <button class="btn-gy" onclick="document.getElementById('ocrBox').classList.remove('show')" style="width:100%;margin-top:5px">å…³é—­</button>
  </div>
</div>

<script>
  let DB = [];
  const IS_MOBILE = window.innerWidth < 768;

  // ğŸ”’ æ ¸å¿ƒé€»è¾‘ï¼šå®‰å…¨å¯åŠ¨
  window.onload = async () => {
    // å¯åŠ¨æ—¶é’Ÿ
    setInterval(() => document.getElementById('clock').innerText = "ğŸ•’ " + new Date().toLocaleTimeString(), 1000);
    
    // 1. æ£€æŸ¥èº«ä»½ (Gatekeeper)
    const { data: { session } } = await window.sb.auth.getSession();
    if (!session) {
      document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px'>âš ï¸ è®¿é—®æ‹’ç»</h2><p style='text-align:center'>æ‚¨æœªç™»å½•ï¼Œæ— æ³•è®¿é—®æ•°æ®ã€‚<br><a href='sales.html'>ç‚¹å‡»å‰å¾€ç™»å½•</a></p>";
      alert("âš ï¸ å®‰å…¨è­¦å‘Šï¼š\næ‚¨å°šæœªç™»å½•ï¼Œç³»ç»Ÿæ‹’ç»è®¿é—®æ•°æ®åº“ï¼\n\nè¯·å…ˆåœ¨ Sales é¡µé¢ç™»å½•å‘˜å·¥è´¦å·ã€‚");
      window.location.href = "sales.html";
      return;
    }

    // 2. èº«ä»½éªŒè¯é€šè¿‡ï¼Œå…è®¸åŠ è½½
    loadData();
    setInterval(loadData, 300000);
  };

  // æ’åºï¼šseq_id å‡åº (No.1 åœ¨æœ€ä¸Šé¢ï¼Œç¬¦åˆ Excel ä¹ æƒ¯)
  async function loadData() {
    const { data, error } = await window.sb.from("orders").select("*").order("seq_id", {ascending:true});
    if (error) {
      // å¦‚æœå› ä¸º RLS è¢«æ‹’ï¼Œè¿™é‡Œä¹Ÿä¼šæŠ¥é”™
      console.error(error);
      return alert("è¯»å–å¤±è´¥ (å¯èƒ½æƒé™ä¸è¶³): " + error.message);
    }
    DB = data || [];
    render();
    stats();
  }

  function render() {
    const box = document.getElementById("tbody");
    box.innerHTML = "";
    if(!DB.length) { box.innerHTML = "<tr><td colspan='11' style='text-align:center'>æ— æ•°æ®</td></tr>"; return; }

    DB.forEach(r => {
      const tr = document.createElement("tr");
      
      if(r.total_price === 0) tr.classList.add("gift-row");
      else if(r.remarks && r.remarks.includes("å†…è´­")) tr.classList.add("internal-row");

      const seq = r.seq_id ? `<span class="seq-id">No.${r.seq_id}</span>` : "-";
      const time = new Date(r.created_at).toLocaleString();
      const acc = (r.account||"").split("@")[0];
      const ph = IS_MOBILE ? `<a href="tel:${r.phone}">${r.phone}</a>` : r.phone;
      
      const st = r.tracking_number 
        ? `<span style='color:green;font-weight:bold'>å·²å‘<br>${r.tracking_number}</span>` 
        : `<span style='color:orange'>å¾…å‘</span>`;

      tr.innerHTML = `
        <td><input type="checkbox" class="chk" value="${r.id}"></td>
        <td>${seq}</td>
        <td style="font-size:12px">${time}</td>
        <td>${acc}</td>
        <td><b>${r.customer_name}</b><br>${ph}</td>
        <td>é¼ æ ‡å«</td>
        <td>A:${r.qty_a}/B:${r.qty_b}</td>
        <td><b>${r.total_qty}</b></td>
        <td>${r.total_price}</td>
        <td>${st}</td>
        <td class="remark-cell" title="${r.remarks}">${r.remarks||""}</td>
        <td><button class="edit-btn" onclick='openEdit(${JSON.stringify(r)})'>âœï¸</button></td>
      `;
      box.appendChild(tr);
    });
  }

  function stats() {
    const today = new Date().toISOString().split("T")[0];
    let todayN=0, todayM=0, pending=0, shipped=0, totalN=0, totalSheets=0, totalA=0, totalB=0;
    
    DB.forEach(r => {
      totalN++;
      totalSheets += (r.total_qty || 0);
      totalA += (r.qty_a || 0);
      totalB += (r.qty_b || 0);
      
      if(!r.tracking_number) pending++; else shipped++;

      if(r.created_at.includes(today)) {
        todayN++;
        todayM += (r.total_price || 0);
      }
    });

    document.getElementById("sToday").innerText = todayN;
    document.getElementById("sMoney").innerText = todayM;
    document.getElementById("sTotal").innerText = totalN;
    document.getElementById("sSheets").innerText = totalSheets;
    document.getElementById("sPending").innerText = pending;
    document.getElementById("sShipped").innerText = shipped;

    const t = totalA + totalB;
    if(t>0) {
      const pa = Math.round(totalA/t*100);
      document.getElementById("barA").style.width = pa+"%"; document.getElementById("barA").innerText = `A:${pa}% (${totalA})`;
      document.getElementById("barB").style.width = (100-pa)+"%"; document.getElementById("barB").innerText = `B:${100-pa}% (${totalB})`;
    }
  }

  function openEdit(r) {
    document.getElementById("eId").value = r.id;
    document.getElementById("eName").value = r.customer_name;
    document.getElementById("ePhone").value = r.phone;
    document.getElementById("eAddr").value = r.address;
    document.getElementById("eTrack").value = r.tracking_number || "";
    document.getElementById("eQa").value = r.qty_a;
    document.getElementById("eQb").value = r.qty_b;
    document.getElementById("eRem").value = r.remarks || "";
    document.getElementById("editModal").classList.add("show");
  }

  async function saveEdit() {
    const id = document.getElementById("eId").value;
    const track = document.getElementById("eTrack").value.trim();
    const qa = Number(document.getElementById("eQa").value);
    const qb = Number(document.getElementById("eQb").value);
    const oldR = document.getElementById("eRem").value;
    const newR = `${oldR} | [Adminæ”¹:${new Date().toLocaleTimeString()}]`;
    
    const status = track ? 'shipped' : 'pending';

    const {error} = await window.sb.from("orders").update({
      customer_name: document.getElementById("eName").value,
      phone: document.getElementById("ePhone").value,
      address: document.getElementById("eAddr").value,
      tracking_number: track,
      status: status,
      qty_a: qa, qty_b: qb, total_qty: qa+qb, product: `Aæ¬¾:${qa}, Bæ¬¾:${qb}`,
      remarks: newR
    }).eq("id", id);
    
    if(error) alert(error.message); else { alert("ä¿®æ”¹æˆåŠŸ"); document.getElementById("editModal").classList.remove("show"); loadData(); }
  }

  function openGift(){ document.getElementById('giftModal').classList.add('show'); }
  function openOcr(){ document.getElementById('ocrBox').classList.add('show'); }
  
  function runOcr() {
    const txt = document.getElementById("ocrText").value;
    const ph = txt.match(/1[3-9]\d{9}/)?.[0]||"";
    let rem = txt.replace(ph,"").replace(/æ”¶è´§äºº|æ”¶ä»¶äºº|ç”µè¯|æ‰‹æœº|åœ°å€|ï¼š|:/g," ").replace(/\s+/g," ").trim();
    let nm="", ad=""; const pts=rem.split(" ");
    for(let p of pts){ if(!nm && p.length>=2 && p.length<=4)nm=p; else ad+=p; }
    document.getElementById("gn").value = nm; document.getElementById("gp").value = ph; document.getElementById("ga").value = ad;
    document.getElementById("ocrBox").classList.remove('show');
  }

  async function subGift() {
    const btn = document.getElementById("giftBtn");
    const n = document.getElementById("gn").value;
    const qa = Number(document.getElementById("gqa").value);
    const qb = Number(document.getElementById("gqb").value);
    
    if(!n || (qa+qb)<=0) return alert("ä¿¡æ¯ä¸å…¨");
    
    btn.disabled = true; btn.innerText = "å¤„ç†ä¸­...";
    
    const {error} = await window.sb.from("orders").insert({
      account: "admin_gift", customer_name: n, phone: document.getElementById("gp").value, address: document.getElementById("ga").value,
      qty_a: qa, qty_b: qb, total_qty: qa+qb, product: `Aæ¬¾:${qa}, Bæ¬¾:${qb}`, total_price: 0, shipping: 0,
      status: "pending", remarks: `[${document.getElementById("gt").value}] ${document.getElementById("gr").value}`, item_category: "æ—¥ç”¨å“"
    });
    
    btn.disabled = false; btn.innerText = "ç¡®è®¤";
    if(error) alert(error.message); else { alert("æˆåŠŸ"); document.getElementById("giftModal").classList.remove("show"); loadData(); }
  }

  function expCainiao() {
    if(!DB.length) return alert("æ— æ•°æ®");
    
    const lastId = localStorage.getItem("lastExportSeq") || 0;
    const onlyNew = confirm(`ä¸Šæ¬¡å¯¼å‡ºåˆ° No.${lastId}ã€‚\n\n[ç¡®å®š] = ä»…é«˜äº® No.${lastId} ä¹‹åçš„æ–°æ•°æ®\n[å–æ¶ˆ] = é»˜è®¤å…¨é‡å¯¼å‡º`);
    
    const timeStr = new Date().toISOString().replace(/T/, '_').replace(/\..+/, '').replace(/:/g, '');
    const fname = `èœé¸Ÿå‘è´§å•_${timeStr}.xlsx`;

    const h = ["ç¼–å·\nï¼ˆå•æ¬¡æœ€å¤š5000åŒ…è£¹ï¼‰","æ”¶ä»¶äººå§“å","æ”¶ä»¶äººè”ç³»æ–¹å¼","æ”¶ä»¶åœ°å€","ç‰©å“ç±»ï¼ˆåœ¨ä»¥ä¸‹6ç±»ä¸­é€‰æ‹©ï¼šæ—¥ç”¨å“ã€é£Ÿå“ã€æ–‡ä»¶ã€è¡£ç‰©ã€æ•°ç äº§å“ã€å…¶ä»–ï¼‰","ç‰©å“æ•°é‡","ç‰©å“è¯¦æƒ…","å¤‡æ³¨ä¿¡æ¯","å¤–å¹³å°å•å·(æŠ–éŸ³å¿…å¡«)\n","ã€å›å¡«ã€‘è¿å•å· (ä¾›åº”é“¾å¡«è¿™é‡Œ)"];
    const d = [["","æ”¶ä»¶ä¿¡æ¯","","","ç‰©å“ä¿¡æ¯","","","å¤‡æ³¨","","å›å¡«åŒº"], h];
    
    let maxSeq = 0;
    DB.forEach(r => {
      if(r.seq_id > maxSeq) maxSeq = r.seq_id;
      let desc = `ProPlayeré¼ æ ‡å«`;
      if(r.qty_a) desc += ` (Aæ¬¾ç²—*${r.qty_a})`; if(r.qty_b) desc += ` (Bæ¬¾ç»†*${r.qty_b})`;
      
      let cleanAddr = r.address || "";
      cleanAddr = cleanAddr.replace(r.customer_name, "").replace(r.phone, "").replace(/æ”¶ä»¶äºº|ç”µè¯|ï¼š|:/g, "").trim();

      const isNew = onlyNew && (r.seq_id > lastId);
      const row = [r.id, r.customer_name, r.phone, cleanAddr, "æ—¥ç”¨å“", r.total_qty, desc, r.remarks||"", "", ""];
      if(isNew) row._isNew = true;
      d.push(row);
    });

    const ws = XLSX.utils.aoa_to_sheet(d);
    ws['!cols'] = [{wch:30},{wch:10},{wch:15},{wch:40},{wch:10},{wch:8},{wch:30},{wch:20},{wch:15},{wch:25}];
    const range = XLSX.utils.decode_range(ws['!ref']);
    
    for(let R=0; R<=range.e.r; ++R) {
      const isNewRow = d[R] && d[R]._isNew;
      for(let C=0; C<=range.e.c; ++C) {
        const addr = XLSX.utils.encode_cell({r:R, c:C});
        if(!ws[addr]) continue;
        ws[addr].s = { border: { top:{style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} }, alignment: { vertical: "center", wrapText: true } };
        if(R < 2) { ws[addr].s.fill = { fgColor: { rgb: "CCFFCC" } }; ws[addr].s.font = { bold: true }; }
        
        if(isNewRow) ws[addr].s.font = { color: { rgb: "0000FF" }, bold: true };
        else if (onlyNew && R >= 2) ws[addr].s.font = { color: { rgb: "999999" } };
        
        if(R>=2 && C===7) ws[addr].s.font = { color: { rgb: "FF0000" }, bold: true };
        if(R>=2 && C===9) ws[addr].s.fill = { fgColor: { rgb: "FFFFCC" } };
      }
    }
    
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, fname);
    if(onlyNew) localStorage.setItem("lastExportSeq", maxSeq);
  }

  function expFin() {
    const d = [["æµæ°´å·", "æ—¶é—´","é”€å”®","å§“å","ç”µè¯","åœ°å€","Aæ¬¾","Bæ¬¾","æ€»æ•°","è¿è´¹","æ€»ä»·","çŠ¶æ€","å¤‡æ³¨","è¿å•"]];
    DB.forEach(r => d.push([r.seq_id, new Date(r.created_at).toLocaleString(), r.account, r.customer_name, r.phone, r.address, r.qty_a, r.qty_b, r.total_qty, r.shipping, r.total_price, r.tracking_number?"å·²å‘":"æœªå‘", r.remarks, r.tracking_number]));
    const ws = XLSX.utils.aoa_to_sheet(d); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "è´¢åŠ¡"); XLSX.writeFile(wb, "è´¢åŠ¡å•.xlsx");
  }

  function backupData() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(DB));
    const dlAnchorElem = document.createElement('a');
    dlAnchorElem.setAttribute("href", dataStr);
    dlAnchorElem.setAttribute("download", "ProPlayer_Backup_" + new Date().toISOString() + ".json");
    dlAnchorElem.click();
  }

  function checkAll(el) { document.querySelectorAll(".chk").forEach(c => c.checked = el.checked); }
  async function delSel() {
    const ids = Array.from(document.querySelectorAll(".chk:checked")).map(c => c.value);
    if(!ids.length) return alert("æ²¡é€‰");
    if(confirm("ç¡®å®šåˆ é™¤?")) { await window.sb.from("orders").delete().in("id", ids); loadData(); }
  }
  async function imp(el) {
    const f=el.files[0]; if(!f)return;
    const r=new FileReader();
    r.onload=async(e)=>{
      const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{range:1});
      let n=0;
      for(let row of rows) {
        let oid, trk;
        for(let k in row) { if(k.includes("ç¼–å·")) oid=row[k]; if(k.includes("å›å¡«")||k.includes("è¿å•")) trk=row[k]; }
        if(oid && trk) { const{error}=await window.sb.from("orders").update({tracking_number:trk, status:'shipped'}).eq("id",oid); if(!error) n++; }
      }
      alert(`å·²æ›´æ–° ${n} æ¡`); el.value=""; loadData();
    };
    r.readAsArrayBuffer(f);
  }
</script>
</body>
</html>