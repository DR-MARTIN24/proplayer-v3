<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pro Player Â· æ€»æ§å° V7.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>

  <script>
    // ==========================================
    // âœ… ä½ çš„ä¸“å± Key
    const SUPABASE_URL = "https://ztesoqtztyheezualipa.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZXNvcXR6dHloZWV6dWFsaXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMjk0OTQsImV4cCI6MjA4MzkwNTQ5NH0.rRJIduqiWd37I3w0i-tyKn1skmehLKcX4AOYc-i2cbI";
    // ==========================================
    
    if (typeof supabase !== 'undefined') {
      window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
  </script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 1200px; margin: auto; background: #f5f7fa; }
    h2 { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
    
    .dashboard { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-card { flex: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 4px solid #007aff; }
    .stat-val { font-size: 28px; font-weight: bold; margin-top: 5px; color: #333; }
    .stat-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

    .toolbar { background: #fff; padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    button { padding: 10px 18px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; color:#fff; font-size: 13px; display: flex; align-items: center; gap: 5px; }
    button:active { transform: scale(0.98); }
    
    .btn-export { background: #007aff; } /* èœé¸Ÿè“ */
    .btn-finance { background: #34c759; } /* è´¢åŠ¡ç»¿ */
    .btn-import { background: #5856d6; } /* å¯¼å…¥ç´« */
    .btn-logout { background: #ff3b30; }
    .btn-refresh { background: #eee; color: #333; margin-left: auto; }

    /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
    .table-box { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    th, td { padding: 14px 12px; text-align: left; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
    th { background: #fafafa; color: #555; font-weight: 600; white-space: nowrap; }
    tr:hover { background: #f9f9f9; }
    
    .remark-cell { color: #d70015; font-weight: 500; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .st-shipped { background: #e8f5e9; color: #2e7d32; }
    .st-pending { background: #fff3e0; color: #ef6c00; }
    
    #fileInput { display: none; }
    #loader { text-align: center; padding: 40px; color: #999; }
  </style>
</head>

<body>

<h2>
  <span>Pro Player æ€»æ§å° V7.1</span>
  <button class="btn-logout" onclick="logout()">å®‰å…¨é€€å‡º</button>
</h2>

<div class="dashboard">
  <div class="stat-card">
    <div class="stat-label">ä»Šæ—¥è®¢å• (Local)</div>
    <div class="stat-val" id="sOrders">0</div>
  </div>
  <div class="stat-card" style="border-left-color: #34c759;">
    <div class="stat-label">ä»Šæ—¥è¥æ”¶</div>
    <div class="stat-val" id="sMoney">Â¥0.00</div>
  </div>
  <div class="stat-card" style="border-left-color: #ff9500;">
    <div class="stat-label">å¾…å‘è´§ (æ€»ç§¯å‹)</div>
    <div class="stat-val" id="sPending">0</div>
  </div>
</div>

<div class="toolbar">
  <button class="btn-export" onclick="exportCainiao()">ğŸ“¤ å¯¼å‡ºèœé¸Ÿå‘è´§å• (V2)</button>
  <button class="btn-finance" onclick="exportFinance()">ğŸ’° å¯¼å‡ºå†…éƒ¨è´¢åŠ¡å•</button>
  
  <div style="width:1px; height:24px; background:#ddd; margin:0 5px;"></div>
  
  <button class="btn-import" onclick="document.getElementById('fileInput').click()">ğŸ“¥ å¯¼å…¥å‘è´§å›æ‰§</button>
  <input type="file" id="fileInput" accept=".xlsx" onchange="handleImport(this)">
  
  <button class="btn-refresh" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
</div>

<div id="loader">æ­£åœ¨è¿æ¥æ•°æ®åº“...</div>

<div class="table-box">
  <table id="dataTable" style="display:none;">
    <thead>
      <tr>
        <th>ç³»ç»Ÿç¼–å·</th>
        <th>ä¸‹å•æ—¶é—´</th>
        <th>é”€å”®å‘˜</th>
        <th>æ”¶ä»¶ä¿¡æ¯</th>
        <th>äº§å“è¯¦æƒ…</th>
        <th>A/B</th>
        <th>æ€»æ•°</th>
        <th>æ€»ä»·</th>
        <th>çŠ¶æ€</th>
        <th>å¤‡æ³¨</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script>
  let allOrders = [];
  const MY_ADMIN_EMAIL = "169351@qq.com"; 

  // åˆå§‹åŒ–
  (async () => {
    const { data: { user } } = await window.sb.auth.getUser();
    if (!user) { alert("è¯·å…ˆåœ¨ Sales é¡µé¢ç™»å½•"); location.href = "sales.html"; return; }
    
    if (user.email.trim().toLowerCase() !== MY_ADMIN_EMAIL.trim().toLowerCase()) {
      alert("âš ï¸ æƒé™éªŒè¯å¤±è´¥ï¼šæ‚¨ä¸æ˜¯ç®¡ç†å‘˜ï¼\nå½“å‰è´¦å·: " + user.email);
      location.href = "sales.html";
      return;
    }
    loadData();
  })();

  // è¯»å–æ•°æ® (å«å®¹é”™å¤„ç†)
  async function loadData() {
    try {
      document.getElementById("loader").style.display = "block";
      document.getElementById("dataTable").style.display = "none";
      
      const { data, error } = await window.sb
        .from("orders")
        .select("*")
        .order("created_at", { ascending: false }); // æŒ‰æ—¶é—´å€’åº

      if (error) throw error;
      
      allOrders = data || [];
      
      // å°±ç®—æ•°æ®åªæœ‰1æ¡ï¼Œä¹Ÿè¦æ¸²æŸ“
      renderTable(allOrders);
      calcStats(allOrders);
      
      document.getElementById("loader").style.display = "none";
      document.getElementById("dataTable").style.display = "table";
      
    } catch (err) {
      alert("âŒ æ•°æ®åŠ è½½å¼‚å¸¸: " + err.message);
      document.getElementById("loader").innerText = "åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•";
    }
  }

  // æ¸²æŸ“è¡¨æ ¼ (é˜²çˆ†é€»è¾‘)
  function renderTable(data) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    
    if (data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding:30px; color:#999;">æš‚æ— è®¢å•æ•°æ®</td></tr>`;
      return;
    }

    data.forEach(row => {
      try {
        const tr = document.createElement("tr");
        const shortId = (row.id || "????").split('-')[0];
        const dateStr = new Date(row.created_at).toLocaleString('zh-CN', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
        
        // çŠ¶æ€å¾½ç« 
        const isShipped = !!row.tracking_number;
        const statusHtml = isShipped
          ? `<span class="status-badge st-shipped">å·²å‘è´§<br><span style="font-weight:normal;font-size:10px">${row.tracking_number}</span></span>`
          : `<span class="status-badge st-pending">å¾…å‘è´§</span>`;

        tr.innerHTML = `
          <td style="font-family:monospace; color:#888;">${shortId}</td>
          <td>${dateStr}</td>
          <td>${(row.account||"").split('@')[0]}</td>
          <td>
            <strong>${row.customer_name}</strong><br>
            <span style="color:#666;font-size:12px;">${row.phone}</span>
          </td>
          <td>${row.product}</td>
          <td style="font-size:12px; color:#666;">A:${row.qty_a || 0} / B:${row.qty_b || 0}</td>
          <td style="font-weight:bold;">${row.total_qty}</td>
          <td style="color:#007aff;">Â¥${row.total_price}</td>
          <td>${statusHtml}</td>
          <td class="remark-cell" title="${row.remarks}">${row.remarks || '-'}</td>
        `;
        tbody.appendChild(tr);
      } catch (e) {
        console.error("æ¸²æŸ“æŸè¡Œå¤±è´¥", e);
      }
    });
  }

  // ç»Ÿè®¡é€»è¾‘ (ä¿®å¤æ—¶åŒºé—®é¢˜)
  function calcStats(data) {
    // è·å–æœ¬åœ°æ—¶é—´çš„ YYYY-MM-DD
    const now = new Date();
    const localTodayStr = now.getFullYear() + "-" + 
      String(now.getMonth() + 1).padStart(2, '0') + "-" + 
      String(now.getDate()).padStart(2, '0');

    let todayCount = 0;
    let todayMoney = 0;
    let pendingCount = 0;

    data.forEach(o => {
      // å°†è®¢å•æ—¶é—´ä¹Ÿè½¬ä¸ºæœ¬åœ° YYYY-MM-DD
      const orderDate = new Date(o.created_at);
      const orderDateStr = orderDate.getFullYear() + "-" + 
        String(orderDate.getMonth() + 1).padStart(2, '0') + "-" + 
        String(orderDate.getDate()).padStart(2, '0');

      if (orderDateStr === localTodayStr) {
        todayCount++;
        todayMoney += (o.total_price || 0);
      }

      if (!o.tracking_number) pendingCount++;
    });

    document.getElementById("sOrders").innerText = todayCount;
    document.getElementById("sMoney").innerText = "Â¥" + todayMoney.toFixed(2);
    document.getElementById("sPending").innerText = pendingCount;
  }

  // ===========================================
  // ğŸ“¦ å¯¼å‡º 1: èœé¸Ÿå‘è´§å• (ä¸¥æ ¼å¯¹é½ç‰ˆ)
  // ===========================================
  function exportCainiao() {
    if(!allOrders.length) return alert("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º");

    // 1. æ„å»ºåŒè¡Œè¡¨å¤´ (ä¸ºäº†åŒ¹é…æ¨¡æ¿çš„å¤æ‚æ€§ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨ç¬¬äºŒè¡Œä½œä¸ºä¸»æ•°æ®è¡Œï¼Œç¬¬ä¸€è¡Œç”¨æ¥å ä½æˆ–è¯´æ˜)
    // èœé¸Ÿæ¨¡æ¿é€šå¸¸å‰å‡ è¡Œæœ‰åˆå¹¶å•å…ƒæ ¼ï¼Œè¿™é‡Œæ¨¡æ‹Ÿæœ€æ ¸å¿ƒçš„å¯¼å…¥ç»“æ„
    
    // è¡¨å¤´è¡Œ (ä¸¥æ ¼æŒ‰ç…§ä½ çš„ CSV é¡ºåºï¼Œå¹¶åœ¨è¯¦æƒ…å·¦è¾¹åŠ äº†æ•°é‡)
    const header = [
      "ç¼–å·\nï¼ˆå•æ¬¡æœ€å¤š5000åŒ…è£¹ï¼‰", 
      "æ”¶ä»¶äººå§“å", 
      "æ”¶ä»¶äººè”ç³»æ–¹å¼", 
      "æ”¶ä»¶åœ°å€", 
      "ç‰©å“ç±»ï¼ˆåœ¨ä»¥ä¸‹6ç±»ä¸­é€‰æ‹©ï¼šæ—¥ç”¨å“ã€é£Ÿå“ã€æ–‡ä»¶ã€è¡£ç‰©ã€æ•°ç äº§å“ã€å…¶ä»–ï¼‰", 
      "ç‰©å“æ•°é‡",  // âœ… æ–°å¢åˆ—ï¼šåœ¨ç‰©å“è¯¦æƒ…å·¦ä¾§
      "ç‰©å“è¯¦æƒ…", 
      "å¤‡æ³¨ä¿¡æ¯", 
      "å¤–å¹³å°å•å·(æŠ–éŸ³å¿…å¡«)\n"
    ];

    const wsData = [
      ["", "æ”¶ä»¶ä¿¡æ¯", "", "", "ç‰©å“ä¿¡æ¯", "", "", "å¤‡æ³¨", "å•å·"], // æ¨¡æ‹Ÿç¬¬ä¸€è¡Œå½’ç±»
      header // ç¬¬äºŒè¡Œæ­£å¼è¡¨å¤´
    ];

    allOrders.forEach(o => {
      // è¿‡æ»¤æ‰å·²å‘è´§çš„ï¼Ÿé€šå¸¸å‘è´§å•å¯¼å‡ºæœªå‘è´§çš„ï¼Œä½†è¿™é‡Œå…¨å¯¼å‡ºï¼Œä½ è‡ªå·±ç­›é€‰
      wsData.push([
        o.id,              // ç¼–å·
        o.customer_name,   // å§“å
        o.phone,           // ç”µè¯
        o.address,         // åœ°å€
        "æ—¥ç”¨å“",          // ç‰©å“ç±»
        o.total_qty,       // âœ… ç‰©å“æ•°é‡
        o.product,         // ç‰©å“è¯¦æƒ…
        o.remarks || "",   // å¤‡æ³¨
        ""                 // å¤–å¹³å°å•å·
      ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // === ğŸ¨ æ ·å¼ç¾åŒ– ===
    // è®¾ç½®åˆ—å®½
    ws['!cols'] = [
      {wch: 30}, // ID
      {wch: 10}, // å§“å
      {wch: 15}, // ç”µè¯
      {wch: 40}, // åœ°å€
      {wch: 10}, // ç‰©å“ç±»
      {wch: 8},  // æ•°é‡
      {wch: 25}, // è¯¦æƒ…
      {wch: 20}, // å¤‡æ³¨
      {wch: 15}  // å•å·
    ];

    // éå†å•å…ƒæ ¼åŠ è¾¹æ¡†å’Œé¢œè‰²
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = 0; R <= range.e.r; ++R) {
      for (let C = 0; C <= range.e.c; ++C) {
        const cellRef = XLSX.utils.encode_cell({r: R, c: C});
        if (!ws[cellRef]) continue;

        // åŸºç¡€æ ·å¼
        ws[cellRef].s = {
          border: {
            top: {style: "thin", color: {rgb: "000000"}},
            bottom: {style: "thin", color: {rgb: "000000"}},
            left: {style: "thin", color: {rgb: "000000"}},
            right: {style: "thin", color: {rgb: "000000"}}
          },
          alignment: { vertical: "center", wrapText: true }
        };

        // è¡¨å¤´é¢œè‰² (å‰ä¸¤è¡Œ)
        if (R < 2) {
          ws[cellRef].s.fill = { fgColor: { rgb: "CCFFCC" } }; // æµ…ç»¿è‰²èƒŒæ™¯
          ws[cellRef].s.font = { bold: true };
        }

        // çº¢è‰²å¤‡æ³¨ (ç¬¬8åˆ—, Index 7)
        if (R >= 2 && C === 7) {
           ws[cellRef].s.font = { color: { rgb: "FF0000" }, bold: true };
        }
      }
    }

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, `èœé¸Ÿå‘è´§å•_${new Date().toISOString().split('T')[0]}.xlsx`);
  }

  // ===========================================
  // ğŸ’° å¯¼å‡º 2: è´¢åŠ¡ç‰ˆ (å…¨ä¸­æ–‡è¡¨å¤´)
  // ===========================================
  function exportFinance() {
    if(!allOrders.length) return alert("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º");

    const wsData = [];
    // ä¸­æ–‡è¡¨å¤´
    wsData.push(["ä¸‹å•æ—¶é—´", "é”€å”®å‘˜", "å®¢æˆ·å§“å", "ç”µè¯", "æ”¶è´§åœ°å€", "Aæ¬¾(ä¸ª)", "Bæ¬¾(ä¸ª)", "æ€»æ•°é‡", "è¿è´¹", "è®¢å•æ€»é¢", "å½“å‰çŠ¶æ€", "å¤‡æ³¨ä¿¡æ¯", "è¿å•å·"]);

    allOrders.forEach(o => {
      wsData.push([
        new Date(o.created_at).toLocaleString(),
        o.account,
        o.customer_name,
        o.phone,
        o.address,
        o.qty_a,
        o.qty_b,
        o.total_qty,
        o.shipping,
        o.total_price,
        o.tracking_number ? "å·²å‘è´§" : "å¾…å‘è´§",
        o.remarks || "",
        o.tracking_number || ""
      ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "è´¢åŠ¡æ˜ç»†");
    XLSX.writeFile(wb, `é”€å”®è´¢åŠ¡è¡¨_${new Date().toISOString().split('T')[0]}.xlsx`);
  }

  // ===========================================
  // ğŸ“¥ å¯¼å…¥å›å¡«
  // ===========================================
  async function handleImport(input) {
    const file = input.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet);
      
      let count = 0;
      for(let row of json) {
        // æ™ºèƒ½åŒ¹é…åˆ—å
        const orderId = row['ç¼–å·\nï¼ˆå•æ¬¡æœ€å¤š5000åŒ…è£¹ï¼‰'] || row['ç¼–å·'] || row['è®¢å•å·'];
        const trackNo = row['è¿å•å·'] || row['å¿«é€’å•å·'] || row['å•å·'];
        
        if(orderId && trackNo) {
          const { error } = await window.sb.from('orders')
            .update({ tracking_number: trackNo, status: 'shipped' })
            .eq('id', orderId); 
          
          if(!error) count++;
        }
      }
      alert(`âœ… å¯¼å…¥å®Œæˆï¼æˆåŠŸæ›´æ–°äº† ${count} æ¡å‘è´§çŠ¶æ€ã€‚`);
      input.value = ""; 
      loadData(); 
    };
    reader.readAsArrayBuffer(file);
  }

  async function logout() {
    if(confirm("ç¡®å®šé€€å‡ºç®¡ç†åå°ï¼Ÿ")) {
      await window.sb.auth.signOut();
      location.href = "sales.html";
    }
  }
</script>

<footer style="margin-top:40px; text-align:center; font-size:12px; color:#999;">
  Pro Player Admin System V7.1
</footer>

</body>
</html>