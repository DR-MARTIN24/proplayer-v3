<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pro Player Â· æ€»æ§å° V7.0 (æ­£å¼ç‰ˆ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>

  <script>
    // ==========================================
    // âœ… å·²æ›´æ–°ä¸ºæ­£ç¡®çš„ Key
    const SUPABASE_URL = "https://ztesoqtztyheezualipa.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZXNvcXR6dHloZWV6dWFsaXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMjk0OTQsImV4cCI6MjA4MzkwNTQ5NH0.rRJIduqiWd37I3w0i-tyKn1skmehLKcX4AOYc-i2cbI";
    // ==========================================
    
    if (typeof supabase !== 'undefined') {
      window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
  </script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 1100px; margin: auto; background: #f5f7fa; }
    h2 { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
    .dashboard { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-card { flex: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .stat-val { font-size: 28px; font-weight: bold; margin-top: 5px; }
    .toolbar { background: #fff; padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    button { padding: 10px 18px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; color:#fff; }
    button:active { transform: scale(0.98); }
    .btn-export { background: #007aff; }
    .btn-finance { background: #34c759; }
    .btn-import { background: #5856d6; }
    .btn-logout { background: #ff3b30; }
    table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
    th { background: #f4f4f4; color: #555; }
    .remark-cell { color: #d70015; font-weight: 500; }
    .status-shipped { color: green; font-weight: bold; }
    .status-pending { color: orange; }
    #fileInput { display: none; }
    #errorBanner { background: #ffeded; color: #ff3b30; padding: 10px; border-radius: 5px; margin-bottom: 15px; display:none; border: 1px solid #ffcccc; }
  </style>
</head>

<body>

<div style="display:flex; justify-content:space-between; align-items:center;">
  <h2>Pro Player æ€»æ§å° V7.0</h2>
  <button class="btn-logout" onclick="logout()">å®‰å…¨é€€å‡º</button>
</div>

<div id="errorBanner"></div>

<div class="dashboard">
  <div class="stat-card">
    <div style="color:#888; font-size:12px;">ä»Šæ—¥è®¢å•</div>
    <div class="stat-val" id="sOrders">0</div>
  </div>
  <div class="stat-card">
    <div style="color:#888; font-size:12px;">ä»Šæ—¥è¥æ”¶</div>
    <div class="stat-val" id="sMoney">Â¥0.00</div>
  </div>
  <div class="stat-card">
    <div style="color:#888; font-size:12px;">å¾…å‘è´§</div>
    <div class="stat-val" id="sPending" style="color:orange">0</div>
  </div>
</div>

<div class="toolbar">
  <button class="btn-export" onclick="exportCainiao()">ğŸ“¤ å¯¼å‡ºèœé¸Ÿå‘è´§å• (V2)</button>
  <button class="btn-finance" onclick="exportFinance()">ğŸ’° å¯¼å‡ºå†…éƒ¨è´¢åŠ¡å•</button>
  <div style="width:1px; height:30px; background:#ddd; margin:0 10px;"></div>
  <button class="btn-import" onclick="document.getElementById('fileInput').click()">ğŸ“¥ å¯¼å…¥å‘è´§å›æ‰§</button>
  <input type="file" id="fileInput" accept=".xlsx" onchange="handleImport(this)">
  <button style="background:#eee; color:#333; margin-left:auto;" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
</div>

<div id="loader" style="text-align:center; padding:20px;">æ•°æ®åŠ è½½ä¸­...</div>

<table id="dataTable" style="display:none;">
  <thead>
    <tr>
      <th>è®¢å•å· (ç³»ç»ŸID)</th>
      <th>æ—¶é—´</th>
      <th>é”€å”®</th>
      <th>æ”¶ä»¶äºº</th>
      <th>äº§å“</th>
      <th>æ€»æ•°</th>
      <th>çŠ¶æ€</th>
      <th>å¤‡æ³¨</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
  let allOrders = [];
  const MY_ADMIN_EMAIL = "169351@qq.com"; // ç®¡ç†å‘˜é‚®ç®±

  (async () => {
    // æ£€æŸ¥ç™»å½•
    const { data: { user } } = await window.sb.auth.getUser();
    if (!user) { alert("è¯·å…ˆåœ¨ Sales é¡µé¢ç™»å½•"); location.href = "sales.html"; return; }
    
    // æƒé™æ£€æŸ¥
    if (user.email.trim().toLowerCase() !== MY_ADMIN_EMAIL.trim().toLowerCase()) {
      alert("âš ï¸ æƒé™éªŒè¯å¤±è´¥ï¼šæ‚¨ä¸æ˜¯ç®¡ç†å‘˜ï¼\nå½“å‰è´¦å·: " + user.email);
      location.href = "sales.html";
      return;
    }
    
    loadData();
  })();

  async function loadData() {
    document.getElementById("loader").style.display = "block";
    document.getElementById("errorBanner").style.display = "none";
    
    // è¯»å–æ•°æ®
    const { data, error } = await window.sb.from("orders").select("*").order("created_at", { ascending: false });
    
    if(error) {
      document.getElementById("loader").style.display = "none";
      const banner = document.getElementById("errorBanner");
      banner.style.display = "block";
      banner.innerHTML = `<strong>âš ï¸ æ•°æ®è¯»å–å¤±è´¥:</strong> ${error.message} <br>å¯èƒ½åŸå› ï¼šç½‘ç»œä¸ç¨³å®šã€‚<button onclick="loadData()" style="margin-left:10px; padding:2px 8px; background:#fff; color:#333; border:1px solid #ccc;">é‡è¯•</button>`;
      return;
    }
    
    allOrders = data;
    renderTable(data);
    calcStats(data);
    document.getElementById("loader").style.display = "none";
    document.getElementById("dataTable").style.display = "table";
  }

  function renderTable(data) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    data.forEach(row => {
      const tr = document.createElement("tr");
      const shortId = row.id.split('-')[0];
      const statusHtml = row.tracking_number 
        ? `<span class="status-shipped">å·²å‘è´§<br><small>${row.tracking_number}</small></span>` 
        : `<span class="status-pending">å¾…å‘è´§</span>`;

      tr.innerHTML = `
        <td style="font-family:monospace; color:#666;">...${shortId}</td>
        <td>${new Date(row.created_at).toLocaleString()}</td>
        <td>${row.account}</td>
        <td>${row.customer_name}<br><small>${row.phone}</small></td>
        <td>${row.product}</td>
        <td style="font-weight:bold">${row.total_qty}</td>
        <td>${statusHtml}</td>
        <td class="remark-cell">${row.remarks || ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function calcStats(data) {
    const today = new Date().toISOString().split('T')[0];
    const todays = data.filter(o => o.created_at.startsWith(today));
    document.getElementById("sOrders").innerText = todays.length;
    document.getElementById("sMoney").innerText = "Â¥" + todays.reduce((a,b)=>a+(b.total_price||0),0).toFixed(2);
    document.getElementById("sPending").innerText = data.filter(o => !o.tracking_number).length;
  }

  function exportCainiao() {
    if(!allOrders.length) return;
    const wsData = [[ "ç¼–å·\nï¼ˆå•æ¬¡æœ€å¤š5000åŒ…è£¹ï¼‰", "æ”¶ä»¶äººå§“å", "æ”¶ä»¶äººè”ç³»æ–¹å¼", "æ”¶ä»¶åœ°å€", "ç‰©å“ç±»ï¼ˆåœ¨ä»¥ä¸‹6ç±»ä¸­é€‰æ‹©ï¼šæ—¥ç”¨å“ã€é£Ÿå“ã€æ–‡ä»¶ã€è¡£ç‰©ã€æ•°ç äº§å“ã€å…¶ä»–ï¼‰", "ç‰©å“è¯¦æƒ…", "å¤‡æ³¨ä¿¡æ¯", "å¤–å¹³å°å•å·(æŠ–éŸ³å¿…å¡«)\n" ]];
    allOrders.forEach(o => {
      wsData.push([ o.id, o.customer_name, o.phone, o.address, "æ—¥ç”¨å“", o.product, o.remarks || "", "" ]);
    });
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const range = XLSX.utils.decode_range(ws['!ref']);
    // å¤‡æ³¨ä¿¡æ¯æ˜¯ç¬¬7åˆ— (Gåˆ—), ç´¢å¼•6
    for(let R=1; R<=range.e.r; ++R) { const cell = XLSX.utils.encode_cell({r:R, c:6}); if(ws[cell]) ws[cell].s = { font: { color: { rgb: "FF0000" }, bold: true } }; }
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, `èœé¸Ÿå‘è´§å•_${new Date().toISOString().split('T')[0]}.xlsx`);
  }

  function exportFinance() {
    const ws = XLSX.utils.json_to_sheet(allOrders); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "è´¢åŠ¡æ˜ç»†");
    XLSX.writeFile(wb, `è´¢åŠ¡å¯¹è´¦å•.xlsx`);
  }

  async function handleImport(input) {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
      let count = 0;
      for(let row of json) {
        // å°è¯•åŒ¹é…å›ä¼ è¡¨æ ¼é‡Œçš„å•å·åˆ—
        // é€šå¸¸å‘è´§å›ä¼ è¡¨é‡Œï¼Œç¬¬ä¸€åˆ—æ˜¯æˆ‘ä»¬çš„è®¢å•å·ï¼Œåé¢ä¼šæœ‰è¿å•å·
        const orderId = row['ç¼–å·\nï¼ˆå•æ¬¡æœ€å¤š5000åŒ…è£¹ï¼‰'] || row['è®¢å•å·'] || row['Order ID'];
        const trackNo = row['è¿å•å·'] || row['å¿«é€’å•å·'] || row['å•å·'];
        if(orderId && trackNo) {
          const { error } = await window.sb.from('orders').update({ tracking_number: trackNo, status: 'shipped' }).eq('id', orderId);
          if(!error) count++;
        }
      }
      alert(`âœ… å¯¼å…¥å®Œæˆï¼æˆåŠŸæ›´æ–°äº† ${count} æ¡å‘è´§çŠ¶æ€ã€‚`); input.value = ""; loadData(); 
    };
    reader.readAsArrayBuffer(file);
  }

  async function logout() { await window.sb.auth.signOut(); location.href = "sales.html"; }
</script>
</body>
</html>