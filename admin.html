<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pro Player Â· æ€»æ§å° V7.9 (æ— é—¨æ§›ç›´é€šç‰ˆ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>

  <script>
    // âœ… Key ç»å¯¹æ­£ç¡®
    const SUPABASE_URL = "https://ztesoqtztyheezualipa.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZXNvcXR6dHloZWV6dWFsaXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMjk0OTQsImV4cCI6MjA4MzkwNTQ5NH0.rRJIduqiWd37I3w0i-tyKn1skmehLKcX4AOYc-i2cbI";
    
    // åˆå§‹åŒ–
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <style>
    body { font-family: -apple-system, sans-serif; padding: 20px; background: #f5f7fa; }
    h2 { border-bottom: 2px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    
    /* é¡¶éƒ¨ç»Ÿè®¡å¡ */
    .stats-box { display: flex; gap: 15px; margin-bottom: 20px; }
    .card { background: #fff; padding: 15px; border-radius: 8px; flex: 1; border-left: 4px solid #007aff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .num { font-size: 24px; font-weight: bold; margin-top: 5px; }

    /* å æ¯”æ¡ */
    .bar-box { background: #fff; padding: 10px; margin-bottom: 20px; border-radius: 8px; }
    .bar-track { display: flex; height: 24px; background: #eee; border-radius: 12px; overflow: hidden; margin-top: 5px; }
    .bar-part { display: flex; align-items: center; justify-content: center; color: #fff; font-size: 11px; font-weight: bold; transition: width 0.3s; }

    /* æŒ‰é’®ç»„ */
    .btn-group { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
    button { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; color: #fff; font-weight: bold; }
    .btn-blue { background: #007aff; }
    .btn-green { background: #34c759; }
    .btn-orange { background: #ff9500; }
    .btn-red { background: #ff3b30; }
    .btn-gray { background: #eee; color: #333; }

    /* è¡¨æ ¼ */
    .table-container { overflow-x: auto; background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 900px; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #fafafa; white-space: nowrap; }
    
    /* å¼¹çª— */
    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index: 1000; }
    .modal.show { display: flex; }
    .modal-box { background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
    input, textarea, select { width: 100%; padding: 8px; margin: 5px 0 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
  </style>
</head>

<body>

<h2>
  <span>Pro Player æ€»æ§å° V7.9</span>
  <button class="btn-gray" onclick="window.location.href='sales.html'">è¿”å›é”€å”®ç«¯</button>
</h2>

<div class="stats-box">
  <div class="card"><div>ä»Šæ—¥è®¢å•</div><div class="num" id="vOrder">0</div></div>
  <div class="card" style="border-color:#34c759"><div>ä»Šæ—¥è¥æ”¶</div><div class="num" id="vMoney">Â¥0</div></div>
  <div class="card" style="border-color:#ff9500"><div>å¾…å‘è´§</div><div class="num" id="vPending">0</div></div>
</div>

<div class="bar-box">
  <div style="font-size:12px; font-weight:bold;">
    <span style="color:#007aff">â— Aæ¬¾(ç²—)</span> <span style="color:#ff9500; margin-left:10px;">â— Bæ¬¾(ç»†)</span>
  </div>
  <div class="bar-track">
    <div id="barA" class="bar-part" style="background:#007aff; width:50%">A:0</div>
    <div id="barB" class="bar-part" style="background:#ff9500; width:50%">B:0</div>
  </div>
</div>

<div class="btn-group">
  <button class="btn-blue" onclick="exportCainiao()">ğŸ“¤ å¯¼å‡ºèœé¸Ÿ</button>
  <button class="btn-green" onclick="exportFinance()">ğŸ’° å¯¼å‡ºè´¢åŠ¡</button>
  <button class="btn-orange" onclick="showGift()">ğŸ å½•å…¥èµ é€</button>
  <button class="btn-red" onclick="delSel()">ğŸ—‘ åˆ é™¤é€‰ä¸­</button>
  <button class="btn-gray" onclick="window.location.reload()">ğŸ”„ å¼ºåˆ¶åˆ·æ–°</button>
  
  <input type="file" id="fileIn" accept=".xlsx" style="display:none" onchange="doImport(this)">
  <button class="btn-gray" style="margin-left:auto" onclick="document.getElementById('fileIn').click()">ğŸ“¥ å¯¼å…¥å›æ‰§</button>
</div>

<div id="statusMsg" style="text-align:center; padding:20px; color:#888;">æ­£åœ¨è¯»å–æ•°æ®åº“...</div>

<div class="table-container">
  <table id="mainTable" style="display:none">
    <thead>
      <tr>
        <th width="30"><input type="checkbox" onchange="checkAll(this)"></th>
        <th>ç¼–å·</th><th>æ—¶é—´</th><th>é”€å”®</th><th>æ”¶ä»¶äºº</th><th>äº§å“</th><th>A/B</th><th>æ•°</th><th>ä»·</th><th>çŠ¶æ€</th><th>å¤‡æ³¨</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div id="giftModal" class="modal">
  <div class="modal-box">
    <h3>ğŸ èµ é€å•</h3>
    <label>ç±»å‹</label><select id="gt"><option>æ´»åŠ¨èµ é€</option><option>é€‰æ‰‹æ¨å¹¿</option></select>
    <label>å§“å</label><input id="gn">
    <label>ç”µè¯</label><input id="gp">
    <label>åœ°å€</label><input id="ga">
    <div style="display:flex; gap:10px">
      <div style="flex:1"><label>Aæ¬¾æ•°</label><input type="number" id="gqa" value="0"></div>
      <div style="flex:1"><label>Bæ¬¾æ•°</label><input type="number" id="gqb" value="0"></div>
    </div>
    <label>å¤‡æ³¨</label><input id="gr">
    <div style="display:flex; gap:10px; margin-top:10px">
      <button class="btn-gray" style="flex:1" onclick="document.getElementById('giftModal').classList.remove('show')">å–æ¶ˆ</button>
      <button class="btn-orange" style="flex:1" onclick="submitGift()">ç¡®è®¤</button>
    </div>
  </div>
</div>

<script>
  let allData = [];

  // 1. æ— é—¨æ§›å¯åŠ¨ (ç§»é™¤äº†æ‰€æœ‰ç™»å½•æ£€æŸ¥)
  window.onload = async () => {
    fetchData();
  };

  // 2. æ ¸å¿ƒè¯»å–
  async function fetchData() {
    document.getElementById("statusMsg").innerText = "æ­£åœ¨è¿æ¥ Supabase...";
    
    // ç®€å•ç²—æš´è¯»å–
    const { data, error } = await window.sb.from("orders").select("*").order("created_at", {ascending:false});

    if (error) {
      document.getElementById("statusMsg").innerHTML = `<b style="color:red">è¯»å–å¤±è´¥: ${error.message}</b><br>è¯·æ£€æŸ¥ SQL Editor é‡Œçš„ RLS è®¾ç½®`;
      return;
    }

    if (!data || data.length === 0) {
      document.getElementById("statusMsg").innerText = "âœ… è¿æ¥æˆåŠŸï¼Œä½†æ²¡æœ‰è®¢å•æ•°æ® (0æ¡)";
      return;
    }

    allData = data;
    document.getElementById("statusMsg").style.display = "none";
    document.getElementById("mainTable").style.display = "table";
    render();
    stats();
  }

  // 3. æ¸²æŸ“
  function render() {
    const box = document.getElementById("tbody");
    box.innerHTML = "";
    allData.forEach(r => {
      try {
        const tr = document.createElement("tr");
        const isShip = !!r.tracking_number;
        const st = isShip ? `<span style="color:green;font-weight:bold">å·²å‘è´§<br><a href="https://www.baidu.com/s?wd=${r.tracking_number}" target="_blank">${r.tracking_number}</a></span>` : `<span style="color:orange">å¾…å‘è´§</span>`;
        
        let rem = r.remarks || "";
        if (rem.includes("å†…è´­") || rem.includes("èµ é€")) rem = `<b style="color:green">${rem}</b>`;
        
        // å®¹é”™å¤„ç†ï¼šå¦‚æœå­—æ®µæ˜¯ nullï¼Œç»™ä¸ªé»˜è®¤å€¼ 0
        const qa = r.qty_a || 0; 
        const qb = r.qty_b || 0;
        const tq = (r.total_qty !== undefined && r.total_qty !== null) ? r.total_qty : (qa+qb);
        const tp = (r.total_price !== undefined && r.total_price !== null) ? r.total_price : 0;

        tr.innerHTML = `
          <td><input type="checkbox" class="chk" value="${r.id}"></td>
          <td>${(r.id||"").substr(0,8)}</td>
          <td>${new Date(r.created_at).toLocaleString()}</td>
          <td>${(r.account||"").split("@")[0]}</td>
          <td><b>${r.customer_name}</b><br>${r.phone}</td>
          <td>ProPlayeré¼ æ ‡å«</td>
          <td>A:${qa} / B:${qb}</td>
          <td><b>${tq}</b></td>
          <td>${tp}</td>
          <td>${st}</td>
          <td style="max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap" title="${rem}">${rem}</td>
        `;
        box.appendChild(tr);
      } catch (err) {
        console.error("æ¸²æŸ“æŸè¡Œå¤±è´¥", err);
      }
    });
  }

  // 4. ç»Ÿè®¡
  function stats() {
    const today = new Date().toISOString().split("T")[0];
    let tNum=0, tMoney=0, pending=0, sa=0, sb=0;
    
    allData.forEach(r => {
      // å®¹é”™
      const price = r.total_price || 0;
      const qa = r.qty_a || 0;
      const qb = r.qty_b || 0;

      if (r.created_at && r.created_at.includes(today)) { tNum++; tMoney += price; }
      if (!r.tracking_number) pending++;
      sa += qa;
      sb += qb;
    });

    document.getElementById("vOrder").innerText = tNum;
    document.getElementById("vMoney").innerText = "Â¥" + tMoney;
    document.getElementById("vPending").innerText = pending;

    const total = sa + sb;
    if(total > 0) {
      const pa = Math.round(sa/total*100);
      const pb = 100 - pa;
      document.getElementById("barA").style.width = pa+"%"; document.getElementById("barA").innerText = `A: ${pa}% (${sa})`;
      document.getElementById("barB").style.width = pb+"%"; document.getElementById("barB").innerText = `B: ${pb}% (${sb})`;
    } else {
       document.getElementById("barA").style.width = "50%"; document.getElementById("barA").innerText = "A: 0";
       document.getElementById("barB").style.width = "50%"; document.getElementById("barB").innerText = "B: 0";
    }
  }

  // 5. äº¤äº’åŠŸèƒ½
  function showGift() { document.getElementById("giftModal").classList.add("show"); }
  
  async function submitGift() {
    const type = document.getElementById("gt").value;
    const name = document.getElementById("gn").value;
    const qa = Number(document.getElementById("gqa").value);
    const qb = Number(document.getElementById("gqb").value);
    
    if(!name || (qa+qb)<=0) return alert("å†™åå­—ï¼Œå¡«æ•°é‡ï¼");
    
    const { error } = await window.sb.from("orders").insert({
      account: "admin_gift", customer_name: name, phone: document.getElementById("gp").value, address: document.getElementById("ga").value,
      qty_a: qa, qty_b: qb, total_qty: qa+qb, product: `Aæ¬¾:${qa}, Bæ¬¾:${qb}`, total_price: 0, shipping: 0,
      status: "pending", remarks: `[${type}] ${document.getElementById("gr").value}`, item_category: "æ—¥ç”¨å“"
    });
    
    if(error) alert(error.message);
    else { alert("âœ… å½•å…¥æˆåŠŸ"); document.getElementById("giftModal").classList.remove("show"); fetchData(); }
  }

  function checkAll(el) { document.querySelectorAll(".chk").forEach(c => c.checked = el.checked); }
  
  async function delSel() {
    const ids = Array.from(document.querySelectorAll(".chk:checked")).map(c => c.value);
    if(!ids.length) return alert("æ²¡é€‰æ€ä¹ˆåˆ ï¼Ÿ");
    if(confirm(`ç¡®å®šåˆ é™¤è¿™ ${ids.length} æ¡ï¼Ÿ`)) {
      await window.sb.from("orders").delete().in("id", ids);
      fetchData();
    }
  }

  // å¯¼å‡º (èœé¸Ÿ + è´¢åŠ¡)
  function exportCainiao() {
    if(!allData.length) return;
    const head = ["ç¼–å·\nï¼ˆå•æ¬¡æœ€å¤š5000åŒ…è£¹ï¼‰","æ”¶ä»¶äººå§“å","æ”¶ä»¶äººè”ç³»æ–¹å¼","æ”¶ä»¶åœ°å€","ç‰©å“ç±»ï¼ˆåœ¨ä»¥ä¸‹6ç±»ä¸­é€‰æ‹©ï¼šæ—¥ç”¨å“ã€é£Ÿå“ã€æ–‡ä»¶ã€è¡£ç‰©ã€æ•°ç äº§å“ã€å…¶ä»–ï¼‰","ç‰©å“æ•°é‡","ç‰©å“è¯¦æƒ…","å¤‡æ³¨ä¿¡æ¯","å¤–å¹³å°å•å·(æŠ–éŸ³å¿…å¡«)\n","ã€å›å¡«ã€‘è¿å•å· (ä¾›åº”é“¾å¡«è¿™é‡Œ)"];
    const body = [["","æ”¶ä»¶ä¿¡æ¯","","","ç‰©å“ä¿¡æ¯","","","å¤‡æ³¨","","å›å¡«åŒº"], head];
    allData.forEach(r => {
      let d = "ProPlayeré¼ æ ‡å«";
      const qa = r.qty_a || 0; const qb = r.qty_b || 0;
      if(qa) d += ` (Aæ¬¾ç²—*${qa})`; if(qb) d += ` (Bæ¬¾ç»†*${qb})`;
      body.push([r.id, r.customer_name, r.phone, r.address, "æ—¥ç”¨å“", r.total_qty, d, r.remarks, "", ""]);
    });
    const ws = XLSX.utils.aoa_to_sheet(body);
    // æ ·å¼ç•¥
    ws['!cols'] = [{wch:30},{wch:10},{wch:15},{wch:40},{wch:10},{wch:8},{wch:30},{wch:20},{wch:15},{wch:20}];
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, "èœé¸Ÿå‘è´§å•.xlsx");
  }

  function exportFinance() {
    const body = [["æ—¶é—´","é”€å”®","å§“å","ç”µè¯","åœ°å€","Aæ¬¾","Bæ¬¾","æ€»æ•°","è¿è´¹","æ€»ä»·","çŠ¶æ€","å¤‡æ³¨","è¿å•"]];
    allData.forEach(r => body.push([r.created_at, r.account, r.customer_name, r.phone, r.address, r.qty_a, r.qty_b, r.total_qty, r.shipping, r.total_price, r.tracking_number||"æœªå‘è´§", r.remarks, r.tracking_number]));
    const ws = XLSX.utils.aoa_to_sheet(body);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "è´¢åŠ¡");
    XLSX.writeFile(wb, "è´¢åŠ¡å•.xlsx");
  }

  async function doImport(el) {
    const f = el.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = async (e) => {
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {range:1});
      let n = 0;
      for(let row of rows) {
        let oid, track;
        for(let k in row) {
          if(k.includes("ç¼–å·")) oid = row[k];
          if(k.includes("å›å¡«") || k.includes("è¿å•")) track = row[k];
        }
        if(oid && track) {
          const {error} = await window.sb.from("orders").update({tracking_number:track, status:'shipped'}).eq("id",oid);
          if(!error) n++;
        }
      }
      alert(`âœ… æ›´æ–° ${n} æ¡`); el.value=""; fetchData();
    };
    r.readAsArrayBuffer(f);
  }
</script>
</body>
</html>