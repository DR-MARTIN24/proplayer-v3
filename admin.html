<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pro Player Â· æ€»æ§å° V8.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>

  <script>
    const SUPABASE_URL = "https://ztesoqtztyheezualipa.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZXNvcXR6dHloZWV6dWFsaXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMjk0OTQsImV4cCI6MjA4MzkwNTQ5NH0.rRJIduqiWd37I3w0i-tyKn1skmehLKcX4AOYc-i2cbI";
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f7fa; padding-bottom:100px; }
    .header { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center; }
    .live-clock { background: #ff3b30; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    
    .card-row { display: flex; gap: 15px; margin-bottom: 20px; }
    .card { flex: 1; background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #007aff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .num { font-size: 24px; font-weight: bold; }
    
    .bar-wrap { background: #fff; padding: 10px; margin-bottom: 20px; border-radius: 8px; }
    .bar { display: flex; height: 20px; background: #eee; border-radius: 10px; overflow: hidden; margin-top: 5px; }
    
    .btn-row { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
    button { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; color: #fff; font-weight: bold; }
    .btn-b { background: #007aff; } .btn-g { background: #34c759; } .btn-o { background: #ff9500; } .btn-r { background: #ff3b30; } .btn-gy { background: #666; }

    /* æ ¸å¿ƒè¡¨æ ¼ */
    table { width: 100%; border-collapse: collapse; background: #fff; font-size: 13px; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #fafafa; }
    .scroll-box { overflow-x: auto; min-height: 300px; }
    
    /* è¯Šæ–­åŒº */
    #debugArea { background: #000; color: #0f0; padding: 10px; margin-top: 30px; font-family: monospace; white-space: pre-wrap; display: none; }
    
    /* å¼¹çª— */
    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; }
    .modal.show { display: flex; }
    .modal-box { background: #fff; padding: 20px; border-radius: 10px; width: 300px; }
    input, select { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; display: block; box-sizing: border-box; }
  </style>
</head>

<body>

<div class="header">
  <div>
    <span style="font-size:20px; font-weight:bold">æ€»æ§å° V8.2</span>
    <span id="clock" class="live-clock">Waiting...</span>
  </div>
  <button class="btn-gy" onclick="location.href='sales.html'">è¿”å›é”€å”®</button>
</div>

<div class="card-row">
  <div class="card"><div>è®¢å•</div><div class="num" id="s1">0</div></div>
  <div class="card" style="border-color:#34c759"><div>è¥æ”¶</div><div class="num" id="s2">0</div></div>
  <div class="card" style="border-color:#ff9500"><div>å¾…å‘</div><div class="num" id="s3">0</div></div>
</div>

<div class="bar-wrap">
  <div style="font-size:12px; font-weight:bold;">Aæ¬¾(è“) / Bæ¬¾(æ©™) å æ¯”</div>
  <div class="bar">
    <div id="barA" style="background:#007aff; width:50%; color:#fff; text-align:center; font-size:11px; line-height:20px;">A</div>
    <div id="barB" style="background:#ff9500; width:50%; color:#fff; text-align:center; font-size:11px; line-height:20px;">B</div>
  </div>
</div>

<div class="btn-row">
  <button class="btn-b" onclick="expCainiao()">ğŸ“¤ èœé¸Ÿå¯¼å‡º</button>
  <button class="btn-g" onclick="expFin()">ğŸ’° è´¢åŠ¡å¯¼å‡º</button>
  <button class="btn-o" onclick="document.getElementById('giftModal').classList.add('show')">ğŸ èµ é€</button>
  <button class="btn-r" onclick="delSel()">ğŸ—‘ åˆ é™¤</button>
  <button class="btn-gy" onclick="load()">ğŸ”„ åˆ·æ–°</button>
  <button class="btn-gy" onclick="toggleDebug()">ğŸ‘€ è¯Šæ–­</button>
  
  <input type="file" id="fIn" style="display:none" onchange="imp(this)">
  <button class="btn-gy" style="margin-left:auto" onclick="document.getElementById('fIn').click()">ğŸ“¥ å¯¼å…¥</button>
</div>

<div class="scroll-box">
  <table id="tbl">
    <thead>
      <tr>
        <th width="30"><input type="checkbox" onchange="checkAll(this)"></th>
        <th>ç¼–å·</th><th>æ—¶é—´</th><th>é”€å”®</th><th>æ”¶ä»¶äºº</th><th>äº§å“</th><th>A/B</th><th>æ•°</th><th>ä»·</th><th>çŠ¶æ€</th><th>å¤‡æ³¨</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div id="debugArea">è¯Šæ–­ä¿¡æ¯åŒº...</div>

<div id="giftModal" class="modal">
  <div class="modal-box">
    <h3>å½•å…¥èµ é€</h3>
    <label>ç±»å‹</label><select id="gt"><option>æ´»åŠ¨èµ é€</option><option>é€‰æ‰‹æ¨å¹¿</option></select>
    <label>å§“å</label><input id="gn">
    <label>ç”µè¯</label><input id="gp">
    <label>åœ°å€</label><input id="ga">
    <label>Aæ¬¾æ•°é‡</label><input type="number" id="gqa" value="0">
    <label>Bæ¬¾æ•°é‡</label><input type="number" id="gqb" value="0">
    <label>å¤‡æ³¨</label><input id="gr">
    <button class="btn-b" onclick="subGift()">ç¡®è®¤</button>
    <button class="btn-gy" style="margin-top:5px" onclick="document.getElementById('giftModal').classList.remove('show')">å–æ¶ˆ</button>
  </div>
</div>

<script>
  let DB = [];

  // 1. å¯åŠ¨
  window.onload = () => {
    setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);
    load();
  };

  // 2. è¯»å–
  async function load() {
    document.getElementById("tbody").innerHTML = "<tr><td colspan='11'>æ­£åœ¨åŠ è½½...</td></tr>";
    
    // ä¸è¿‡æ»¤ï¼Œå…¨æŸ¥
    const { data, error } = await window.sb.from("orders").select("*").order("created_at", {ascending:false});
    
    if(error) {
      alert("è¯»å–é”™è¯¯: " + error.message);
      document.getElementById("debugArea").innerText = JSON.stringify(error, null, 2);
      return;
    }

    DB = data || [];
    document.getElementById("debugArea").innerText = `è·å–åˆ° ${DB.length} æ¡æ•°æ®ã€‚\né¦–æ¡æ•°æ®æ ·æœ¬: ` + JSON.stringify(DB[0], null, 2);
    
    render();
    stats();
  }

  // 3. æ¸²æŸ“ (å¼ºåŠ›æ¨¡å¼)
  function render() {
    const box = document.getElementById("tbody");
    box.innerHTML = "";
    
    if(DB.length === 0) {
      box.innerHTML = "<tr><td colspan='11'>æ²¡æœ‰æ•°æ®</td></tr>";
      return;
    }

    DB.forEach(r => {
      // å®¹é”™: å³ä½¿å­—æ®µç¼ºå¤±ä¹Ÿä¸æŠ¥é”™
      const id = (r.id||"").substr(0,8);
      const time = r.created_at ? r.created_at.split('T')[0] : "-";
      const acc = (r.account||"").split("@")[0];
      const name = r.customer_name || "æ— å";
      const ph = r.phone || "";
      const qa = r.qty_a || 0;
      const qb = r.qty_b || 0;
      const tot = (qa+qb) || r.total_qty || 0;
      const pr = r.total_price || 0;
      let rem = r.remarks || "";
      
      const st = r.tracking_number 
        ? `<span style='color:green;font-weight:bold'>å·²å‘<br>${r.tracking_number}</span>` 
        : `<span style='color:orange'>å¾…å‘</span>`;

      if(rem.includes("å†…è´­") || rem.includes("èµ é€")) rem = `<b style='color:green'>${rem}</b>`;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="checkbox" class="chk" value="${r.id}"></td>
        <td>${id}</td>
        <td>${time}</td>
        <td>${acc}</td>
        <td><b>${name}</b><br>${ph}</td>
        <td>é¼ æ ‡å«</td>
        <td>A:${qa}/B:${qb}</td>
        <td><b>${tot}</b></td>
        <td>${pr}</td>
        <td>${st}</td>
        <td style="font-size:12px; max-width:150px;">${rem}</td>
      `;
      box.appendChild(tr);
    });
  }

  // 4. ç»Ÿè®¡
  function stats() {
    let n=0, m=0, p=0, sa=0, sb=0;
    DB.forEach(r => {
      // ç®€å•çš„ä»Šæ—¥ç»Ÿè®¡
      if(new Date(r.created_at).toDateString() === new Date().toDateString()) { n++; m+=(r.total_price||0); }
      if(!r.tracking_number) p++;
      sa += (r.qty_a||0); sb += (r.qty_b||0);
    });
    
    document.getElementById("s1").innerText = n;
    document.getElementById("s2").innerText = "Â¥"+m;
    document.getElementById("s3").innerText = p;
    
    const t = sa+sb;
    if(t>0) {
      const pa = Math.round(sa/t*100);
      document.getElementById("barA").style.width = pa+"%"; document.getElementById("barA").innerText = `A: ${pa}% (${sa})`;
      document.getElementById("barB").style.width = (100-pa)+"%"; document.getElementById("barB").innerText = `B: ${100-pa}% (${sb})`;
    }
  }

  // 5. äº¤äº’
  function checkAll(el) { document.querySelectorAll(".chk").forEach(c => c.checked = el.checked); }
  
  async function delSel() {
    const ids = Array.from(document.querySelectorAll(".chk:checked")).map(c => c.value);
    if(!ids.length) return alert("æ²¡é€‰");
    if(confirm("ç¡®å®šåˆ é™¤?")) { await window.sb.from("orders").delete().in("id", ids); load(); }
  }

  async function subGift() {
    const n = document.getElementById("gn").value;
    const qa = Number(document.getElementById("gqa").value);
    const qb = Number(document.getElementById("gqb").value);
    if(!n || (qa+qb)<=0) return alert("ä¿¡æ¯ä¸å…¨");
    
    const {error} = await window.sb.from("orders").insert({
      account: "admin_gift", customer_name: n, phone: document.getElementById("gp").value, address: document.getElementById("ga").value,
      qty_a: qa, qty_b: qb, total_qty: qa+qb, product: `Aæ¬¾:${qa}, Bæ¬¾:${qb}`, total_price: 0, shipping: 0,
      status: "pending", remarks: `[${document.getElementById("gt").value}] ${document.getElementById("gr").value}`, item_category: "æ—¥ç”¨å“"
    });
    if(error) alert(error.message); else { alert("æˆåŠŸ"); document.getElementById('giftModal').classList.remove('show'); load(); }
  }

  function toggleDebug() {
    const d = document.getElementById("debugArea");
    d.style.display = d.style.display === "block" ? "none" : "block";
  }

  // å¯¼å‡º (V7.4å®Œç¾ç‰ˆ)
  function expCainiao() {
    if(!DB.length) return alert("æ²¡æ•°æ®");
    const h = ["ç¼–å·\nï¼ˆå•æ¬¡æœ€å¤š5000åŒ…è£¹ï¼‰","æ”¶ä»¶äººå§“å","æ”¶ä»¶äººè”ç³»æ–¹å¼","æ”¶ä»¶åœ°å€","ç‰©å“ç±»ï¼ˆåœ¨ä»¥ä¸‹6ç±»ä¸­é€‰æ‹©ï¼šæ—¥ç”¨å“ã€é£Ÿå“ã€æ–‡ä»¶ã€è¡£ç‰©ã€æ•°ç äº§å“ã€å…¶ä»–ï¼‰","ç‰©å“æ•°é‡","ç‰©å“è¯¦æƒ…","å¤‡æ³¨ä¿¡æ¯","å¤–å¹³å°å•å·(æŠ–éŸ³å¿…å¡«)\n","ã€å›å¡«ã€‘è¿å•å· (ä¾›åº”é“¾å¡«è¿™é‡Œ)"];
    const d = [["","æ”¶ä»¶ä¿¡æ¯","","","ç‰©å“ä¿¡æ¯","","","å¤‡æ³¨","","å›å¡«åŒº"], h];
    
    DB.forEach(r => {
      let desc = "ProPlayeré¼ æ ‡å«";
      if(r.qty_a) desc += ` (Aæ¬¾ç²—*${r.qty_a})`;
      if(r.qty_b) desc += ` (Bæ¬¾ç»†*${r.qty_b})`;
      d.push([r.id, r.customer_name, r.phone, r.address, "æ—¥ç”¨å“", r.total_qty, desc, r.remarks||"", "", ""]);
    });

    const ws = XLSX.utils.aoa_to_sheet(d);
    ws['!cols'] = [{wch:30},{wch:10},{wch:15},{wch:40},{wch:10},{wch:8},{wch:30},{wch:20},{wch:15},{wch:25}];
    const range = XLSX.utils.decode_range(ws['!ref']);
    for(let R=0; R<=range.e.r; ++R) {
      for(let C=0; C<=range.e.c; ++C) {
        const cell = ws[XLSX.utils.encode_cell({r:R, c:C})];
        if(!cell) continue;
        cell.s = { border: { top:{style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} }, alignment: { vertical: "center", wrapText: true } };
        if(R<2) { cell.s.fill={fgColor:{rgb:"CCFFCC"}}; cell.s.font={bold:true}; }
        if(R>=2 && C===7) cell.s.font={color:{rgb:"FF0000"},bold:true};
        if(R>=2 && C===9) cell.s.fill={fgColor:{rgb:"FFFFCC"}};
      }
    }
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, "èœé¸Ÿå‘è´§å•.xlsx");
  }

  function expFin() {
    const d = [["æ—¶é—´","é”€å”®","å§“å","ç”µè¯","åœ°å€","Aæ¬¾","Bæ¬¾","æ€»æ•°","è¿è´¹","æ€»ä»·","çŠ¶æ€","å¤‡æ³¨","è¿å•"]];
    DB.forEach(r => d.push([r.created_at, r.account, r.customer_name, r.phone, r.address, r.qty_a, r.qty_b, r.total_qty, r.shipping, r.total_price, r.tracking_number?"å·²å‘":"æœªå‘", r.remarks, r.tracking_number]));
    const ws = XLSX.utils.aoa_to_sheet(d);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, "è´¢åŠ¡å•.xlsx");
  }

  async function imp(el) {
    const f=el.files[0]; if(!f)return;
    const r=new FileReader();
    r.onload=async(e)=>{
      const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{range:1});
      let n=0;
      for(let row of rows) {
        let oid, trk;
        for(let k in row) { if(k.includes("ç¼–å·")) oid=row[k]; if(k.includes("å›å¡«")||k.includes("è¿å•")) trk=row[k]; }
        if(oid && trk) { const{error}=await window.sb.from("orders").update({tracking_number:trk, status:'shipped'}).eq("id",oid); if(!error) n++; }
      }
      alert(`å·²æ›´æ–° ${n} æ¡`); el.value=""; load();
    };
    r.readAsArrayBuffer(f);
  }
</script>
</body>
</html>