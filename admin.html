<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pro Player Â· æ€»æ§å° V7.5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>

  <script>
    const SUPABASE_URL = "https://ztesoqtztyheezualipa.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZXNvcXR6dHloZWV6dWFsaXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMjk0OTQsImV4cCI6MjA4MzkwNTQ5NH0.rRJIduqiWd37I3w0i-tyKn1skmehLKcX4AOYc-i2cbI";
    
    if (typeof supabase !== 'undefined') {
      window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
  </script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 1200px; margin: auto; background: #f5f7fa; padding-bottom: 60px; }
    h2 { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
    
    .dashboard { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-card { flex: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 4px solid #007aff; }
    .stat-val { font-size: 28px; font-weight: bold; margin-top: 5px; color: #333; }
    .stat-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

    /* A/B æ¬¾å æ¯”å›¾ */
    .ratio-bar-container { width: 100%; height: 24px; background: #eee; border-radius: 12px; overflow: hidden; display: flex; margin-bottom: 20px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); position: relative; }
    .ratio-a { background: #007aff; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: bold; transition: width 0.5s; }
    .ratio-b { background: #ff9500; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: bold; transition: width 0.5s; }
    .ratio-legend { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 5px; }

    .toolbar { background: #fff; padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    button { padding: 10px 18px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; color:#fff; font-size: 13px; display: flex; align-items: center; gap: 5px; }
    button:active { transform: scale(0.98); }
    
    .btn-export { background: #007aff; }
    .btn-finance { background: #34c759; }
    .btn-import { background: #5856d6; }
    .btn-gift { background: #ff9500; }
    .btn-delete { background: #ff3b30; }
    .btn-logout { background: #666; }
    .btn-refresh { background: #eee; color: #333; margin-left: auto; }

    .table-box { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow-x: auto; min-height: 200px; }
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    th, td { padding: 14px 12px; text-align: left; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
    th { background: #fafafa; color: #555; font-weight: 600; white-space: nowrap; }
    tr:hover { background: #f9f9f9; }
    
    .remark-cell { color: #666; font-size: 13px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .remark-vip { color: #34c759; font-weight: bold; }
    
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .st-shipped { background: #e8f5e9; color: #2e7d32; }
    .st-pending { background: #fff3e0; color: #ef6c00; }
    
    .tracking-link { color: inherit; text-decoration: none; border-bottom: 1px dashed currentColor; }
    .tracking-link:hover { color: #007aff; border-bottom-style: solid; }

    .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); z-index: 99; display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; }
    .input-group { margin-bottom: 12px; }
    .input-group label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; }
    .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
    
    .hidden { display: none; }
    #fileInput { display: none; }
    #loader { text-align: center; padding: 40px; color: #999; }
    
    footer { margin-top: 40px; text-align: center; font-size: 12px; color: #999; border-top: 1px solid #eee; padding-top: 20px; }
  </style>
</head>

<body>

<h2>
  <span>Pro Player æ€»æ§å° V7.5</span>
  <button class="btn-logout" onclick="logout()">å®‰å…¨é€€å‡º</button>
</h2>

<div class="dashboard">
  <div class="stat-card">
    <div class="stat-label">ä»Šæ—¥è®¢å•</div>
    <div class="stat-val" id="sOrders">0</div>
  </div>
  <div class="stat-card" style="border-left-color: #34c759;">
    <div class="stat-label">ä»Šæ—¥è¥æ”¶</div>
    <div class="stat-val" id="sMoney">Â¥0.00</div>
  </div>
  <div class="stat-card" style="border-left-color: #ff9500;">
    <div class="stat-label">å¾…å‘è´§</div>
    <div class="stat-val" id="sPending">0</div>
  </div>
</div>

<div style="background:#fff; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
  <div class="ratio-legend">
    <span style="color:#007aff; font-weight:bold;">â— Aæ¬¾ (ç²—é¢)</span>
    <span style="color:#ff9500; font-weight:bold;">â— Bæ¬¾ (ç»†é¢)</span>
  </div>
  <div class="ratio-bar-container">
    <div id="barA" class="ratio-a" style="width: 50%">A: 0%</div>
    <div id="barB" class="ratio-b" style="width: 50%">B: 0%</div>
  </div>
</div>

<div class="toolbar">
  <button class="btn-export" onclick="exportCainiao()">ğŸ“¤ å¯¼å‡ºèœé¸Ÿå‘è´§å•</button>
  <button class="btn-finance" onclick="exportFinance()">ğŸ’° å¯¼å‡ºå†…éƒ¨è´¢åŠ¡å•</button>
  <div style="width:1px; height:24px; background:#ddd; margin:0 5px;"></div>
  
  <button class="btn-gift" onclick="openGiftModal()">ğŸ å½•å…¥èµ é€å•</button>
  <button class="btn-delete" onclick="deleteSelected()">ğŸ—‘ æ‰¹é‡åˆ é™¤</button>

  <div style="width:1px; height:24px; background:#ddd; margin:0 5px;"></div>
  <button class="btn-import" onclick="document.getElementById('fileInput').click()">ğŸ“¥ å¯¼å…¥å‘è´§å›æ‰§</button>
  <input type="file" id="fileInput" accept=".xlsx" onchange="handleImport(this)">
  
  <button class="btn-refresh" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
</div>

<div id="loader">æ­£åœ¨è¿æ¥æ•°æ®åº“...</div>

<div class="table-box">
  <table id="dataTable" style="display:none;">
    <thead>
      <tr>
        <th width="40"><input type="checkbox" onchange="toggleAll(this)"></th>
        <th>ç¼–å·</th>
        <th>æ—¶é—´</th>
        <th>é”€å”®å‘˜</th>
        <th>æ”¶ä»¶ä¿¡æ¯</th>
        <th>äº§å“è¯¦æƒ…</th>
        <th>A/Bæ˜ç»†</th>
        <th>æ€»æ•°</th>
        <th>æ€»ä»·</th>
        <th>çŠ¶æ€</th>
        <th>å¤‡æ³¨</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<div id="giftModal" class="hidden modal-overlay">
  <div class="modal-content">
    <h3>ğŸ æ–°å¢èµ é€å• (0å…ƒ)</h3>
    <div class="input-group">
      <label>èµ é€ç±»å‹</label>
      <select id="giftType"><option value="æ´»åŠ¨èµ é€">ğŸ‰ æ´»åŠ¨èµ é€</option><option value="é€‰æ‰‹æ¨å¹¿">ğŸ® èŒä¸šé€‰æ‰‹æ¨å¹¿</option></select>
    </div>
    <div class="input-group"><label>æ”¶ä»¶äººå§“å</label><input id="gName"></div>
    <div class="input-group"><label>ç”µè¯</label><input id="gPhone"></div>
    <div class="input-group"><label>åœ°å€</label><textarea id="gAddr" rows="2"></textarea></div>
    <div style="display:flex; gap:10px;">
      <div class="input-group" style="flex:1"><label>Aæ¬¾æ•°é‡</label><input type="number" id="gQa" value="0"></div>
      <div class="input-group" style="flex:1"><label>Bæ¬¾æ•°é‡</label><input type="number" id="gQb" value="0"></div>
    </div>
    <div class="input-group"><label>å¤‡æ³¨</label><input id="gRemarks" placeholder="é€‰å¡«..."></div>
    <div style="display:flex; gap:10px; margin-top:15px;">
      <button onclick="document.getElementById('giftModal').classList.add('hidden')" style="flex:1; background:#eee; color:#333;">å–æ¶ˆ</button>
      <button onclick="submitGift()" style="flex:1; background:#ff9500; color:#fff;">ç¡®è®¤èµ é€</button>
    </div>
  </div>
</div>

<footer>Pro Player Admin System V7.5 &copy; 2026<br>Powered by Mars-è€åˆ˜ & AI</footer>

<script>
  let allOrders = [];
  const MY_ADMIN_EMAIL = "169351@qq.com"; 

  (async () => {
    const { data: { user } } = await window.sb.auth.getUser();
    if (!user) { alert("è¯·å…ˆåœ¨ Sales é¡µé¢ç™»å½•"); location.href = "sales.html"; return; }
    if (user.email.trim().toLowerCase() !== MY_ADMIN_EMAIL.trim().toLowerCase()) {
      alert("âš ï¸ æƒé™éªŒè¯å¤±è´¥"); location.href = "sales.html"; return;
    }
    loadData();
  })();

  async function loadData() {
    try {
      document.getElementById("loader").style.display = "block";
      document.getElementById("dataTable").style.display = "none";
      const { data, error } = await window.sb.from("orders").select("*").order("created_at", { ascending: false });
      if (error) throw error;
      allOrders = data || [];
      
      // T1ä¿®å¤: å¼ºåˆ¶æ¸²æŸ“ï¼Œå³ä½¿æ•°æ®æœ‰ç©ºå­—æ®µ
      renderTable(allOrders);
      calcStats(allOrders);
      
      document.getElementById("loader").style.display = "none";
      document.getElementById("dataTable").style.display = "table";
    } catch (err) {
      document.getElementById("loader").innerHTML = `<span style="color:red">âŒ åŠ è½½å¤±è´¥: ${err.message}</span>`;
    }
  }

  function renderTable(data) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    if (data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding:30px; color:#999;">æš‚æ— æ•°æ®</td></tr>`;
      return;
    }

    data.forEach(row => {
      try {
        const tr = document.createElement("tr");
        const shortId = (row.id || "????").substring(0, 8);
        const isShipped = !!row.tracking_number;
        const statusHtml = isShipped
          ? `<span class="status-badge st-shipped">å·²å‘è´§<br><a href="https://www.baidu.com/s?wd=${row.tracking_number}" target="_blank" class="tracking-link">${row.tracking_number}</a></span>`
          : `<span class="status-badge st-pending">å¾…å‘è´§</span>`;

        let remarkHtml = row.remarks || '-';
        if (remarkHtml.includes("è€BABYå†…è´­") || remarkHtml.includes("èµ é€")) {
          remarkHtml = `<span class="remark-vip">${remarkHtml}</span>`;
        }

        const qtyA = Number(row.qty_a) || 0;
        const qtyB = Number(row.qty_b) || 0;

        tr.innerHTML = `
          <td><input type="checkbox" class="row-checkbox" value="${row.id}"></td>
          <td style="font-family:monospace; color:#888;">${shortId}</td>
          <td>${new Date(row.created_at).toLocaleString()}</td>
          <td>${(row.account||"").split('@')[0]}</td>
          <td><strong>${row.customer_name || "æœªçŸ¥"}</strong><br><small>${row.phone || "-"}</small></td>
          <td>${row.product || "-"}</td>
          <td style="font-size:12px; color:#666;">A:${qtyA} / B:${qtyB}</td>
          <td style="font-weight:bold;">${row.total_qty || 0}</td>
          <td style="color:${row.total_price==0 ? '#ff9500' : '#007aff'};">${row.total_price==0 ? 'èµ é€' : 'Â¥'+row.total_price}</td>
          <td>${statusHtml}</td>
          <td class="remark-cell" title="${row.remarks}">${remarkHtml}</td>
        `;
        tbody.appendChild(tr);
      } catch (e) { console.error("æ¸²æŸ“é”™è¯¯", e); }
    });
  }

  // T1: ç»Ÿè®¡é€»è¾‘ + æ¡çŠ¶å›¾æ›´æ–°
  function calcStats(data) {
    const now = new Date();
    const localTodayStr = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0') + "-" + String(now.getDate()).padStart(2, '0');
    let todayCount = 0, todayMoney = 0, pendingCount = 0;
    
    // A/B ç»Ÿè®¡
    let totalA = 0, totalB = 0;

    data.forEach(o => {
      if (o.created_at && o.created_at.indexOf(localTodayStr) > -1) {
        todayCount++;
        todayMoney += (o.total_price || 0);
      }
      if (!o.tracking_number) pendingCount++;
      
      totalA += (o.qty_a || 0);
      totalB += (o.qty_b || 0);
    });

    document.getElementById("sOrders").innerText = todayCount;
    document.getElementById("sMoney").innerText = "Â¥" + todayMoney.toFixed(2);
    document.getElementById("sPending").innerText = pendingCount;

    // æ›´æ–° A/B å æ¯”æ¡
    const grandTotal = totalA + totalB;
    if (grandTotal > 0) {
      const pctA = Math.round((totalA / grandTotal) * 100);
      const pctB = 100 - pctA;
      document.getElementById("barA").style.width = pctA + "%";
      document.getElementById("barA").innerText = `Aæ¬¾: ${pctA}% (${totalA})`;
      document.getElementById("barB").style.width = pctB + "%";
      document.getElementById("barB").innerText = `Bæ¬¾: ${pctB}% (${totalB})`;
    } else {
      document.getElementById("barA").style.width = "50%"; document.getElementById("barA").innerText = "æ— æ•°æ®";
      document.getElementById("barB").style.width = "50%"; document.getElementById("barB").innerText = "æ— æ•°æ®";
    }
  }

  // èµ é€å•
  function openGiftModal() { document.getElementById('giftModal').classList.remove('hidden'); }
  async function submitGift() {
    const name = document.getElementById('gName').value;
    const phone = document.getElementById('gPhone').value;
    const addr = document.getElementById('gAddr').value;
    const qa = parseInt(document.getElementById('gQa').value) || 0;
    const qb = parseInt(document.getElementById('gQb').value) || 0;
    const type = document.getElementById('giftType').value; 
    const remarkInput = document.getElementById('gRemarks').value;

    if(!name || (qa+qb)<=0) return alert("å§“åå’Œæ•°é‡å¿…å¡«");
    const fullRemark = `[${type}] ${remarkInput}`;

    const { error } = await window.sb.from("orders").insert({
      account: "admin_gift", customer_name: name, phone: phone, address: addr,
      qty_a: qa, qty_b: qb, total_qty: qa+qb, product: `Aæ¬¾:${qa}, Bæ¬¾:${qb}`,
      order_type: 'gift', total_price: 0, shipping: 0, remarks: fullRemark, status: 'pending', item_category: 'æ—¥ç”¨å“'
    });
    if(error) alert(error.message);
    else { alert("ğŸ èµ é€å•å½•å…¥æˆåŠŸï¼"); document.getElementById('giftModal').classList.add('hidden'); loadData(); }
  }

  // æ‰¹é‡åˆ é™¤
  function toggleAll(source) { document.querySelectorAll('.row-checkbox').forEach(c => c.checked = source.checked); }
  async function deleteSelected() {
    const ids = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(c => c.value);
    if(ids.length === 0) return alert("è¯·å…ˆå‹¾é€‰è¦åˆ é™¤çš„è®¢å•");
    if(!confirm(`âš ï¸ ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ ${ids.length} æ¡æ•°æ®å—ï¼Ÿ`)) return;
    const { error } = await window.sb.from('orders').delete().in('id', ids);
    if(error) alert("åˆ é™¤å¤±è´¥: " + error.message); else { alert("âœ… å·²åˆ é™¤"); loadData(); }
  }

  // å¯¼å‡ºé€»è¾‘ (èœé¸Ÿ + è´¢åŠ¡)
  function exportCainiao() {
    if(!allOrders.length) return alert("æ— æ•°æ®");
    const header = ["ç¼–å·\nï¼ˆå•æ¬¡æœ€å¤š5000åŒ…è£¹ï¼‰", "æ”¶ä»¶äººå§“å", "æ”¶ä»¶äººè”ç³»æ–¹å¼", "æ”¶ä»¶åœ°å€", "ç‰©å“ç±»ï¼ˆåœ¨ä»¥ä¸‹6ç±»ä¸­é€‰æ‹©ï¼šæ—¥ç”¨å“ã€é£Ÿå“ã€æ–‡ä»¶ã€è¡£ç‰©ã€æ•°ç äº§å“ã€å…¶ä»–ï¼‰", "ç‰©å“æ•°é‡", "ç‰©å“è¯¦æƒ…", "å¤‡æ³¨ä¿¡æ¯", "å¤–å¹³å°å•å·(æŠ–éŸ³å¿…å¡«)\n", "ã€å›å¡«ã€‘è¿å•å· (ä¾›åº”é“¾å¡«è¿™é‡Œ)"];
    const wsData = [["", "æ”¶ä»¶ä¿¡æ¯", "", "", "ç‰©å“ä¿¡æ¯", "", "", "å¤‡æ³¨", "å•å·", "å›å¡«åŒº"], header];
    allOrders.forEach(o => {
      const qa = Number(o.qty_a)||0, qb = Number(o.qty_b)||0;
      let detailStr = "ProPlayeré¼ æ ‡å«";
      const parts = []; if(qa>0) parts.push(`Aæ¬¾ç²—*${qa}`); if(qb>0) parts.push(`Bæ¬¾ç»†*${qb}`);
      if(parts.length>0) detailStr += ` (${parts.join(", ")})`;
      wsData.push([o.id, o.customer_name, o.phone, o.address, "æ—¥ç”¨å“", o.total_qty, detailStr, o.remarks||"", "", ""]);
    });
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    ws['!cols'] = [{wch:30},{wch:10},{wch:15},{wch:40},{wch:10},{wch:8},{wch:35},{wch:20},{wch:15},{wch:25}];
    const range = XLSX.utils.decode_range(ws['!ref']);
    for(let R=0; R<=range.e.r; ++R) {
      for(let C=0; C<=range.e.c; ++C) {
        const cell = ws[XLSX.utils.encode_cell({r:R, c:C})];
        if(!cell) continue;
        cell.s = { border:{top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}}, alignment:{vertical:"center",wrapText:true} };
        if(R<2) { cell.s.fill={fgColor:{rgb:"CCFFCC"}}; cell.s.font={bold:true}; }
        if(R>=2 && C===7) cell.s.font={color:{rgb:"FF0000"},bold:true};
        if(R>=2 && C===9) cell.s.fill={fgColor:{rgb:"FFFFCC"}};
      }
    }
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, `èœé¸Ÿå‘è´§å•_${new Date().toISOString().split('T')[0]}.xlsx`);
  }

  function exportFinance() {
    if(!allOrders.length) return alert("æ— æ•°æ®");
    const wsData = [["ä¸‹å•æ—¶é—´", "é”€å”®å‘˜", "å®¢æˆ·å§“å", "ç”µè¯", "æ”¶è´§åœ°å€", "Aæ¬¾ç²—(å¼ )", "Bæ¬¾ç»†(å¼ )", "æ€»æ•°é‡", "è¿è´¹", "è®¢å•æ€»é¢", "å½“å‰çŠ¶æ€", "å¤‡æ³¨ä¿¡æ¯", "è¿å•å·"]];
    allOrders.forEach(o => wsData.push([new Date(o.created_at).toLocaleString(), o.account, o.customer_name, o.phone, o.address, o.qty_a, o.qty_b, o.total_qty, o.shipping, o.total_price, o.tracking_number?"å·²å‘è´§":"å¾…å‘è´§", o.remarks||"", o.tracking_number||""]));
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "è´¢åŠ¡æ˜ç»†");
    XLSX.writeFile(wb, `é”€å”®è´¢åŠ¡è¡¨_${new Date().toISOString().split('T')[0]}.xlsx`);
  }

  // å¯¼å…¥å›å¡«
  async function handleImport(input) {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {range:1});
      let count = 0;
      for(let row of json) {
        let orderId = null, trackNo = null;
        for(let key in row) {
          if(key.includes("ç¼–å·")) orderId = row[key];
          if(key.includes("ã€å›å¡«ã€‘") || key.includes("è¿å•å·")) trackNo = row[key];
        }
        if(orderId && trackNo) {
          const { error } = await window.sb.from('orders').update({ tracking_number: trackNo, status: 'shipped' }).eq('id', orderId);
          if(!error) count++;
        }
      }
      alert(`âœ… æ›´æ–°äº† ${count} æ¡`); input.value = ""; loadData();
    };
    reader.readAsArrayBuffer(file);
  }

  async function logout() { if(confirm("é€€å‡ºåå°ï¼Ÿ")) { await window.sb.auth.signOut(); location.href = "sales.html"; } }
</script>
</body>
</html>