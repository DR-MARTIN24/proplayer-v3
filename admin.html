<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pro Player Â· æ€»æ§å° V7.3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>

  <script>
    // âœ… ä½ çš„ä¸“å± Key
    const SUPABASE_URL = "https://ztesoqtztyheezualipa.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZXNvcXR6dHloZWV6dWFsaXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMjk0OTQsImV4cCI6MjA4MzkwNTQ5NH0.rRJIduqiWd37I3w0i-tyKn1skmehLKcX4AOYc-i2cbI";
    
    if (typeof supabase !== 'undefined') {
      window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
  </script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 1200px; margin: auto; background: #f5f7fa; padding-bottom: 60px; }
    h2 { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
    
    .dashboard { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-card { flex: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 4px solid #007aff; }
    .stat-val { font-size: 28px; font-weight: bold; margin-top: 5px; color: #333; }
    .stat-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

    .toolbar { background: #fff; padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    button { padding: 10px 18px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; color:#fff; font-size: 13px; display: flex; align-items: center; gap: 5px; }
    button:active { transform: scale(0.98); }
    
    .btn-export { background: #007aff; }
    .btn-finance { background: #34c759; }
    .btn-import { background: #5856d6; }
    .btn-logout { background: #ff3b30; }
    .btn-refresh { background: #eee; color: #333; margin-left: auto; }

    .table-box { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow-x: auto; min-height: 200px; }
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    th, td { padding: 14px 12px; text-align: left; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
    th { background: #fafafa; color: #555; font-weight: 600; white-space: nowrap; }
    tr:hover { background: #f9f9f9; }
    
    .remark-cell { color: #d70015; font-weight: 500; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .st-shipped { background: #e8f5e9; color: #2e7d32; }
    .st-pending { background: #fff3e0; color: #ef6c00; }
    
    #fileInput { display: none; }
    #loader { text-align: center; padding: 40px; color: #999; }
    
    footer { margin-top: 40px; text-align: center; font-size: 12px; color: #999; border-top: 1px solid #eee; padding-top: 20px; }
  </style>
</head>

<body>

<h2>
  <span>Pro Player æ€»æ§å° V7.3</span>
  <button class="btn-logout" onclick="logout()">å®‰å…¨é€€å‡º</button>
</h2>

<div class="dashboard">
  <div class="stat-card">
    <div class="stat-label">ä»Šæ—¥è®¢å• (Local)</div>
    <div class="stat-val" id="sOrders">0</div>
  </div>
  <div class="stat-card" style="border-left-color: #34c759;">
    <div class="stat-label">ä»Šæ—¥è¥æ”¶</div>
    <div class="stat-val" id="sMoney">Â¥0.00</div>
  </div>
  <div class="stat-card" style="border-left-color: #ff9500;">
    <div class="stat-label">å¾…å‘è´§ (æ€»ç§¯å‹)</div>
    <div class="stat-val" id="sPending">0</div>
  </div>
</div>

<div class="toolbar">
  <button class="btn-export" onclick="exportCainiao()">ğŸ“¤ å¯¼å‡ºèœé¸Ÿå‘è´§å• (V2)</button>
  <button class="btn-finance" onclick="exportFinance()">ğŸ’° å¯¼å‡ºå†…éƒ¨è´¢åŠ¡å•</button>
  
  <div style="width:1px; height:24px; background:#ddd; margin:0 5px;"></div>
  
  <button class="btn-import" onclick="document.getElementById('fileInput').click()">ğŸ“¥ å¯¼å…¥å‘è´§å›æ‰§</button>
  <input type="file" id="fileInput" accept=".xlsx" onchange="handleImport(this)">
  
  <button class="btn-refresh" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
</div>

<div id="loader">æ­£åœ¨è¿æ¥æ•°æ®åº“...</div>

<div class="table-box">
  <table id="dataTable" style="display:none;">
    <thead>
      <tr>
        <th>ç³»ç»Ÿç¼–å·</th>
        <th>ä¸‹å•æ—¶é—´</th>
        <th>é”€å”®å‘˜</th>
        <th>æ”¶ä»¶ä¿¡æ¯</th>
        <th>äº§å“è¯¦æƒ… (æ¦‚è§ˆ)</th>
        <th>A/Bæ˜ç»†</th>
        <th>æ€»æ•°</th>
        <th>æ€»ä»·</th>
        <th>çŠ¶æ€</th>
        <th>å¤‡æ³¨</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<footer>
  Pro Player Admin System V7.3 &copy; 2026<br>
  Powered by Mars-è€åˆ˜ & AI
</footer>

<script>
  let allOrders = [];
  const MY_ADMIN_EMAIL = "169351@qq.com"; 

  (async () => {
    const { data: { user } } = await window.sb.auth.getUser();
    if (!user) { alert("è¯·å…ˆåœ¨ Sales é¡µé¢ç™»å½•"); location.href = "sales.html"; return; }
    
    if (user.email.trim().toLowerCase() !== MY_ADMIN_EMAIL.trim().toLowerCase()) {
      alert("âš ï¸ æƒé™éªŒè¯å¤±è´¥ï¼šæ‚¨ä¸æ˜¯ç®¡ç†å‘˜ï¼");
      location.href = "sales.html";
      return;
    }
    loadData();
  })();

  async function loadData() {
    try {
      document.getElementById("loader").style.display = "block";
      document.getElementById("dataTable").style.display = "none";
      
      const { data, error } = await window.sb
        .from("orders")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) throw error;
      
      allOrders = data || [];

      if (allOrders.length === 0) {
        document.getElementById("tableBody").innerHTML = `<tr><td colspan="10" style="text-align:center; padding:30px; color:#999;">æš‚æ— æ•°æ®</td></tr>`;
      } else {
        renderTable(allOrders);
      }
      
      calcStats(allOrders);
      
      document.getElementById("loader").style.display = "none";
      document.getElementById("dataTable").style.display = "table";

    } catch (err) {
      document.getElementById("loader").innerHTML = `<span style="color:red">âŒ æ•°æ®åŠ è½½å¤±è´¥: ${err.message}</span><br><button onclick="location.reload()">é‡è¯•</button>`;
    }
  }

  function renderTable(data) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    
    data.forEach(row => {
      try {
        const tr = document.createElement("tr");
        const shortId = (row.id || "NULL").toString().substring(0, 8);
        const dateStr = row.created_at ? new Date(row.created_at).toLocaleString() : 'æœªçŸ¥æ—¶é—´';
        
        const isShipped = !!row.tracking_number;
        const statusHtml = isShipped
          ? `<span class="status-badge st-shipped">å·²å‘è´§<br><span style="font-weight:normal;font-size:10px">${row.tracking_number}</span></span>`
          : `<span class="status-badge st-pending">å¾…å‘è´§</span>`;

        const qtyA = Number(row.qty_a) || 0;
        const qtyB = Number(row.qty_b) || 0;
        const productDesc = `Aæ¬¾ç²—:${qtyA} / Bæ¬¾ç»†:${qtyB}`;

        tr.innerHTML = `
          <td style="font-family:monospace; color:#888;">${shortId}</td>
          <td>${dateStr}</td>
          <td>${(row.account||"").split('@')[0]}</td>
          <td>
            <strong>${row.customer_name || "æ— å"}</strong><br>
            <span style="color:#666;font-size:12px;">${row.phone || "-"}</span>
          </td>
          <td>ProPlayeré¼ æ ‡å«</td>
          <td style="font-size:12px; color:#666;">${productDesc}</td>
          <td style="font-weight:bold;">${row.total_qty || 0}</td>
          <td style="color:#007aff;">Â¥${row.total_price || 0}</td>
          <td>${statusHtml}</td>
          <td class="remark-cell" title="${row.remarks}">${row.remarks || '-'}</td>
        `;
        tbody.appendChild(tr);
      } catch (e) {
        console.error("è¡Œæ¸²æŸ“é”™è¯¯", e);
      }
    });
  }

  function calcStats(data) {
    const now = new Date();
    const localTodayStr = now.getFullYear() + "-" + 
      String(now.getMonth() + 1).padStart(2, '0') + "-" + 
      String(now.getDate()).padStart(2, '0');

    let todayCount = 0;
    let todayMoney = 0;
    let pendingCount = 0;

    data.forEach(o => {
      if (o.created_at && o.created_at.indexOf(localTodayStr) > -1) {
        todayCount++;
        todayMoney += (o.total_price || 0);
      }
      if (!o.tracking_number) pendingCount++;
    });

    document.getElementById("sOrders").innerText = todayCount;
    document.getElementById("sMoney").innerText = "Â¥" + todayMoney.toFixed(2);
    document.getElementById("sPending").innerText = pendingCount;
  }

  // å¯¼å‡º 1: èœé¸Ÿå‘è´§å•
  function exportCainiao() {
    if(!allOrders.length) return alert("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º");

    const header = [
      "ç¼–å·\nï¼ˆå•æ¬¡æœ€å¤š5000åŒ…è£¹ï¼‰", 
      "æ”¶ä»¶äººå§“å", 
      "æ”¶ä»¶äººè”ç³»æ–¹å¼", 
      "æ”¶ä»¶åœ°å€", 
      "ç‰©å“ç±»ï¼ˆåœ¨ä»¥ä¸‹6ç±»ä¸­é€‰æ‹©ï¼šæ—¥ç”¨å“ã€é£Ÿå“ã€æ–‡ä»¶ã€è¡£ç‰©ã€æ•°ç äº§å“ã€å…¶ä»–ï¼‰", 
      "ç‰©å“æ•°é‡",  
      "ç‰©å“è¯¦æƒ…", 
      "å¤‡æ³¨ä¿¡æ¯", 
      "å¤–å¹³å°å•å·(æŠ–éŸ³å¿…å¡«)\n",
      "ã€å›å¡«ã€‘è¿å•å· (ä¾›åº”é“¾å¡«è¿™é‡Œ)" 
    ];

    const wsData = [
      ["", "æ”¶ä»¶ä¿¡æ¯", "", "", "ç‰©å“ä¿¡æ¯", "", "", "å¤‡æ³¨", "å•å·", "å›å¡«åŒº"], // ç¬¬ä¸€è¡Œ
      header // ç¬¬äºŒè¡Œ
    ];

    allOrders.forEach(o => {
      const qa = Number(o.qty_a) || 0;
      const qb = Number(o.qty_b) || 0;
      let detailStr = "ProPlayeré¼ æ ‡å«";
      
      const parts = [];
      if(qa > 0) parts.push(`Aæ¬¾ç²—*${qa}`);
      if(qb > 0) parts.push(`Bæ¬¾ç»†*${qb}`);
      
      if(parts.length > 0) {
        detailStr += ` (${parts.join(", ")})`;
      }

      wsData.push([
        o.id,
        o.customer_name,
        o.phone,
        o.address,
        "æ—¥ç”¨å“",
        o.total_qty,
        detailStr,       
        o.remarks || "",
        "",
        ""               
      ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(wsData);

    ws['!cols'] = [
      {wch: 30}, {wch: 10}, {wch: 15}, {wch: 40}, {wch: 10}, 
      {wch: 8}, {wch: 35}, {wch: 20}, {wch: 15}, {wch: 25} 
    ];

    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = 0; R <= range.e.r; ++R) {
      for (let C = 0; C <= range.e.c; ++C) {
        const cellRef = XLSX.utils.encode_cell({r: R, c: C});
        if (!ws[cellRef]) continue;

        ws[cellRef].s = {
          border: { top: {style: "thin"}, bottom: {style: "thin"}, left: {style: "thin"}, right: {style: "thin"} },
          alignment: { vertical: "center", wrapText: true }
        };

        if (R < 2) {
          ws[cellRef].s.fill = { fgColor: { rgb: "CCFFCC" } };
          ws[cellRef].s.font = { bold: true };
        }

        if (R >= 2 && C === 7) ws[cellRef].s.font = { color: { rgb: "FF0000" }, bold: true };
        if (R >= 2 && C === 9) ws[cellRef].s.fill = { fgColor: { rgb: "FFFFCC" } };
      }
    }

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, `èœé¸Ÿå‘è´§å•_${new Date().toISOString().split('T')[0]}.xlsx`);
  }

  // å¯¼å‡º 2: è´¢åŠ¡ç‰ˆ
  function exportFinance() {
    if(!allOrders.length) return alert("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º");
    const wsData = [];
    wsData.push(["ä¸‹å•æ—¶é—´", "é”€å”®å‘˜", "å®¢æˆ·å§“å", "ç”µè¯", "æ”¶è´§åœ°å€", "Aæ¬¾ç²—(å¼ )", "Bæ¬¾ç»†(å¼ )", "æ€»æ•°é‡", "è¿è´¹", "è®¢å•æ€»é¢", "å½“å‰çŠ¶æ€", "å¤‡æ³¨ä¿¡æ¯", "è¿å•å·"]);
    allOrders.forEach(o => {
      wsData.push([
        new Date(o.created_at).toLocaleString(),
        o.account,
        o.customer_name,
        o.phone,
        o.address,
        o.qty_a,
        o.qty_b,
        o.total_qty,
        o.shipping,
        o.total_price,
        o.tracking_number ? "å·²å‘è´§" : "å¾…å‘è´§",
        o.remarks || "",
        o.tracking_number || ""
      ]);
    });
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "è´¢åŠ¡æ˜ç»†");
    XLSX.writeFile(wb, `é”€å”®è´¢åŠ¡è¡¨_${new Date().toISOString().split('T')[0]}.xlsx`);
  }

  // ===========================================
  // âœ… å¯¼å…¥ä¿®å¤æ ¸å¿ƒï¼šå¤„ç†åŒè¡Œè¡¨å¤´
  // ===========================================
  async function handleImport(input) {
    const file = input.files[0];
    if(!file) return;

    document.getElementById("loader").style.display = "block";
    document.getElementById("loader").innerText = "æ­£åœ¨è§£æå¯¼å…¥æ–‡ä»¶...";

    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        
        // å…³é”®ä¿®å¤ï¼šrange: 1 è¡¨ç¤ºè·³è¿‡ç¬¬1è¡Œï¼ˆIndex 0ï¼‰ï¼Œç›´æ¥ä»ç¬¬2è¡Œï¼ˆIndex 1ï¼‰å¼€å§‹è¯»è¡¨å¤´
        // è¿™æ · "ç¼–å·..." å’Œ "ã€å›å¡«ã€‘è¿å•å·..." æ‰èƒ½è¢«è¯†åˆ«ä¸º Key
        const json = XLSX.utils.sheet_to_json(sheet, { range: 1 });
        
        console.log("è§£æåˆ°çš„æ•°æ®:", json); // æ–¹ä¾¿F12è°ƒè¯•

        let count = 0;
        for(let row of json) {
          // æ¨¡ç³ŠåŒ¹é… Keyï¼Œé˜²æ­¢ Excel é‡Œçš„æ¢è¡Œç¬¦ \n å¯¼è‡´åŒ¹é…å¤±è´¥
          let orderId = null;
          let trackNo = null;

          // éå†æ‰€æœ‰ Key æ‰¾é‚£ä¸ªé•¿å¾—åƒ "ç¼–å·" å’Œ "è¿å•å·" çš„åˆ—
          for(let key in row) {
            if(key.includes("ç¼–å·")) orderId = row[key];
            if(key.includes("ã€å›å¡«ã€‘") || key.includes("è¿å•å·") || key.includes("å¿«é€’å•å·")) trackNo = row[key];
          }

          if(orderId && trackNo) {
            const { error } = await window.sb.from('orders')
              .update({ tracking_number: trackNo, status: 'shipped' })
              .eq('id', orderId); 
            
            if(!error) count++;
          }
        }
        
        alert(`âœ… å¯¼å…¥å®Œæˆï¼æˆåŠŸæ›´æ–°äº† ${count} æ¡å‘è´§çŠ¶æ€ã€‚`);
      } catch (err) {
        alert("âŒ å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼å¯èƒ½ä¸æ­£ç¡®ï¼š" + err.message);
      } finally {
        input.value = ""; 
        loadData(); // åˆ·æ–°ç•Œé¢
        document.getElementById("loader").innerText = "";
      }
    };
    reader.readAsArrayBuffer(file);
  }

  async function logout() {
    if(confirm("ç¡®å®šé€€å‡ºç®¡ç†åå°ï¼Ÿ")) {
      await window.sb.auth.signOut();
      location.href = "sales.html";
    }
  }
</script>

</body>
</html>