<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pro Player Â· ç®¡ç†åå° V5.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>

  <script>
    const SUPABASE_URL = "https://ztesoqtztyheezualipa.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_xCKbicWQaYM1knmkOqH-QA_3l5Xr96T";
    if (typeof supabase !== 'undefined') {
      window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
  </script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 1100px; margin: auto; background: #f5f7fa; }
    h2 { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
    
    .dashboard { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-card { flex: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .stat-val { font-size: 28px; font-weight: bold; margin-top: 5px; }

    .toolbar { background: #fff; padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    
    button { padding: 10px 18px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; color:#fff; }
    button:active { transform: scale(0.98); }
    .btn-export { background: #007aff; }
    .btn-finance { background: #34c759; }
    .btn-import { background: #5856d6; }
    .btn-logout { background: #ff3b30; }

    table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
    th { background: #f4f4f4; color: #555; }
    .remark-cell { color: #d70015; font-weight: 500; }
    .status-shipped { color: green; font-weight: bold; }
    .status-pending { color: orange; }

    #fileInput { display: none; }
  </style>
</head>

<body>

<div style="display:flex; justify-content:space-between; align-items:center;">
  <h2>Pro Player æ€»æ§å° V5.2</h2>
  <button class="btn-logout" onclick="logout()">å®‰å…¨é€€å‡º</button>
</div>

<div class="dashboard">
  <div class="stat-card">
    <div style="color:#888; font-size:12px;">ä»Šæ—¥è®¢å•</div>
    <div class="stat-val" id="sOrders">0</div>
  </div>
  <div class="stat-card">
    <div style="color:#888; font-size:12px;">ä»Šæ—¥è¥æ”¶</div>
    <div class="stat-val" id="sMoney">Â¥0.00</div>
  </div>
  <div class="stat-card">
    <div style="color:#888; font-size:12px;">å¾…å‘è´§</div>
    <div class="stat-val" id="sPending" style="color:orange">0</div>
  </div>
</div>

<div class="toolbar">
  <button class="btn-export" onclick="exportCainiao()">ğŸ“¤ å¯¼å‡ºèœé¸Ÿå‘è´§å• (V2)</button>
  <button class="btn-finance" onclick="exportFinance()">ğŸ’° å¯¼å‡ºå†…éƒ¨è´¢åŠ¡å•</button>
  <div style="width:1px; height:30px; background:#ddd; margin:0 10px;"></div>
  <button class="btn-import" onclick="document.getElementById('fileInput').click()">ğŸ“¥ å¯¼å…¥å‘è´§å›æ‰§ (å›å¡«å•å·)</button>
  <input type="file" id="fileInput" accept=".xlsx" onchange="handleImport(this)">
  <span id="importStatus" style="font-size:13px; color:#666;"></span>
  <button style="background:#eee; color:#333; margin-left:auto;" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
</div>

<div id="loader" style="text-align:center; padding:20px;">æ•°æ®åŠ è½½ä¸­...</div>

<table id="dataTable" style="display:none;">
  <thead>
    <tr>
      <th>è®¢å•å· (ç³»ç»ŸID)</th>
      <th>æ—¶é—´</th>
      <th>é”€å”®</th>
      <th>æ”¶ä»¶äºº</th>
      <th>äº§å“</th>
      <th>æ€»æ•°</th>
      <th>çŠ¶æ€</th>
      <th>å¤‡æ³¨</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
  let allOrders = [];
  
  // ==========================================
  // âœ… ç®¡ç†å‘˜é‚®ç®± (è¯·ç¡®ä¿å®Œå…¨ä¸€è‡´ï¼Œä¸å«ç©ºæ ¼)
  const MY_ADMIN_EMAIL = "169351@qq.com"; 
  // ==========================================

  (async () => {
    // 1. è·å–å½“å‰ç™»å½•ç”¨æˆ·
    const { data: { user } } = await window.sb.auth.getUser();

    // 2. å¢å¼ºç‰ˆæƒé™æ£€æŸ¥ (å¸¦è¯Šæ–­ä¿¡æ¯)
    if (!user) {
      alert("æœªç™»å½•ï¼Œè¯·å…ˆåœ¨ Sales é¡µé¢ç™»å½•ï¼");
      location.href = "sales.html";
      return;
    }

    // å°†ä¸¤è€…éƒ½è½¬ä¸ºå°å†™è¿›è¡Œå¯¹æ¯”ï¼Œé˜²æ­¢å¤§å°å†™é—®é¢˜
    const currentEmail = user.email.trim().toLowerCase();
    const adminEmail = MY_ADMIN_EMAIL.trim().toLowerCase();

    if (currentEmail !== adminEmail) {
      // âš ï¸ å…³é”®ä¿®æ”¹ï¼šæŠ¥é”™æ—¶æ˜¾ç¤ºå½“å‰è´¦å·ï¼Œæ–¹ä¾¿æ’æŸ¥
      alert(`â›”ï¸ æƒé™éªŒè¯å¤±è´¥ï¼\n\nç³»ç»Ÿè¦æ±‚ç®¡ç†å‘˜: ${adminEmail}\nå½“å‰ç™»å½•è´¦å·: ${currentEmail}\n\nè¯·é€€å‡ºå½“å‰è´¦å·ï¼Œä½¿ç”¨ç®¡ç†å‘˜è´¦å·é‡æ–°ç™»å½•ã€‚`);
      location.href = "sales.html";
      return;
    }

    // 3. éªŒè¯é€šè¿‡ï¼ŒåŠ è½½æ•°æ®
    loadData();
  })();

  async function loadData() {
    document.getElementById("loader").style.display = "block";
    const { data, error } = await window.sb.from("orders").select("*").order("created_at", { ascending: false });
    
    if(error) {
      // å¦‚æœæƒé™éªŒè¯é€šè¿‡äº†ï¼Œä½†æ•°æ®è¯»å–å¤±è´¥ï¼Œé€šå¸¸æ˜¯ SQL çš„ RLS æ²¡è·‘
      alert("âš ï¸ æ•°æ®åŠ è½½å¤±è´¥ï¼š" + error.message + "\n\nè¯·ç¡®è®¤æ˜¯å¦å·²è¿è¡Œ V5.1 çš„ SQL ä¿®å¤è„šæœ¬ï¼");
      return;
    }
    
    allOrders = data;
    renderTable(data);
    calcStats(data);
    document.getElementById("loader").style.display = "none";
    document.getElementById("dataTable").style.display = "table";
  }

  function renderTable(data) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    data.forEach(row => {
      const tr = document.createElement("tr");
      const shortId = row.id.split('-')[0];
      const statusHtml = row.tracking_number 
        ? `<span class="status-shipped">å·²å‘è´§<br><small>${row.tracking_number}</small></span>` 
        : `<span class="status-pending">å¾…å‘è´§</span>`;

      tr.innerHTML = `
        <td style="font-family:monospace; color:#666;">...${shortId}</td>
        <td>${new Date(row.created_at).toLocaleString()}</td>
        <td>${row.account}</td>
        <td>${row.customer_name}<br><small>${row.phone}</small></td>
        <td>${row.product}</td>
        <td style="font-weight:bold">${row.total_qty}</td>
        <td>${statusHtml}</td>
        <td class="remark-cell">${row.remarks || ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function calcStats(data) {
    const today = new Date().toISOString().split('T')[0];
    const todays = data.filter(o => o.created_at.startsWith(today));
    document.getElementById("sOrders").innerText = todays.length;
    document.getElementById("sMoney").innerText = "Â¥" + todays.reduce((a,b)=>a+(b.total_price||0),0).toFixed(2);
    document.getElementById("sPending").innerText = data.filter(o => !o.tracking_number).length;
  }

  // === V5.0 æ ¸å¿ƒå¯¼å‡º (èœé¸Ÿæ¨¡æ¿) ===
  function exportCainiao() {
    if(!allOrders.length) return;
    
    const wsData = [[
      "è®¢å•å·", "ä¹°å®¶ä¼šå‘˜å", "æ”¶ä»¶äººå§“å", "æ”¶ä»¶äººæ‰‹æœº", "æ”¶ä»¶äººç”µè¯", 
      "æ”¶ä»¶äººçœ", "æ”¶ä»¶äººå¸‚", "æ”¶ä»¶äººåŒº", "æ”¶ä»¶äººè¯¦ç»†åœ°å€", 
      "ç‰©å“åˆ†ç±»", "ç‰©å“åç§°", "ç‰©å“æ•°é‡", "ä¹°å®¶å¤‡æ³¨"
    ]];

    allOrders.forEach(o => {
      wsData.push([
        o.id, "", o.customer_name, o.phone, "", 
        "", "", "", o.address, 
        "æ—¥ç”¨å“", o.product, o.total_qty, o.remarks || ""
      ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const range = XLSX.utils.decode_range(ws['!ref']);
    for(let R=1; R<=range.e.r; ++R) {
      const cell = XLSX.utils.encode_cell({r:R, c:12}); 
      if(ws[cell]) ws[cell].s = { font: { color: { rgb: "FF0000" }, bold: true } };
    }

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, `èœé¸Ÿå‘è´§å•_${new Date().toISOString().split('T')[0]}.xlsx`);
  }

  function exportFinance() {
    const ws = XLSX.utils.json_to_sheet(allOrders);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "è´¢åŠ¡æ˜ç»†");
    XLSX.writeFile(wb, `è´¢åŠ¡å¯¹è´¦å•.xlsx`);
  }

  // === V5.0 å¯¼å…¥å›å¡« ===
  async function handleImport(input) {
    const file = input.files[0];
    if(!file) return;

    document.getElementById("importStatus").innerText = "æ­£åœ¨è§£æ...";
    
    const reader = new FileReader();
    reader.onload = async (e) => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet);
      
      let count = 0;
      for(let row of json) {
        const orderId = row['è®¢å•å·'] || row['Order ID'];
        const trackNo = row['è¿å•å·'] || row['å¿«é€’å•å·'] || row['Tracking Number'];
        
        if(orderId && trackNo) {
          const { error } = await window.sb.from('orders')
            .update({ tracking_number: trackNo, status: 'shipped' })
            .eq('id', orderId); 
          
          if(!error) count++;
        }
      }
      alert(`âœ… å¯¼å…¥å®Œæˆï¼æˆåŠŸæ›´æ–°äº† ${count} æ¡å‘è´§çŠ¶æ€ã€‚`);
      input.value = ""; 
      loadData(); 
    };
    reader.readAsArrayBuffer(file);
  }

  async function logout() {
    await window.sb.auth.signOut();
    location.href = "sales.html";
  }
</script>
</body>
</html>