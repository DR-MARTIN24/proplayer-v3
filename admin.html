<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pro Player Â· Xå…‰é€è§†ä»ª (Debug)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { background: #000; color: #0f0; font-family: "Courier New", monospace; padding: 20px; font-size: 14px; word-wrap: break-word; }
    h1 { border-bottom: 1px solid #0f0; padding-bottom: 10px; }
    .btn { background: #333; color: #fff; border: 1px solid #fff; padding: 10px 20px; margin: 10px 0; font-size: 16px; cursor: pointer; }
    #console { white-space: pre-wrap; margin-top: 20px; }
    .error { color: #f00; font-weight: bold; }
    .warn { color: #ff0; }
  </style>
</head>
<body>

<h1>ğŸ•µï¸â€â™‚ï¸ æ•°æ®åº“ X å…‰é€è§†ä»ª</h1>
<p>æ­¤é¡µé¢ç”¨äºå¼ºåˆ¶è¯»å–æ•°æ®åº“å†…å®¹ï¼Œå¿½ç•¥æ‰€æœ‰ UI é€»è¾‘ã€‚</p>

<div>
  <button class="btn" onclick="forceFetch()">ğŸš€ å¼ºåˆ¶è¯»å–æ•°æ®</button>
  <button class="btn" onclick="checkUser()">ğŸ‘¤ æ£€æŸ¥æˆ‘çš„èº«ä»½</button>
  <button class="btn" onclick="location.href='sales.html'">ğŸ”™ è¿”å› Sales</button>
</div>

<div id="console">å‡†å¤‡å°±ç»ªï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®...</div>

<script>
  // ============================================
  // 1. è¯·åŠ¡å¿…æ ¸å¯¹è¿™è¡Œåœ°å€ï¼Œå¿…é¡»å’Œ sales.html é‡Œçš„ä¸€æ¨¡ä¸€æ ·ï¼
  // å“ªæ€•å°‘ä¸€ä¸ªå­—æ¯éƒ½ä¸è¡Œ
  const SUPABASE_URL = "https://ztesoqtztyheezualipa.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_xCKbicWQaYM1knmkOqH-QA_3l5Xr96T"; 
  // ============================================

  const logEl = document.getElementById("console");
  function log(msg, type = "info") {
    const color = type === 'error' ? '#f00' : (type === 'warn' ? '#ff0' : '#0f0');
    logEl.innerHTML += `<div style="color:${color}; margin-bottom:5px;">> ${msg}</div>`;
  }

  // åˆå§‹åŒ–
  let sb;
  try {
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    log(`å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ\nURL: ${SUPABASE_URL}`);
  } catch (e) {
    log(`âŒ å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: ${e.message}`, "error");
  }

  async function checkUser() {
    log("æ­£åœ¨æ£€æŸ¥ç™»å½•çŠ¶æ€...");
    const { data: { session }, error } = await sb.auth.getSession();
    if (error) return log(`âŒ ä¼šè¯é”™è¯¯: ${error.message}`, "error");
    
    if (session) {
      log(`âœ… å½“å‰ç”¨æˆ·: ${session.user.email}`);
      log(`   ç”¨æˆ·ID: ${session.user.id}`);
      log(`   ä¸Šæ¬¡ç™»å½•: ${new Date(session.user.last_sign_in_at).toLocaleString()}`);
    } else {
      log("âš ï¸ æœªæ£€æµ‹åˆ°ç™»å½•ç”¨æˆ·ï¼è¯·å…ˆå» sales.html ç™»å½•ã€‚", "warn");
    }
  }

  async function forceFetch() {
    log("--------------------------------");
    log("â³ å¼€å§‹å¼ºåˆ¶è¯»å– 'orders' è¡¨...");

    // 1. å°è¯•è¯»å– count (æ€»æ•°)
    const { count, error: countError } = await sb
      .from("orders")
      .select("*", { count: "exact", head: true });
    
    if (countError) {
      log(`âŒ è¿æ¥æ•°æ®åº“å¤±è´¥!`, "error");
      log(`   Code: ${countError.code}`);
      log(`   Message: ${countError.message}`);
      log(`   Hint: ${countError.hint || 'æ— æç¤º'}`);
      return;
    }

    log(`ğŸ“Š æ•°æ®åº“å“åº”æ­£å¸¸ã€‚`);
    log(`ğŸ”¢ è¡¨ä¸­æ€»è¡Œæ•°: ${count}`);

    if (count === 0) {
      log("âš ï¸ è­¦å‘Šï¼šæ•°æ®åº“è¿æ¥æˆåŠŸï¼Œä½†è¿”å›è¡Œæ•°ä¸º 0ã€‚", "warn");
      log("   å¯èƒ½åŸå› ï¼š");
      log("   1. è¡¨é‡ŒçœŸçš„æ²¡æ•°æ® (è¯·å»åå°ç¡®è®¤)");
      log("   2. RLS ä¾ç„¶åœ¨æ‹¦æˆª (è™½ç„¶ä½ è¯´å…³äº†)");
      log("   3. ä½ è¿æ¥äº†é”™è¯¯çš„ Project (URLä¸å¯¹)");
      return;
    }

    // 2. å°è¯•è¯»å–å®é™…æ•°æ®
    const { data, error } = await sb
      .from("orders")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(3);

    if (error) {
      log(`âŒ è¯»å–æ•°æ®è¡Œå¤±è´¥: ${error.message}`, "error");
    } else {
      log(`âœ… æˆåŠŸè¯»å–åˆ° ${data.length} æ¡æ•°æ®ï¼`);
      log("ğŸ“ ç¬¬ä¸€æ¡æ•°æ®å†…å®¹:");
      log(JSON.stringify(data[0], null, 2)); // æ‰“å°æ•°æ®è¯¦æƒ…
    }
  }
</script>
</body>
</html>