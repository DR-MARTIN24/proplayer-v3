<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Pro Player Â· ç³»ç»Ÿè¯Šæ–­æ¨¡å¼ V6.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: monospace; padding: 20px; background: #222; color: #0f0; }
    h2 { border-bottom: 1px solid #444; padding-bottom: 10px; color: #fff; }
    .log-box { background: #000; padding: 15px; border: 1px solid #444; border-radius: 5px; margin-bottom: 15px; white-space: pre-wrap; word-break: break-all; }
    .error { color: #ff3333; font-weight: bold; }
    .success { color: #33ff33; font-weight: bold; }
    .btn { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #333; color: #fff; border: 1px solid #666; }
  </style>
</head>
<body>

<h2>ğŸ•µï¸ Pro Player ç³»ç»Ÿè¯Šæ–­æ§åˆ¶å° (Debug Mode)</h2>
<p style="color:#aaa">è¯·æˆªå›¾æ­¤é¡µé¢å‘ç»™æˆ‘ï¼Œæˆ–è€…å‘Šè¯‰æˆ‘çº¢è‰²çš„æŠ¥é”™ä¿¡æ¯ã€‚</p>

<div id="status" class="log-box">æ­£åœ¨åˆå§‹åŒ–...</div>

<button class="btn" onclick="runDiagnosis()">ğŸ”„ é‡æ–°è¿è¡Œè¯Šæ–­</button>
<button class="btn" onclick="location.href='sales.html'">â¬…ï¸ è¿”å› Sales</button>

<script>
  // ==========================================
  // 1. è¯·å†æ¬¡ç¡®è®¤è¿™é‡Œçš„é…ç½®å’Œ sales.html é‡Œçš„ä¸€æ¨¡ä¸€æ ·ï¼
  const SUPABASE_URL = "https://ztesoqtztyheezualipa.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_xCKbicWQaYM1knmkOqH-QA_3l5Xr96T"; 
  // ==========================================

  const logEl = document.getElementById("status");
  function log(msg, type = "normal") {
    const color = type === "error" ? "#ff3333" : (type === "success" ? "#33ff33" : "#0f0");
    const time = new Date().toLocaleTimeString();
    logEl.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
  }

  async function runDiagnosis() {
    logEl.innerHTML = "--- å¼€å§‹è¯Šæ–­ ---\n";
    
    // 1. æ£€æŸ¥ Supabase å®¢æˆ·ç«¯
    if (typeof supabase === 'undefined') {
      log("âŒ ä¸¥é‡é”™è¯¯: Supabase åº“æœªåŠ è½½ï¼å¯èƒ½æ˜¯ç½‘ç»œæ‹¦æˆªäº† js æ–‡ä»¶ã€‚", "error");
      return;
    }
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    log("âœ… Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–");

    // 2. æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
    const { data: { session }, error: authError } = await sb.auth.getSession();
    if (authError) {
      log(`âŒ è·å–ä¼šè¯å¤±è´¥: ${authError.message}`, "error");
    } else if (!session) {
      log("âš ï¸ä»¥æ­¤æµè§ˆå™¨æœªç™»å½•ç”¨æˆ·ã€‚è¯·å…ˆå» sales.html ç™»å½•ã€‚", "error");
      log("æç¤ºï¼šè™½ç„¶æœªç™»å½•ï¼Œæˆ‘ä»å°è¯•è¯»å–æ•°æ®ï¼ˆå¦‚æœ RLS å·²å…³é—­åº”è¯¥èƒ½è¯»åˆ°ï¼‰...");
    } else {
      log(`âœ… å½“å‰ç™»å½•ç”¨æˆ·: ${session.user.email}`, "success");
    }

    // 3. å°è¯•è¯»å– orders è¡¨ (è¿™æ˜¯å…³é”®ï¼)
    log("â³ æ­£åœ¨å°è¯•è¯»å– orders è¡¨çš„å‰ 5 æ¡æ•°æ®...");
    
    const { data, error, count } = await sb
      .from("orders") // ç¡®ä¿è¿™é‡Œå…¨æ˜¯å°å†™
      .select("*", { count: "exact" })
      .limit(5);

    if (error) {
      log(`âŒ è¯»å–å¤±è´¥ (å…³é”®æŠ¥é”™):`, "error");
      log(`Code: ${error.code}`);
      log(`Message: ${error.message}`);
      log(`Details: ${error.details || "æ— "}`);
      log(`Hint: ${error.hint || "æ— "}`);
    } else {
      log(`âœ… è¯»å–æˆåŠŸï¼çŠ¶æ€ç : 200 OK`, "success");
      log(`ğŸ“Š æ•°æ®åº“è¿”å›äº† ${data.length} æ¡æ•°æ®ã€‚`);
      if (data.length === 0) {
        log("â“ è­¦å‘Š: è¿”å›çš„æ•°æ®æ˜¯ç©ºçš„ ([])ã€‚", "error");
        log("å¯èƒ½æœ‰ä»¥ä¸‹åŸå› ï¼š");
        log("1. æ•°æ®åº“é‡ŒçœŸçš„æ²¡æ•°æ® (è¯·å» Supabase åå°ç¡®è®¤ orders è¡¨æ˜¯å¦æœ‰è¡Œ)");
        log("2. RLS ä¾ç„¶å¼€å¯ä¸”è§„åˆ™å¤ªä¸¥ï¼Œå¯¼è‡´è¢«æ‹¦æˆª (è™½ç„¶ä½ è¯´å…³äº†)");
        log("3. è¡¨åå¤§å°å†™ä¸å¯¹ (æ¯”å¦‚ä½ å»ºè¡¨å« 'Orders' è€Œä¸æ˜¯ 'orders')");
      } else {
        log("ğŸ‰ æ•°æ®å†…å®¹é¢„è§ˆ (ç¬¬ä¸€æ¡):");
        log(JSON.stringify(data[0], null, 2));
      }
    }
  }

  // è‡ªåŠ¨è¿è¡Œ
  runDiagnosis();
</script>

</body>
</html>